---
phase: 11-plex-tautulli-integration
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/media/tautulli/tautulli.http.ts
  - src/media/tautulli/tautulli.schemas.ts
  - src/media/tautulli/tautulli.types.ts
  - src/media/tautulli/tautulli.client.ts
  - src/plugins/tautulli.ts
  - src/conversation/tools/get-watch-history.ts
  - src/conversation/tools/index.ts
  - src/conversation/types.ts
  - src/conversation/engine.ts
  - src/plugins/webhook.ts
  - src/plugins/conversation.ts
  - src/server.ts
  - src/conversation/system-prompt.ts
autonomous: true
user_setup:
  - service: tautulli
    why: "Watch history and viewing analytics"
    env_vars:
      - name: TAUTULLI_URL
        source: "Your Tautulli URL (e.g., http://192.168.1.100:8181)"
      - name: TAUTULLI_API_KEY
        source: "Tautulli Settings -> Web Interface -> API key"

must_haves:
  truths:
    - "User can ask 'what have I been watching' and get their recent watch history from Tautulli"
    - "Watch history shows title, media type, when watched, duration, and who watched it"
    - "Watch history currently shows global Plex activity (per-user filtering deferred to Phase 12 user linking)"
    - "App starts gracefully when TAUTULLI_URL/TAUTULLI_API_KEY are not set (Tautulli features unavailable)"
  artifacts:
    - path: "src/media/tautulli/tautulli.http.ts"
      provides: "Tautulli-specific HTTP helper handling apikey query param auth, cmd parameter, and response.result wrapper validation"
      exports: ["tautulliRequest"]
    - path: "src/media/tautulli/tautulli.schemas.ts"
      provides: "Zod schemas for Tautulli API responses (history items, users, watch time stats)"
      exports: ["TautulliHistoryDataSchema", "TautulliUserSchema", "TautulliWatchTimeStatSchema"]
    - path: "src/media/tautulli/tautulli.client.ts"
      provides: "TautulliClient class with getHistory, getUsers, getUserWatchTimeStats, healthCheck"
      exports: ["TautulliClient"]
    - path: "src/plugins/tautulli.ts"
      provides: "Fastify plugin creating TautulliClient with graceful degradation"
    - path: "src/conversation/tools/get-watch-history.ts"
      provides: "get_watch_history LLM tool for querying recent watch activity"
      exports: ["getWatchHistoryTool"]
  key_links:
    - from: "src/conversation/tools/get-watch-history.ts"
      to: "src/media/tautulli/tautulli.client.ts"
      via: "context.tautulli in ToolContext"
      pattern: "context\\.tautulli"
    - from: "src/plugins/webhook.ts"
      to: "src/media/tautulli/tautulli.client.ts"
      via: "fastify.tautulli passed into processConversation"
      pattern: "tautulli: fastify\\.tautulli"
    - from: "src/plugins/tautulli.ts"
      to: "src/media/tautulli/tautulli.client.ts"
      via: "creates client, decorates fastify.tautulli"
      pattern: "fastify\\.decorate.*tautulli"
---

<objective>
Build the Tautulli API client and get_watch_history LLM tool, fully wired into the Fastify server.

Purpose: Users can ask about their recent watch history and get viewing activity data from Tautulli. Phase 11 uses global history; per-user filtering is deferred to Phase 12 when user linking is implemented.

Output: TautulliClient class, Fastify plugin with graceful degradation, get_watch_history tool registered in conversation engine, all wiring complete.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-plex-tautulli-integration/11-RESEARCH.md
@.planning/phases/11-plex-tautulli-integration/11-01-SUMMARY.md

# Existing patterns to follow exactly
@src/media/tmdb/tmdb.http.ts
@src/media/plex/plex.http.ts
@src/plugins/brave.ts
@src/conversation/tools/discover-media.ts
@src/conversation/tools.ts
@src/media/errors.ts

# Files to modify (read current state -- these were modified by Plan 11-01)
@src/conversation/types.ts
@src/conversation/engine.ts
@src/plugins/webhook.ts
@src/plugins/conversation.ts
@src/conversation/tools/index.ts
@src/server.ts
@src/conversation/system-prompt.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Tautulli HTTP helper, Zod schemas, types, and TautulliClient class</name>
  <files>
    src/media/tautulli/tautulli.http.ts
    src/media/tautulli/tautulli.schemas.ts
    src/media/tautulli/tautulli.types.ts
    src/media/tautulli/tautulli.client.ts
  </files>
  <action>
Create four files in `src/media/tautulli/` following patterns from `src/media/plex/` and `src/media/tmdb/`.

**tautulli.http.ts** -- Tautulli-specific HTTP helper:
- Export `TautulliRequestOptions` interface: `{ baseUrl: string, apiKey: string, cmd: string, params?: Record<string, string | number | boolean>, timeoutMs?: number }`
- Define internal `TautulliResponseWrapper` Zod schema (NOT exported): `z.object({ response: z.object({ result: z.string(), message: z.string().nullable().optional(), data: z.unknown() }) })`
- Export `tautulliRequest<T>(options, schema: z.ZodType<T>): Promise<T>`
- Build URL as `new URL("/api/v2", baseUrl)`, set `apikey` and `cmd` as query params, then any additional `params`
- Fetch with `GET`, `Accept: application/json` header, `AbortSignal.timeout(timeoutMs)` (default 10000ms)
- Error handling: `TypeError` -> ConnectionError, `DOMException` timeout -> ConnectionError
- CRITICAL: Tautulli ALWAYS returns HTTP 200 even on errors. After checking `response.ok` (for proxy/network issues):
  1. Parse JSON and validate against `TautulliResponseWrapper` -- throw `ValidationError` if wrapper fails
  2. Check `wrapper.data.response.result !== "success"` -- throw `MediaServerError(200, "Tautulli command '{cmd}' failed: {message}")` if not success
  3. Validate `wrapper.data.response.data` against the provided `schema` -- throw `ValidationError` if data fails
  4. Return the validated data
- Import error classes from `../errors.js`

**tautulli.schemas.ts** -- Zod schemas for Tautulli responses:
- `TautulliHistoryItemSchema`: `z.object({ date: z.number(), duration: z.number(), friendly_name: z.string(), full_title: z.string(), grandparent_rating_key: z.number().optional(), media_type: z.string(), platform: z.string(), player: z.string(), rating_key: z.number(), started: z.number(), stopped: z.number(), title: z.string(), user: z.string().optional(), user_id: z.number().optional(), watched_status: z.number().optional(), percent_complete: z.number().optional(), transcode_decision: z.string().optional(), ip_address: z.string().optional() }).passthrough()`
- `TautulliHistoryDataSchema`: `z.object({ recordsFiltered: z.number(), recordsTotal: z.number(), data: z.array(TautulliHistoryItemSchema), draw: z.number().optional(), filter_duration: z.string().optional(), total_duration: z.string().optional() })`
- `TautulliUserSchema`: `z.object({ user_id: z.number(), username: z.string(), friendly_name: z.string(), email: z.string().optional(), is_active: z.number(), is_admin: z.number().optional(), thumb: z.string().optional(), shared_libraries: z.string().optional() }).passthrough()`
- `TautulliWatchTimeStatSchema`: `z.object({ query_days: z.number(), total_plays: z.number(), total_time: z.number() })`

**tautulli.types.ts** -- TypeScript types inferred from schemas:
- `TautulliHistoryItem = z.infer<typeof TautulliHistoryItemSchema>`
- `TautulliHistoryData = z.infer<typeof TautulliHistoryDataSchema>`
- `TautulliUser = z.infer<typeof TautulliUserSchema>`
- `TautulliWatchTimeStat = z.infer<typeof TautulliWatchTimeStatSchema>`
- Export all types

**tautulli.client.ts** -- TautulliClient class:
- Constructor takes `(baseUrl: string, apiKey: string)`, stores as private readonly
- Public `async getHistory(opts?: { userId?: number, mediaType?: "movie" | "episode", length?: number, startDate?: string }): Promise<TautulliHistoryData>`:
  - Build params: map `userId` -> `user_id`, `mediaType` -> `media_type`, `length` -> `length`, `startDate` -> `start_date` (only set if provided)
  - Call `tautulliRequest({ baseUrl, apiKey, cmd: "get_history", params }, TautulliHistoryDataSchema)`
- Public `async getUsers(): Promise<TautulliUser[]>`:
  - Call `tautulliRequest({ baseUrl, apiKey, cmd: "get_users" }, z.array(TautulliUserSchema))`
- Public `async getUserWatchTimeStats(userId: number): Promise<TautulliWatchTimeStat[]>`:
  - Call with `cmd: "get_user_watch_time_stats"`, `params: { user_id: userId, query_days: "7,30,0" }`
  - Validate against `z.array(TautulliWatchTimeStatSchema)`
- Public `async healthCheck(): Promise<boolean>`: try calling `tautulliRequest` with `cmd: "arnold"` (Tautulli easter egg -- always returns successfully if API key is valid), return true/false
  </action>
  <verify>
Run `npx tsc --noEmit` -- all 4 new files compile without errors.
Run `npx biome check src/media/tautulli/` -- no lint or format errors.
Verify all 4 files exist on disk.
  </verify>
  <done>
TautulliClient class compiles with getHistory, getUsers, getUserWatchTimeStats, healthCheck methods. Tautulli HTTP helper handles apikey auth, cmd-based API, response.result wrapper validation, and error classification. All Zod schemas validate Tautulli response shapes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Tautulli Fastify plugin, get_watch_history tool, and server wiring</name>
  <files>
    src/plugins/tautulli.ts
    src/conversation/tools/get-watch-history.ts
    src/conversation/types.ts
    src/conversation/engine.ts
    src/plugins/webhook.ts
    src/plugins/conversation.ts
    src/conversation/tools/index.ts
    src/server.ts
    src/conversation/system-prompt.ts
  </files>
  <action>
**src/plugins/tautulli.ts** -- Fastify plugin (follow brave.ts pattern -- simple, no cache):
- Declare module augmentation: `FastifyInstance.tautulli?: TautulliClient`
- Use `fp()` wrapper with `{ name: "tautulli", dependencies: ["database"] }`
- Read `TAUTULLI_URL` and `TAUTULLI_API_KEY` from `fastify.config`
- If either is missing, log warning "Tautulli not configured (set TAUTULLI_URL and TAUTULLI_API_KEY), watch history unavailable" and return early
- Create `new TautulliClient(TAUTULLI_URL, TAUTULLI_API_KEY)`
- Run health check: `const healthy = await client.healthCheck()`. If unhealthy, log error but still decorate (matches sonarr/radarr degraded mode pattern)
- Decorate: `fastify.decorate("tautulli", client)`
- Log info: "Tautulli configured" (or "Tautulli configured (health check failed, API may be unreachable)" if unhealthy)

**src/conversation/tools/get-watch-history.ts** -- LLM tool (follow discover-media.ts pattern):
- Import `defineTool` from `../tools.js`, `z` from `zod`
- Export `getWatchHistoryTool = defineTool("get_watch_history", description, schema, "safe", executor)`
- Description: "Get recent watch history from Tautulli/Plex. Shows what has been watched recently, including title, date, and duration. Use when the user asks 'what have I been watching', 'what did I watch recently', or 'my watch history'."
- Schema: `z.object({ mediaType: z.enum(["movie", "episode"]).optional().describe("Filter by media type: movie or episode (TV). Omit for all types."), limit: z.number().min(1).max(25).optional().describe("Number of recent items to return (default 10, max 25)") })`
- Executor:
  1. If `!context.tautulli`, return `{ error: "Tautulli is not configured" }`
  2. Call `context.tautulli.getHistory({ mediaType: args.mediaType, length: args.limit ?? 10 })` -- Phase 11 uses global history (no userId filter)
  3. If no data or empty: return `{ results: [], message: "No recent watch history found" }`
  4. Map results: `{ title: entry.full_title, mediaType: entry.media_type, watchedDate: entry.date, duration: entry.duration, user: entry.friendly_name, platform: entry.platform, player: entry.player, percentComplete: entry.percent_complete }`
  5. Return `{ results }`

**src/conversation/types.ts** -- Verify `tautulli?` is in ToolContext. If Plan 11-01 used `any` as a placeholder, update it now to the proper import: `tautulli?: import("../media/tautulli/tautulli.client.js").TautulliClient;`

**src/conversation/engine.ts** -- Add tautulli wiring (Plan 11-01 added plex; now add tautulli):
- Add import: `import type { TautulliClient } from "../media/tautulli/tautulli.client.js";`
- Add `tautulli?: TautulliClient` to `ProcessConversationParams` interface
- Destructure `tautulli` from params
- Add `tautulli` to BOTH ToolContext objects (confirmed tool execution context AND tool call loop context)

**src/plugins/webhook.ts** -- Add `tautulli: fastify.tautulli` to the `processConversation()` call (after the `plex: fastify.plex` line added by Plan 11-01).

**src/plugins/conversation.ts** -- Import `getWatchHistoryTool` from tools/index.ts and register it: `registry.register(getWatchHistoryTool)`.

**src/conversation/tools/index.ts** -- Add export: `export { getWatchHistoryTool } from "./get-watch-history.js";`

**src/server.ts** -- Import and register the Tautulli plugin. Add `import tautulliPlugin from "./plugins/tautulli.js";` and `await fastify.register(tautulliPlugin);` after plexPlugin registration (before conversationPlugin).

**src/conversation/system-prompt.ts** -- Add a new section to SYSTEM_PROMPT after the "Plex library:" section (added by Plan 11-01) and before "Permissions:":
```
Watch history:
- Use get_watch_history when the user asks what they've been watching, their recent viewing, or wants to know recent activity.
- Watch history currently shows global Plex activity across all users (per-user filtering will be available after Plex user linking).
- Keep watch history responses concise -- list the most recent items with title and when watched.
- You can filter by media type (movie or episode) if the user specifies.
```
  </action>
  <verify>
Run `npx tsc --noEmit` -- entire project compiles without errors.
Run `npx biome check src/` -- no lint or format errors across the project.
Verify `get_watch_history` appears in the tool registry by checking the import chain: tools/index.ts exports it, conversation.ts imports and registers it.
Verify `tautulli` appears in ToolContext in types.ts (as proper import, not `any`).
Verify `tautulli` is destructured and passed in engine.ts.
Verify `tautulli: fastify.tautulli` is passed in webhook.ts processConversation call.
Verify tautulliPlugin is registered in server.ts.
Verify total tool count is 14 (check_status + 11 original + check_plex_library + get_watch_history).
  </verify>
  <done>
Tautulli Fastify plugin registers TautulliClient with graceful degradation. get_watch_history tool is registered in conversation engine and accessible via ToolContext. All wiring complete: ToolContext updated, engine params threaded, webhook passes tautulli client, server registers plugin, system prompt includes watch history guidance. Total tool count is 14, under the 15 limit. App compiles and starts gracefully with or without TAUTULLI_URL/TAUTULLI_API_KEY.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes -- all new and modified files compile
2. `npx biome check src/` passes -- no lint/format issues
3. Files created: tautulli.http.ts, tautulli.schemas.ts, tautulli.types.ts, tautulli.client.ts, plugins/tautulli.ts, tools/get-watch-history.ts
4. Files modified: types.ts (tautulli import fixed), engine.ts (tautulli in params and context), webhook.ts (tautulli passthrough), conversation.ts (register tool), tools/index.ts (export tool), server.ts (register plugin), system-prompt.ts (watch history guidance)
5. Tool count: was 13 (after Plan 11-01), now 14 (+ get_watch_history) -- under 15 limit
6. Both Plex and Tautulli integrations start gracefully when env vars are not set
</verification>

<success_criteria>
- TautulliClient class with getHistory, getUsers, healthCheck methods
- get_watch_history LLM tool registered and accessible to conversation engine
- Tautulli Fastify plugin with graceful degradation
- All server wiring complete (ToolContext, engine, webhook, plugin registration)
- Project compiles cleanly with `npx tsc --noEmit`
- Total tool count is 14, under the 15-tool limit
</success_criteria>

<output>
After completion, create `.planning/phases/11-plex-tautulli-integration/11-02-SUMMARY.md`
</output>
