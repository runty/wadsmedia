---
phase: 17-admin-dashboard-ux-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - admin-views/partials/user-row.eta
  - admin-views/pages/user-detail.eta
  - src/admin/admin.routes.ts
  - admin-assets/style.css
autonomous: true

must_haves:
  truths:
    - "User detail page is accessible via a clearly labeled link in the user list (not hidden behind 'View Chat')"
    - "Plex linking section is always visible on the user detail page regardless of Tautulli availability"
    - "When Tautulli is unavailable, the Plex section shows an explicit error explaining why linking is unavailable"
    - "When Tautulli is not configured at all, the Plex section shows a 'not configured' message with guidance"
    - "When Tautulli is available, Plex linking dropdown works exactly as before"
  artifacts:
    - path: "admin-views/partials/user-row.eta"
      provides: "User list row with 'View Details' link instead of 'View Chat'"
      contains: "View Details"
    - path: "admin-views/pages/user-detail.eta"
      provides: "User detail page with three-state Plex section"
      contains: "tautulliStatus"
    - path: "src/admin/admin.routes.ts"
      provides: "Route passing tautulliStatus to template"
      contains: "tautulliStatus"
  key_links:
    - from: "src/admin/admin.routes.ts"
      to: "admin-views/pages/user-detail.eta"
      via: "tautulliStatus template variable"
      pattern: "tautulliStatus"
    - from: "admin-views/pages/user-detail.eta"
      to: "Plex section rendering"
      via: "conditional branching on tautulliStatus value"
      pattern: "tautulliStatus.*===.*available"
---

<objective>
Improve admin dashboard UX by making the user detail link clearly labeled and ensuring the Plex linking section is always visible with explicit status messages when Tautulli is unavailable.

Purpose: The current UI hides the user detail link behind a misleading "View Chat" label (the page shows much more than chat), and silently hides the entire Plex linking section when Tautulli is down -- leaving admins confused about why they cannot link users.

Output: Updated user-row partial, user-detail template with three-state Plex section, and route handler passing Tautulli status to the template.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@admin-views/partials/user-row.eta
@admin-views/pages/user-detail.eta
@src/admin/admin.routes.ts
@admin-assets/style.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update route to pass Tautulli status and rename user detail link</name>
  <files>src/admin/admin.routes.ts, admin-views/partials/user-row.eta</files>
  <action>
1. In `admin-views/partials/user-row.eta`, line 21, change:
   ```
   <a href="/admin/users/<%= it.user.id %>" class="btn btn-link btn-sm">View Chat</a>
   ```
   to:
   ```
   <a href="/admin/users/<%= it.user.id %>" class="btn btn-link btn-sm">View Details</a>
   ```

2. In `src/admin/admin.routes.ts`, update the `/users/:id` GET route handler (around line 97-123). Replace the current Tautulli logic with three-state status tracking:

   Replace the current block:
   ```typescript
   let plexUsers = null;
   let linkedPlexUser = null;

   if (fastify.tautulli) {
     try {
       const tautulliUsers = await fastify.tautulli.getUsers();
       plexUsers = tautulliUsers;
       if (user.plexUserId) {
         const match = tautulliUsers.find(
           (u: { user_id: number; friendly_name?: string; username?: string }) =>
             u.user_id === user.plexUserId,
         );
         linkedPlexUser = match?.friendly_name || match?.username || `ID: ${user.plexUserId}`;
       }
     } catch {
       // Tautulli unavailable -- omit plex linking section
     }
   }

   return reply.viewAsync("pages/user-detail", { user, plexUsers, linkedPlexUser });
   ```

   With:
   ```typescript
   let plexUsers = null;
   let linkedPlexUser = null;
   let tautulliStatus: "available" | "error" | "not_configured" = "not_configured";

   if (fastify.tautulli) {
     try {
       const tautulliUsers = await fastify.tautulli.getUsers();
       plexUsers = tautulliUsers;
       tautulliStatus = "available";
       if (user.plexUserId) {
         const match = tautulliUsers.find(
           (u: { user_id: number; friendly_name?: string; username?: string }) =>
             u.user_id === user.plexUserId,
         );
         linkedPlexUser = match?.friendly_name || match?.username || `ID: ${user.plexUserId}`;
       }
     } catch {
       tautulliStatus = "error";
     }
   }

   return reply.viewAsync("pages/user-detail", { user, plexUsers, linkedPlexUser, tautulliStatus });
   ```

   The key changes: (a) introduce `tautulliStatus` with three possible values, (b) set it to `"available"` on success instead of relying on `plexUsers !== null`, (c) set it to `"error"` on catch instead of silently swallowing, (d) pass `tautulliStatus` to the template.
  </action>
  <verify>
    `npx tsc --noEmit` passes. Grep for `tautulliStatus` in `src/admin/admin.routes.ts` confirms the variable is declared and passed to the template. Grep for `View Details` in `admin-views/partials/user-row.eta` confirms the label change.
  </verify>
  <done>
    User list shows "View Details" instead of "View Chat". Route passes `tautulliStatus` ("available", "error", or "not_configured") to the user detail template.
  </done>
</task>

<task type="auto">
  <name>Task 2: Restructure Plex section template for three states with error styling</name>
  <files>admin-views/pages/user-detail.eta, admin-assets/style.css</files>
  <action>
1. In `admin-views/pages/user-detail.eta`, replace the entire Plex section (lines 41-73, the `<% if (it.plexUsers) { %>` block) with a section that is ALWAYS rendered and branches on `it.tautulliStatus`:

   ```eta
   <div class="plex-section">
     <h2 class="section-title" style="margin-top:0">Plex Account Linking</h2>

     <% if (it.tautulliStatus === "available") { %>
       <% if (it.linkedPlexUser) { %>
         <p style="margin-bottom:0.75rem">
           Linked to: <strong><%= it.linkedPlexUser %></strong>
         </p>
         <button class="btn btn-danger btn-sm"
                 hx-post="/admin/api/users/<%= it.user.id %>/link-plex"
                 hx-vals='{"plexUserId": null}'
                 hx-target="closest .plex-section"
                 hx-swap="outerHTML"
                 hx-confirm="Unlink this Plex user?">
           Unlink
         </button>
       <% } else { %>
         <form class="form-inline"
               hx-post="/admin/api/users/<%= it.user.id %>/link-plex"
               hx-target="closest .plex-section"
               hx-swap="outerHTML">
           <select name="plexUserId">
             <option value="">Select a Plex user...</option>
             <% if (it.plexUsers && it.plexUsers.length > 0) { %>
               <% it.plexUsers.forEach(pu => { %>
                 <option value="<%= pu.user_id %>"><%= pu.friendly_name || pu.username %></option>
               <% }) %>
             <% } %>
           </select>
           <button type="submit" class="btn btn-primary btn-sm">Link</button>
         </form>
       <% } %>

     <% } else if (it.tautulliStatus === "error") { %>
       <div class="plex-unavailable plex-unavailable-error">
         <p><strong>Tautulli is not responding.</strong></p>
         <p>Plex user linking requires a connection to Tautulli to fetch the list of Plex users. Check that Tautulli is running and accessible, then reload this page.</p>
       </div>

     <% } else { %>
       <div class="plex-unavailable plex-unavailable-not-configured">
         <p><strong>Tautulli is not configured.</strong></p>
         <p>Plex user linking requires a Tautulli connection. Set the <code>TAUTULLI_URL</code> and <code>TAUTULLI_API_KEY</code> environment variables to enable this feature.</p>
       </div>

     <% } %>
   </div>
   ```

   The "available" branch preserves the existing linking/unlinking UI exactly. The "error" branch shows an explicit error message. The "not_configured" branch tells the admin what env vars to set.

2. In `admin-assets/style.css`, add styles for the unavailable states after the existing `.plex-section .form-inline select` rule (around line 658):

   ```css
   /* Plex unavailable states */
   .plex-unavailable {
     padding: 1rem;
     border-radius: 6px;
     font-size: 0.875rem;
     line-height: 1.6;
   }

   .plex-unavailable p + p {
     margin-top: 0.35rem;
   }

   .plex-unavailable code {
     background: rgba(0, 0, 0, 0.06);
     padding: 0.1rem 0.35rem;
     border-radius: 3px;
     font-size: 0.8rem;
     font-family: "SF Mono", Menlo, Monaco, monospace;
   }

   .plex-unavailable-error {
     background: #fef2f2;
     border: 1px solid #fca5a5;
     color: #991b1b;
   }

   .plex-unavailable-not-configured {
     background: #fffbeb;
     border: 1px solid #fcd34d;
     color: #92400e;
   }
   ```

   The error state uses the same red styling as `.flash-error` for consistency. The not-configured state uses amber/yellow to indicate a configuration issue (not a failure).
  </action>
  <verify>
    Grep for `tautulliStatus` in `admin-views/pages/user-detail.eta` confirms the three-way branching. Grep for `plex-unavailable` in both `admin-views/pages/user-detail.eta` and `admin-assets/style.css` confirms the error state classes exist. Verify the old `<% if (it.plexUsers) { %>` guard is gone (grep should NOT find it). `npx tsc --noEmit` still passes (template changes don't affect TS compilation, but ensures route changes from Task 1 didn't break anything).
  </verify>
  <done>
    Plex section is always visible on user detail page. Three states render correctly: (1) "available" shows the dropdown/unlink UI as before, (2) "error" shows a red banner explaining Tautulli is not responding, (3) "not_configured" shows an amber banner with env var instructions. Error and not-configured states are styled consistently with existing dashboard patterns.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- User list row shows "View Details" not "View Chat"
- User detail route passes `tautulliStatus` to the template
- Plex section always renders (no conditional wrapping the entire section)
- Three template branches exist for "available", "error", and "not_configured"
- Error state shows red banner with "Tautulli is not responding" message
- Not-configured state shows amber banner with env var guidance
- Available state preserves existing link/unlink functionality exactly
- CSS includes `.plex-unavailable`, `.plex-unavailable-error`, and `.plex-unavailable-not-configured` styles
</verification>

<success_criteria>
All three ROADMAP success criteria are met:
1. User detail page link says "View Details" -- clearly labeled, not misleading
2. Plex linking section is always prominently displayed on user detail page
3. Tautulli unavailability produces an explicit error state (not silently hidden)
</success_criteria>

<output>
After completion, create `.planning/phases/17-admin-dashboard-ux-polish/17-01-SUMMARY.md`
</output>
