---
phase: 06-search-and-discovery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/conversation/tools/search-movies.ts
  - src/conversation/tools/search-series.ts
  - src/conversation/tools/get-upcoming.ts
  - src/conversation/tools/index.ts
autonomous: true

must_haves:
  truths:
    - "search_movies tool returns movie results with title, year, tmdbId, overview, inLibrary, status, and studio"
    - "search_series tool returns series results with title, year, tvdbId, network, seasonCount, overview, inLibrary, and status"
    - "get_upcoming_episodes tool returns episodes enriched with seriesTitle resolved from getSeries()"
    - "get_upcoming_movies tool returns upcoming movies with title, year, release dates, status, and overview"
    - "All four tools return structured error object when their media server is not configured"
    - "Search results are capped at 10 items; overviews truncated to 150 chars"
  artifacts:
    - path: "src/conversation/tools/search-movies.ts"
      provides: "search_movies tool definition"
      exports: ["searchMoviesTool"]
    - path: "src/conversation/tools/search-series.ts"
      provides: "search_series tool definition"
      exports: ["searchSeriesTool"]
    - path: "src/conversation/tools/get-upcoming.ts"
      provides: "get_upcoming_episodes and get_upcoming_movies tool definitions"
      exports: ["getUpcomingEpisodesTool", "getUpcomingMoviesTool"]
    - path: "src/conversation/tools/index.ts"
      provides: "Barrel export of all search/discovery tools"
      exports: ["searchMoviesTool", "searchSeriesTool", "getUpcomingEpisodesTool", "getUpcomingMoviesTool"]
  key_links:
    - from: "src/conversation/tools/search-movies.ts"
      to: "src/conversation/tools.ts"
      via: "import { defineTool }"
      pattern: "defineTool\\("
    - from: "src/conversation/tools/search-movies.ts"
      to: "src/media/radarr/radarr.client.ts"
      via: "context.radarr.searchMovies() and context.radarr.getMovies()"
      pattern: "context\\.radarr"
    - from: "src/conversation/tools/search-series.ts"
      to: "src/media/sonarr/sonarr.client.ts"
      via: "context.sonarr.searchSeries() and context.sonarr.getSeries()"
      pattern: "context\\.sonarr"
    - from: "src/conversation/tools/get-upcoming.ts"
      to: "src/media/sonarr/sonarr.client.ts"
      via: "context.sonarr.getCalendar() and context.sonarr.getSeries()"
      pattern: "context\\.sonarr\\.getCalendar"
    - from: "src/conversation/tools/get-upcoming.ts"
      to: "src/media/radarr/radarr.client.ts"
      via: "context.radarr.getUpcoming()"
      pattern: "context\\.radarr\\.getUpcoming"
---

<objective>
Define four LLM tool definitions for searching movies/shows and viewing upcoming schedules.

Purpose: These tools are the core of Phase 6 -- they wrap the existing Sonarr/Radarr client methods into the defineTool format so the conversation engine can route natural language to media server API calls. Search tools cross-reference results against the user's library to indicate what they already have.

Output: Four tool definition files in src/conversation/tools/ plus a barrel index, ready to be registered in the conversation plugin (Plan 02).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-search-and-discovery/06-RESEARCH.md
@src/conversation/tools.ts
@src/conversation/types.ts
@src/media/sonarr/sonarr.client.ts
@src/media/sonarr/sonarr.schemas.ts
@src/media/radarr/radarr.client.ts
@src/media/radarr/radarr.schemas.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create search_movies and search_series tool definitions</name>
  <files>src/conversation/tools/search-movies.ts, src/conversation/tools/search-series.ts</files>
  <action>
Create directory `src/conversation/tools/`.

**search-movies.ts:** Define and export `searchMoviesTool` using `defineTool()` from `../tools.js`:
- Name: `"search_movies"`
- Description: `"Search for movies by title. Returns matching movies with title, year, overview, and whether they are already in the user's library. Use when the user wants to find, look up, or search for a movie."`
- Parameters: `z.object({ query: z.string().describe("The movie title to search for") })`
- Tier: `"safe"`
- Executor:
  1. Null-check `context.radarr` -- if missing, return `{ error: "Movie server (Radarr) is not configured" }`
  2. `Promise.all([context.radarr.searchMovies(args.query), context.radarr.getMovies()])` for parallel fetch
  3. Build `Set<number>` of `tmdbId` values from library results
  4. If no search results, return `{ results: [], message: "No movies found" }`
  5. Map first 10 results to `{ title, year, tmdbId, overview (truncated to 150 chars with "..." suffix), inLibrary (boolean from Set lookup), status, studio (nullable) }`
  6. Return `{ results: [...] }`

**search-series.ts:** Define and export `searchSeriesTool` using `defineTool()` from `../tools.js`:
- Name: `"search_series"`
- Description: `"Search for TV shows by title. Returns matching shows with title, year, network, seasons, overview, and whether they are already in the user's library. Use when the user wants to find, look up, or search for a TV show, series, or program."`
- Parameters: `z.object({ query: z.string().describe("The TV show title to search for") })`
- Tier: `"safe"`
- Executor:
  1. Null-check `context.sonarr` -- if missing, return `{ error: "TV server (Sonarr) is not configured" }`
  2. `Promise.all([context.sonarr.searchSeries(args.query), context.sonarr.getSeries()])` for parallel fetch
  3. Build `Set<number>` of `tvdbId` values from library results
  4. If no search results, return `{ results: [], message: "No TV shows found" }`
  5. Map first 10 results to `{ title, year, tvdbId, network (nullable), seasonCount (from seasons.length), overview (truncated to 150 chars), inLibrary, status }`
  6. Return `{ results: [...] }`

Both files: import `z` from `"zod"` and `defineTool` from `"../tools.js"`. Use `.js` extensions in all relative imports (ESM convention from codebase).
  </action>
  <verify>Run `npx tsc --noEmit` to confirm both files compile without errors. Verify both files export their tool constant.</verify>
  <done>search_movies and search_series tools defined, exported, and type-check cleanly against the existing ToolDefinition interface.</done>
</task>

<task type="auto">
  <name>Task 2: Create get_upcoming_episodes and get_upcoming_movies tool definitions plus barrel index</name>
  <files>src/conversation/tools/get-upcoming.ts, src/conversation/tools/index.ts</files>
  <action>
**get-upcoming.ts:** Define and export `getUpcomingEpisodesTool` and `getUpcomingMoviesTool`:

`getUpcomingEpisodesTool`:
- Name: `"get_upcoming_episodes"`
- Description: `"Get upcoming TV episodes airing soon. Shows series name, episode title, season/episode numbers, and air date. Use when the user asks about upcoming episodes, what's airing, TV schedule, or 'what's on'."`
- Parameters: `z.object({ days: z.number().min(1).max(30).optional().describe("Number of days to look ahead (default 7)") })`
  - Use `.optional()` instead of `.default()` to avoid JSON Schema ambiguity with LLM providers. Apply default in executor: `const days = args.days ?? 7;`
- Tier: `"safe"`
- Executor:
  1. Null-check `context.sonarr` -- return `{ error: "TV server (Sonarr) is not configured" }` if missing
  2. Compute `start` and `end` ISO date strings (`YYYY-MM-DD`) from current date + days
  3. `Promise.all([context.sonarr.getCalendar(start, end), context.sonarr.getSeries()])` -- fetch calendar and series list in parallel for title resolution (research recommends separate fetch over relying on includeSeries passthrough)
  4. Build `Map<number, string>` of `seriesId -> title` from series list
  5. If no episodes, return `{ episodes: [], message: "No upcoming episodes" }`
  6. Map episodes to `{ seriesTitle (resolved from map, fallback "Unknown Series"), title, seasonNumber, episodeNumber, airDateUtc, hasFile (default false) }`
  7. Return `{ episodes: [...] }`

`getUpcomingMoviesTool`:
- Name: `"get_upcoming_movies"`
- Description: `"Get upcoming movie releases (theatrical, digital, or physical). Shows title, year, release dates, and status. Use when the user asks about upcoming movies, new releases, or movie schedules."`
- Parameters: `z.object({ days: z.number().min(1).max(90).optional().describe("Number of days to look ahead (default 30)") })`
  - Same `.optional()` pattern, default in executor: `const days = args.days ?? 30;`
- Tier: `"safe"`
- Executor:
  1. Null-check `context.radarr` -- return error if missing
  2. Compute `start` and `end` ISO date strings from current date + days
  3. Call `context.radarr.getUpcoming(start, end)`
  4. If no movies, return `{ movies: [], message: "No upcoming movies" }`
  5. Map to `{ title, year, inCinemas (nullable), physicalRelease (nullable), digitalRelease (nullable), status, overview (truncated to 100 chars) }`
  6. Return `{ movies: [...] }`

**index.ts:** Barrel re-export file:
```typescript
export { searchMoviesTool } from "./search-movies.js";
export { searchSeriesTool } from "./search-series.js";
export { getUpcomingEpisodesTool, getUpcomingMoviesTool } from "./get-upcoming.js";
```
  </action>
  <verify>Run `npx tsc --noEmit` to confirm all files compile. Run `npx biome check src/conversation/tools/` to confirm lint/format compliance.</verify>
  <done>All four tool definitions (search_movies, search_series, get_upcoming_episodes, get_upcoming_movies) are defined, exported from individual files, and re-exported from the barrel index.ts. All type-check and lint cleanly.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- `npx biome check src/conversation/tools/` passes with zero errors
- Four files exist in `src/conversation/tools/`: search-movies.ts, search-series.ts, get-upcoming.ts, index.ts
- Each tool file imports `defineTool` from `../tools.js` and `z` from `"zod"`
- Each search tool calls both the search method and the library list method in parallel via `Promise.all`
- Each tool null-checks its media server client before any API calls
- Search results are capped at 10, overviews truncated to 150 chars (100 for upcoming movies)
</verification>

<success_criteria>
- Four LLM tool definitions exist and compile cleanly
- search_movies cross-references tmdbId against library
- search_series cross-references tvdbId against library
- get_upcoming_episodes resolves seriesTitle via separate getSeries() call
- All tools handle missing media server gracefully with structured error
- Barrel index re-exports all four tools
</success_criteria>

<output>
After completion, create `.planning/phases/06-search-and-discovery/06-01-SUMMARY.md`
</output>
