---
phase: 06-search-and-discovery
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/conversation/system-prompt.ts
  - src/plugins/conversation.ts
autonomous: true

must_haves:
  truths:
    - "System prompt instructs LLM on when to auto-select vs present numbered options for ambiguous results"
    - "System prompt instructs LLM to mention library status in results"
    - "System prompt instructs LLM to keep responses concise for SMS"
    - "All four search/discovery tools are registered in the conversation plugin's ToolRegistry"
    - "TypeScript builds cleanly with all tools wired end-to-end"
  artifacts:
    - path: "src/conversation/system-prompt.ts"
      provides: "System prompt with search behavior, ambiguity handling, and schedule guidance"
      contains: "ambiguous"
    - path: "src/plugins/conversation.ts"
      provides: "Tool registration for all search/discovery tools"
      contains: "searchMoviesTool"
  key_links:
    - from: "src/plugins/conversation.ts"
      to: "src/conversation/tools/index.ts"
      via: "import { searchMoviesTool, searchSeriesTool, getUpcomingEpisodesTool, getUpcomingMoviesTool }"
      pattern: "from.*tools/index"
    - from: "src/plugins/conversation.ts"
      to: "src/conversation/tools.ts"
      via: "registry.register() for each tool"
      pattern: "registry\\.register"
---

<objective>
Wire search/discovery tools into the conversation engine by updating the system prompt with search behavior guidance and registering all four tools in the conversation plugin.

Purpose: This completes the end-to-end flow -- after this plan, a user can text a movie or show title and the LLM will call the appropriate search tool, cross-reference the library, and format results following the system prompt's guidance on ambiguity resolution and SMS-friendly formatting.

Output: Updated system-prompt.ts with search/ambiguity/schedule instructions, updated conversation.ts with tool registration, verified build.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-search-and-discovery/06-RESEARCH.md
@.planning/phases/06-search-and-discovery/06-01-SUMMARY.md
@src/conversation/system-prompt.ts
@src/plugins/conversation.ts
@src/conversation/tools.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update system prompt with search behavior and ambiguity resolution guidance</name>
  <files>src/conversation/system-prompt.ts</files>
  <action>
Modify the existing `SYSTEM_PROMPT` constant in `src/conversation/system-prompt.ts`. Keep the existing structure (template literal, `buildSystemPrompt` function unchanged) but replace the content with an expanded prompt that adds search-specific guidance.

The updated prompt should contain these sections (as plain text within the template literal, not code blocks):

1. **Role intro** (keep existing): "You are a helpful media management assistant..."

2. **Available capabilities** (keep existing list, already includes search/schedule items)

3. **Search behavior** (NEW -- add after capabilities):
   - When search returns exactly one result, present it directly with key details
   - When one result is clearly the best match (exact title match or very close), present it and briefly mention alternatives exist
   - When results are ambiguous (multiple similar titles, remakes, different years), present the top 3-5 as a numbered list with enough detail to choose (title, year, brief description)
   - Always tell the user if a result is already in their library
   - If the user doesn't specify movie or TV show, make your best guess from context. If truly uncertain, search both.

4. **Response format** (expand existing "Guidelines"):
   - Be concise. Users are texting via SMS, keep responses short and scannable
   - Use line breaks between results for readability
   - Include year in parentheses after titles to distinguish versions
   - For TV shows, mention the network and number of seasons
   - Truncate overviews to 1-2 sentences max. Users are on their phones
   - For add operations, use sensible defaults unless user specifies otherwise
   - Never execute remove/delete without explicit confirmation
   - If a tool call fails, explain the error simply and suggest next steps
   - Refer to the user by name when available

Do NOT change the `buildSystemPrompt` function signature or behavior. Only modify the SYSTEM_PROMPT string content.
  </action>
  <verify>Run `npx tsc --noEmit` to confirm no type errors. Verify the file still exports SYSTEM_PROMPT and buildSystemPrompt. Grep for "ambiguous" in the file to confirm search guidance was added.</verify>
  <done>System prompt contains explicit instructions for single-result auto-selection, multi-result numbered list presentation, library status mention, and SMS-concise formatting.</done>
</task>

<task type="auto">
  <name>Task 2: Register all search/discovery tools in the conversation plugin</name>
  <files>src/plugins/conversation.ts</files>
  <action>
Modify `src/plugins/conversation.ts` to import and register the four search/discovery tools.

1. Add import at top of file:
   ```typescript
   import {
     searchMoviesTool,
     searchSeriesTool,
     getUpcomingEpisodesTool,
     getUpcomingMoviesTool,
   } from "../conversation/tools/index.js";
   ```

2. After `const registry = createToolRegistry();` (which already registers `check_status`), add registration for all four tools:
   ```typescript
   registry.register(searchMoviesTool);
   registry.register(searchSeriesTool);
   registry.register(getUpcomingEpisodesTool);
   registry.register(getUpcomingMoviesTool);
   ```

3. Update the log.info message to reflect the number of registered tools (optional but helpful for debugging): keep the existing log or add tool count.

Do NOT change plugin name, dependencies, decorator names, or the graceful-skip pattern for unconfigured LLM.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm the full project builds cleanly with all tools wired.
Run `npx biome check src/` to confirm no lint/format issues.
Run `node --import tsx/esm src/index.ts` briefly (or just `npx tsc --noEmit`) to confirm no import resolution errors.
  </verify>
  <done>All four search/discovery tools are registered in the ToolRegistry alongside the existing check_status tool. The conversation plugin imports from the barrel index and registers each tool. TypeScript builds cleanly.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors (entire project)
- `npx biome check src/` passes with zero errors
- System prompt contains "ambiguous" and "numbered list" text
- conversation.ts imports from `../conversation/tools/index.js`
- conversation.ts calls `registry.register()` for searchMoviesTool, searchSeriesTool, getUpcomingEpisodesTool, getUpcomingMoviesTool
- End-to-end: LLM client creation -> tool registry with 5 tools (check_status + 4 new) -> toolCallLoop can resolve all 5
</verification>

<success_criteria>
- System prompt guides LLM behavior for search result presentation and ambiguity resolution (SRCH-04)
- All four tools registered and accessible via ToolRegistry.get() and ToolRegistry.getDefinitions()
- Full TypeScript build passes
- No changes to existing tool-loop.ts, engine.ts, or types.ts (infrastructure is untouched)
</success_criteria>

<output>
After completion, create `.planning/phases/06-search-and-discovery/06-02-SUMMARY.md`
</output>
