---
phase: 04-media-server-clients
plan: 03
type: execute
wave: 3
depends_on: ["04-01", "04-02"]
files_modified:
  - src/plugins/sonarr.ts
  - src/plugins/radarr.ts
  - src/server.ts
autonomous: true

must_haves:
  truths:
    - "Quality profiles and root folders are fetched from Sonarr on startup and accessible via fastify.sonarr"
    - "Quality profiles and root folders are fetched from Radarr on startup and accessible via fastify.radarr"
    - "When Sonarr URL/key are not configured, the plugin skips registration gracefully with a warning log"
    - "When Radarr URL/key are not configured, the plugin skips registration gracefully with a warning log"
    - "When Sonarr is unreachable on startup, the client is still registered but cached data is empty"
    - "When Radarr is unreachable on startup, the client is still registered but cached data is empty"
    - "The application starts successfully even when both Sonarr and Radarr are completely unavailable"
    - "Cached quality profiles and root folders are accessible as properties on the client instances"
  artifacts:
    - path: "src/plugins/sonarr.ts"
      provides: "Fastify plugin that creates SonarrClient, caches profiles/folders, decorates fastify.sonarr"
      exports: ["default"]
    - path: "src/plugins/radarr.ts"
      provides: "Fastify plugin that creates RadarrClient, caches profiles/folders, decorates fastify.radarr"
      exports: ["default"]
    - path: "src/server.ts"
      provides: "Updated server with sonarr and radarr plugin registration"
      contains: "sonarrPlugin"
  key_links:
    - from: "src/plugins/sonarr.ts"
      to: "src/media/sonarr/sonarr.client.ts"
      via: "creates SonarrClient instance and calls loadCachedData"
      pattern: "new SonarrClient"
    - from: "src/plugins/radarr.ts"
      to: "src/media/radarr/radarr.client.ts"
      via: "creates RadarrClient instance and calls loadCachedData"
      pattern: "new RadarrClient"
    - from: "src/server.ts"
      to: "src/plugins/sonarr.ts"
      via: "registers sonarr plugin"
      pattern: "register.*sonarrPlugin"
    - from: "src/server.ts"
      to: "src/plugins/radarr.ts"
      via: "registers radarr plugin"
      pattern: "register.*radarrPlugin"
---

<objective>
Create Fastify plugins for Sonarr and Radarr that handle startup caching of quality profiles and root folders, graceful degradation when servers are unreachable, and wire everything into the server.

Purpose: Completes the media server client integration by making SonarrClient and RadarrClient available as Fastify decorators with pre-cached configuration data, while ensuring the application never crashes due to unreachable media servers.

Output: `src/plugins/sonarr.ts`, `src/plugins/radarr.ts`, updated `src/server.ts`
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-media-server-clients/04-RESEARCH.md
@.planning/phases/04-media-server-clients/04-01-SUMMARY.md
@.planning/phases/04-media-server-clients/04-02-SUMMARY.md

@src/config.ts
@src/server.ts
@src/plugins/messaging.ts
@src/plugins/database.ts
@src/media/sonarr/sonarr.client.ts
@src/media/sonarr/sonarr.types.ts
@src/media/radarr/radarr.client.ts
@src/media/radarr/radarr.types.ts
@src/media/errors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cached data methods to client classes and create Fastify plugins</name>
  <files>src/media/sonarr/sonarr.client.ts, src/media/radarr/radarr.client.ts, src/plugins/sonarr.ts, src/plugins/radarr.ts</files>
  <action>
First, add cached data support to both client classes:

In `src/media/sonarr/sonarr.client.ts`, add to SonarrClient:
- Public property `qualityProfiles: QualityProfile[] = []`
- Public property `rootFolders: RootFolder[] = []`
- Public async method `loadCachedData(): Promise<void>` that fetches quality profiles and root folders and stores them on the properties above. This is called once on startup by the plugin.

In `src/media/radarr/radarr.client.ts`, add same pattern to RadarrClient:
- Public property `qualityProfiles: QualityProfile[] = []`
- Public property `rootFolders: RootFolder[] = []`
- Public async method `loadCachedData(): Promise<void>` that fetches quality profiles and root folders and stores them.

Then create the Fastify plugins:

Create `src/plugins/sonarr.ts`:
- Import fp from fastify-plugin
- Augment FastifyInstance with `sonarr?: SonarrClient` (optional -- may not be registered if not configured)
- Plugin logic:
  1. Read `SONARR_URL` and `SONARR_API_KEY` from `fastify.config`
  2. If either is missing: `fastify.log.warn("Sonarr not configured, client unavailable")` and return (skip registration)
  3. Create `new SonarrClient(SONARR_URL, SONARR_API_KEY)`
  4. Try `await client.loadCachedData()` in a try/catch:
     - On success: `fastify.log.info({ profiles: client.qualityProfiles.length, rootFolders: client.rootFolders.length }, "Sonarr connected, cached data loaded")`
     - On catch: `fastify.log.error({ err }, "Sonarr unreachable on startup, client registered in degraded mode")` -- do NOT rethrow, still register the client
  5. `fastify.decorate("sonarr", client)`
- Wrap with `fp(..., { name: "sonarr", dependencies: ["database"] })`

Create `src/plugins/radarr.ts`:
- Same pattern as sonarr.ts but for RadarrClient
- Augment FastifyInstance with `radarr?: RadarrClient` (optional)
- Read `RADARR_URL` and `RADARR_API_KEY` from config
- Same skip/create/cache/degrade/decorate flow
- Wrap with `fp(..., { name: "radarr", dependencies: ["database"] })`

Note: The `declare module "fastify"` augmentation must use `?:` (optional) for both sonarr and radarr because plugins may skip registration when not configured. Downstream code should check `if (!fastify.sonarr)` before using.

Use `.js` extensions on all relative imports. Follow existing plugin patterns (see messaging.ts, database.ts).
  </action>
  <verify>Run `npx tsc --noEmit` and confirm no type errors.</verify>
  <done>Both client classes have loadCachedData() method and qualityProfiles/rootFolders properties. Fastify plugins created following existing patterns. Plugins skip gracefully when not configured, catch connection errors on startup without crashing, and decorate fastify instance.</done>
</task>

<task type="auto">
  <name>Task 2: Wire plugins into server.ts and verify full build</name>
  <files>src/server.ts</files>
  <action>
Update `src/server.ts`:
1. Add imports for the new plugins:
   ```
   import sonarrPlugin from "./plugins/sonarr.js";
   import radarrPlugin from "./plugins/radarr.js";
   ```
2. Register both plugins AFTER databasePlugin and healthPlugin but BEFORE messagingPlugin (media clients are infrastructure-level, messaging depends on infrastructure):
   ```
   await fastify.register(databasePlugin);
   await fastify.register(healthPlugin);
   await fastify.register(sonarrPlugin);
   await fastify.register(radarrPlugin);
   await fastify.register(formbody);
   await fastify.register(messagingPlugin);
   await fastify.register(userResolverPlugin);
   await fastify.register(webhookPlugin);
   ```
3. The FastifyInstance type augmentation for sonarr/radarr is already in the plugin files (via `declare module "fastify"` in sonarr.ts and radarr.ts), so no additional type augmentation is needed in server.ts.

Do NOT make any other changes to server.ts.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm full project compiles. Run `npx biome check src/` to confirm code style compliance across all new and modified files. Run `npm run build` to confirm production build succeeds.
  </verify>
  <done>server.ts registers sonarr and radarr plugins. Full project compiles with `tsc --noEmit`. Production build succeeds with `npm run build`. Application can start with or without Sonarr/Radarr env vars configured.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors across entire project
- `npx biome check src/` passes with zero errors
- `npm run build` succeeds
- `src/plugins/sonarr.ts` creates SonarrClient, caches data on startup, decorates fastify.sonarr
- `src/plugins/radarr.ts` creates RadarrClient, caches data on startup, decorates fastify.radarr
- Both plugins skip gracefully when URL/key env vars are missing (warn log, no crash)
- Both plugins catch connection errors on startup (error log, client still registered, no crash)
- `src/server.ts` registers both plugins in correct order
- SonarrClient.qualityProfiles and SonarrClient.rootFolders are populated after loadCachedData
- RadarrClient.qualityProfiles and RadarrClient.rootFolders are populated after loadCachedData
</verification>

<success_criteria>
Both media server clients are integrated into the Fastify application lifecycle. Quality profiles and root folders are cached on startup for use in add operations. The application starts cleanly whether servers are configured, reachable, or unavailable. Downstream code can access clients via fastify.sonarr and fastify.radarr with proper TypeScript types.
</success_criteria>

<output>
After completion, create `.planning/phases/04-media-server-clients/04-03-SUMMARY.md`
</output>
