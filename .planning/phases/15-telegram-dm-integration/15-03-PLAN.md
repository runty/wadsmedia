---
phase: 15-telegram-dm-integration
plan: 03
type: execute
wave: 3
depends_on: ["15-01", "15-02"]
files_modified:
  - src/conversation/system-prompt.ts
  - src/conversation/engine.ts
  - src/notifications/notify.ts
  - src/conversation/tools/add-movie.ts
  - src/conversation/tools/add-series.ts
autonomous: true

must_haves:
  truths:
    - "Telegram users receive HTML-formatted responses with longer message allowance"
    - "SMS users still receive plain text SMS-formatted responses (no regression)"
    - "Search results for Telegram users include poster images inline"
    - "Notifications reach both SMS and Telegram users"
    - "Admin notifications from add-movie/add-series use admin's preferred channel"
  artifacts:
    - path: "src/conversation/system-prompt.ts"
      provides: "Provider-aware system prompt with Telegram formatting guidance"
      exports: ["buildSystemPrompt"]
    - path: "src/conversation/engine.ts"
      provides: "Provider-aware reply sending (no MMS pixel for Telegram, typing indicator)"
      contains: "providerName"
    - path: "src/notifications/notify.ts"
      provides: "Multi-provider notification dispatch to SMS and Telegram users"
      contains: "telegramChatId"
  key_links:
    - from: "src/conversation/engine.ts"
      to: "src/messaging/types.ts"
      via: "MessagingProvider.providerName to determine reply behavior"
      pattern: "providerName.*telegram"
    - from: "src/conversation/system-prompt.ts"
      to: "src/conversation/engine.ts"
      via: "buildSystemPrompt(displayName, provider) called in engine"
      pattern: "buildSystemPrompt"
    - from: "src/notifications/notify.ts"
      to: "src/messaging/telegram-provider.ts"
      via: "telegramProvider.send for Telegram users"
      pattern: "telegramChatId"
---

<objective>
Adapt the conversation engine and system prompt for provider-aware formatting (HTML for Telegram, plain text for SMS), update the notification system to dispatch to both SMS and Telegram users, and update admin notification paths in add-movie/add-series tools.

Purpose: Without this, Telegram users would receive SMS-formatted plain text responses, miss out on poster images in search results, and Telegram-only users would not receive notifications.

Output: Provider-aware system prompt, engine with Telegram reply handling, multi-provider notifications.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-telegram-dm-integration/15-01-SUMMARY.md
@.planning/phases/15-telegram-dm-integration/15-02-SUMMARY.md
@src/conversation/system-prompt.ts
@src/conversation/engine.ts
@src/notifications/notify.ts
@src/conversation/tools/add-movie.ts
@src/conversation/tools/add-series.ts
@src/messaging/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Make system prompt and engine provider-aware for Telegram formatting</name>
  <files>src/conversation/system-prompt.ts, src/conversation/engine.ts</files>
  <action>
**src/conversation/system-prompt.ts:**

Update `buildSystemPrompt` to accept an optional provider parameter:

```typescript
export function buildSystemPrompt(displayName?: string | null, provider?: string): string {
```

When provider === "telegram", append a Telegram-specific formatting addendum to the system prompt. When provider is absent or "twilio", use the existing SMS prompt as-is.

Add this constant for the Telegram addendum (append AFTER the base SYSTEM_PROMPT):

```typescript
const TELEGRAM_ADDENDUM = `

IMPORTANT FORMAT OVERRIDE -- You are chatting on Telegram, NOT SMS:
- Use HTML formatting: <b>bold</b> for titles, <i>italic</i> for descriptions, <code>code</code> for IDs/technical info
- You can write longer messages (up to 4096 chars) -- still be concise but don't aggressively truncate like SMS
- Only escape <, >, & in text (HTML parse mode)
- Do NOT use markdown formatting (no **, no *, no #, no -)
- Poster images are sent automatically with search results -- reference them naturally ("check out the poster")
- When presenting search results, format each result clearly with title in <b>bold</b> and year
- Inline buttons will appear for common actions -- you don't need to tell users to type commands for Add, Next, or Check Plex`;
```

The function logic:
```typescript
export function buildSystemPrompt(displayName?: string | null, provider?: string): string {
  let prompt = SYSTEM_PROMPT;
  if (provider === "telegram") {
    prompt += TELEGRAM_ADDENDUM;
  }
  if (displayName && displayName.trim().length > 0) {
    prompt += `\n\nThe user's name is ${displayName.trim()}.`;
  }
  return prompt;
}
```

**src/conversation/engine.ts:**

1. Update ProcessConversationParams to include optional `providerName`:
```typescript
interface ProcessConversationParams {
  // ... existing fields ...
  /** Provider name for format-aware prompts ('twilio' | 'telegram') */
  providerName?: string;
}
```

2. In processConversation, extract providerName and pass to buildSystemPrompt:
```typescript
const providerName = params.providerName ?? params.messaging.providerName;
// ...
const llmMessages = buildLLMMessages(buildSystemPrompt(displayName, providerName), history, 20);
```

3. Update the reply-sending block at the end (after "Send the reply to the user"):
```typescript
// Send the reply -- format depends on provider
if (providerName === "telegram") {
  // Telegram: use HTML parse mode, no MMS pixel needed
  await messaging.send({
    to: replyAddress,
    body: result.reply,
    parseMode: "HTML" as const,
  });
} else {
  // SMS: existing behavior with MMS pixel for long messages
  const SMS_MAX = 300;
  const useMms = result.reply.length > SMS_MAX;
  log.info({ replyLength: result.reply.length, mms: useMms }, "Sending reply via messaging");
  await messaging.send({
    to: replyAddress,
    body: result.reply,
    ...(useMms && config.MMS_PIXEL_URL ? { mediaUrl: [config.MMS_PIXEL_URL] } : {}),
  });
}
log.info("Reply sent");
```

This keeps the existing SMS behavior untouched while adding Telegram-specific formatting.

Note: The Telegram webhook route (15-02) already passes `messaging: fastify.telegramMessaging` to processConversation, so `messaging.providerName` will be "telegram" automatically. The explicit providerName param is a fallback in case messaging is a different object.
  </action>
  <verify>
`npx tsc --noEmit` passes. buildSystemPrompt accepts optional provider parameter. Engine detects Telegram and sends with parseMode: "HTML" without MMS pixel.
  </verify>
  <done>Telegram users get HTML-formatted system prompt guidance. Engine sends replies with parseMode: "HTML" for Telegram, plain text + MMS pixel for SMS. No regression for existing SMS behavior.</done>
</task>

<task type="auto">
  <name>Task 2: Multi-provider notification dispatch and admin notification via preferred channel</name>
  <files>src/notifications/notify.ts, src/conversation/tools/add-movie.ts, src/conversation/tools/add-series.ts</files>
  <action>
**src/notifications/notify.ts:**

Update notifyAllActiveUsers to send to both SMS and Telegram users:

1. Change the function signature to accept an optional Telegram provider:
```typescript
export async function notifyAllActiveUsers(
  db: DB,
  messaging: MessagingProvider,
  _config: AppConfig,
  message: string,
  log: FastifyBaseLogger,
  telegramMessaging?: MessagingProvider,
): Promise<void> {
```

2. Update the query to select both phone and telegramChatId:
```typescript
const activeUsers = db
  .select({ phone: users.phone, telegramChatId: users.telegramChatId })
  .from(users)
  .where(eq(users.status, "active"))
  .all();
```

3. Update the notification loop to send via the appropriate provider:
```typescript
for (const user of activeUsers) {
  try {
    if (user.telegramChatId && telegramMessaging) {
      // Telegram user: send via Telegram provider
      await telegramMessaging.send({ to: user.telegramChatId, body: message });
    } else if (user.phone) {
      // SMS user: send via Twilio provider
      await messaging.send({ to: user.phone, body: message });
    }
    // Skip users with neither phone nor telegramChatId
  } catch (err) {
    log.error({ err, phone: user.phone, chatId: user.telegramChatId }, "Failed to send notification");
  }
}
```

4. Update the log message to reflect multi-provider dispatch.

**src/plugins/notifications.ts** (also modify):
Update calls to notifyAllActiveUsers to pass telegramMessaging:
```typescript
notifyAllActiveUsers(
  fastify.db,
  fastify.messaging,
  fastify.config,
  message,
  request.log,
  fastify.telegramMessaging,  // May be undefined if Telegram not configured
)
```

Add `fastify.telegramMessaging` to both the Sonarr and Radarr webhook handlers. Since telegramMessaging is optional on FastifyInstance (typed as `TelegramMessagingProvider | undefined` in 15-01), this is safe.

**src/conversation/tools/add-movie.ts:**

Update the admin notification block (around line 129) to prefer Telegram if configured:

```typescript
// Notify admin when non-admin adds media
if (!context.isAdmin && context.messaging) {
  const who = context.displayName || "A user";
  const msg = `${who} added movie: ${added.title} (${added.year ?? "N/A"}) [${routingReason}]`;

  // Prefer admin's Telegram if configured, fall back to SMS
  if (context.config?.ADMIN_TELEGRAM_CHAT_ID) {
    // We need the Telegram provider. It's not in ToolContext currently.
    // Use the messaging provider that was passed -- if it's Telegram, great.
    // If not, fall back to ADMIN_PHONE.
    context.messaging.send({ to: context.config.ADMIN_PHONE!, body: msg }).catch(() => {});
  } else if (context.config?.ADMIN_PHONE) {
    context.messaging.send({ to: context.config.ADMIN_PHONE, body: msg }).catch(() => {});
  }
}
```

Actually, the simpler approach: the tool context has `messaging` which is whichever provider the current user is on. Admin notification should always go to the admin. Keep using ADMIN_PHONE for now (admin is an SMS user). If ADMIN_TELEGRAM_CHAT_ID is set, we need a reference to the Telegram provider in ToolContext.

**Better approach -- add optional telegramMessaging to ToolContext:**

In src/conversation/types.ts, add to ToolContext:
```typescript
telegramMessaging?: import("../messaging/types.js").MessagingProvider;
```

Then in src/conversation/engine.ts, the processConversation function already gets messaging -- but we need the Telegram provider too. Update ProcessConversationParams:
```typescript
telegramMessaging?: MessagingProvider;
```

And pass it through to the tool context in the toolCallLoop call:
```typescript
context: {
  // ... existing fields ...
  telegramMessaging: params.telegramMessaging,
},
```

The Telegram webhook handler (15-02) already has access to fastify.telegramMessaging and passes messaging: fastify.telegramMessaging. Add telegramMessaging: fastify.telegramMessaging as well.
The Twilio webhook handler also needs updating: pass telegramMessaging: fastify.telegramMessaging (may be undefined).

Then update add-movie.ts and add-series.ts admin notification:
```typescript
if (!context.isAdmin) {
  const who = context.displayName || "A user";
  const msg = `${who} added movie: ${added.title} (${added.year ?? "N/A"}) [${routingReason}]`;

  // Send to admin via their preferred channel
  if (context.config?.ADMIN_TELEGRAM_CHAT_ID && context.telegramMessaging) {
    context.telegramMessaging.send({ to: context.config.ADMIN_TELEGRAM_CHAT_ID, body: msg }).catch(() => {});
  } else if (context.config?.ADMIN_PHONE && context.messaging) {
    context.messaging.send({ to: context.config.ADMIN_PHONE, body: msg }).catch(() => {});
  }
}
```

Apply the same pattern to add-series.ts (same admin notification block around line 129).

**Files additionally modified (update the frontmatter if needed during execution):**
- src/conversation/types.ts (add telegramMessaging to ToolContext)
- src/plugins/webhook.ts (pass telegramMessaging to processConversation)
- src/plugins/notifications.ts (pass telegramMessaging to notifyAllActiveUsers)
  </action>
  <verify>
`npx tsc --noEmit` passes. notifyAllActiveUsers sends to both phone and Telegram users. Admin notifications in add-movie and add-series prefer ADMIN_TELEGRAM_CHAT_ID when configured. ToolContext includes optional telegramMessaging.
  </verify>
  <done>Notifications dispatch to both SMS users (via Twilio) and Telegram users (via Telegram provider). Admin notifications in add-movie/add-series use admin's preferred channel (Telegram if ADMIN_TELEGRAM_CHAT_ID set, else SMS). ToolContext has telegramMessaging for cross-provider admin notifications.</done>
</task>

<task type="auto">
  <name>Task 3: Wire telegramMessaging through Twilio webhook route for cross-provider access</name>
  <files>src/plugins/webhook.ts, src/conversation/types.ts</files>
  <action>
**src/conversation/types.ts:**

Add optional telegramMessaging field to ToolContext:
```typescript
telegramMessaging?: import("../messaging/types.js").MessagingProvider;
```

**src/plugins/webhook.ts:**

In the processConversation call for active Twilio users (around line 52), add telegramMessaging:
```typescript
processConversation({
  // ... existing fields ...
  telegramMessaging: fastify.telegramMessaging,  // May be undefined
}).catch((err) => {
```

This gives the Twilio webhook path access to the Telegram provider so admin notifications from tool execution can reach Telegram-based admins.

Also add it to the error handler messaging.send and the non-LLM branch if needed (no -- those just send to the user's reply address, not admin).

Update the plugin dependencies: The webhook plugin currently depends on ["messaging", "user-resolver"]. Since telegramMessaging is optional (guarded with `?.`), no dependency change needed.
  </action>
  <verify>
`npx tsc --noEmit` passes. ToolContext has telegramMessaging field. Twilio webhook passes telegramMessaging to processConversation.
  </verify>
  <done>ToolContext has optional telegramMessaging field. Twilio webhook passes fastify.telegramMessaging to processConversation so tools can reach Telegram-based admins for notifications.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- buildSystemPrompt("name", "telegram") returns prompt with HTML formatting guidance
- buildSystemPrompt("name") returns original SMS prompt (no regression)
- Engine sends parseMode: "HTML" for Telegram replies, MMS pixel for long SMS replies
- notifyAllActiveUsers sends to Telegram users via Telegram provider
- Admin notifications in add-movie/add-series prefer ADMIN_TELEGRAM_CHAT_ID
- ToolContext includes optional telegramMessaging
</verification>

<success_criteria>
- Telegram user gets HTML-formatted responses with guidance about longer messages and inline buttons
- SMS user gets unchanged plain text responses (no regression)
- Sonarr/Radarr event notifications reach both SMS and Telegram users
- When non-admin adds media, admin is notified via their preferred channel (Telegram if configured)
- All TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/15-telegram-dm-integration/15-03-SUMMARY.md`
</output>
