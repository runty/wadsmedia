---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/db/schema.ts
  - src/db/index.ts
  - src/plugins/database.ts
  - src/server.ts
  - drizzle.config.ts
  - drizzle/
autonomous: true

must_haves:
  truths:
    - "SQLite database file is created automatically on first startup at the configured path"
    - "Schema migrations are applied automatically on startup without manual intervention"
    - "Database connection uses WAL mode for concurrent read performance"
    - "Database connection is closed gracefully on server shutdown"
    - "Drizzle Kit can generate new migration files from schema changes"
  artifacts:
    - path: "src/db/schema.ts"
      provides: "Drizzle table definitions for SQLite"
      exports: ["appMetadata"]
    - path: "src/db/index.ts"
      provides: "Database connection factory"
      exports: ["createDatabase"]
    - path: "src/plugins/database.ts"
      provides: "Fastify plugin registering db on instance with migrations"
      exports: ["default"]
    - path: "drizzle.config.ts"
      provides: "Drizzle Kit configuration for migration generation"
      contains: "dialect"
    - path: "drizzle/"
      provides: "Generated SQL migration files"
  key_links:
    - from: "src/plugins/database.ts"
      to: "src/db/schema.ts"
      via: "schema import for Drizzle instance"
      pattern: "import.*schema"
    - from: "src/plugins/database.ts"
      to: "src/db/index.ts"
      via: "createDatabase factory call"
      pattern: "createDatabase"
    - from: "src/server.ts"
      to: "src/plugins/database.ts"
      via: "fastify.register(databasePlugin)"
      pattern: "register.*database"
    - from: "src/plugins/database.ts"
      to: "drizzle/"
      via: "migrate() with migrationsFolder path"
      pattern: "migrate.*migrationsFolder"
---

<objective>
Add SQLite database support with Drizzle ORM, including schema definitions, automatic migrations on startup, WAL mode configuration, and graceful shutdown. Register the database as a Fastify plugin so all routes and plugins can access it.

Purpose: Establish the persistence layer that all subsequent phases depend on (users, conversations, messages all need the database). Getting migrations right now means every future schema change is a simple `npm run db:generate`.
Output: Working database with automatic migration, accessible via `fastify.db` in any route or plugin.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database schema, connection factory, and generate initial migration</name>
  <files>
    src/db/schema.ts
    src/db/index.ts
    drizzle.config.ts
    drizzle/
  </files>
  <action>
    1. Create src/db/schema.ts:
       - Import `sqliteTable`, `text`, `integer` from `'drizzle-orm/sqlite-core'`
       - Define `appMetadata` table with columns:
         - `key: text('key').primaryKey()`
         - `value: text('value').notNull()`
         - `updatedAt: integer('updated_at', { mode: 'timestamp' }).notNull().$defaultFn(() => new Date())`
       - This is a minimal table to prove the migration system works. Real tables (users, conversations) come in later phases.

    2. Create src/db/index.ts:
       - Import `Database` from `'better-sqlite3'`
       - Import `drizzle` from `'drizzle-orm/better-sqlite3'`
       - Import `* as schema` from `'./schema.js'`
       - Export `createDatabase(dbPath: string)` function that:
         - Creates a new `Database(dbPath)` instance
         - Sets SQLite pragmas in this order: `journal_mode = WAL`, `synchronous = normal`, `foreign_keys = ON`, `busy_timeout = 5000`
         - Creates Drizzle instance: `drizzle(sqlite, { schema })`
         - Returns `{ db, sqlite }` (both the Drizzle instance and raw sqlite for closing)

    3. Create drizzle.config.ts at project root:
       - Import `defineConfig` from `'drizzle-kit'`
       - Set `dialect: 'sqlite'` (NOT `driver: 'better-sqlite'` -- that is deprecated)
       - Set `schema: './src/db/schema.ts'`
       - Set `out: './drizzle'`
       - Set `dbCredentials: { url: process.env.DATABASE_PATH || './data/wadsmedia.db' }`

    4. Generate the initial migration:
       ```
       npx drizzle-kit generate
       ```
       This creates SQL files in drizzle/ directory. Verify the migration SQL creates the app_metadata table.

    5. Run `npm run build` and `npm run check` to ensure everything compiles and lints.
  </action>
  <verify>
    - `ls drizzle/` shows at least one .sql migration file and a meta/ directory
    - The migration SQL file contains `CREATE TABLE app_metadata`
    - `npm run build` succeeds
    - `npm run check` passes
  </verify>
  <done>
    Database schema defines app_metadata table. Connection factory creates SQLite with WAL mode and performance pragmas. Drizzle config enables migration generation. Initial migration SQL file exists in drizzle/ directory.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create database Fastify plugin and register in server</name>
  <files>
    src/plugins/database.ts
    src/server.ts
  </files>
  <action>
    1. Create src/plugins/database.ts:
       - Import `fp` from `'fastify-plugin'` (MUST use fastify-plugin wrapper to break encapsulation)
       - Import `migrate` from `'drizzle-orm/better-sqlite3/migrator'`
       - Import `createDatabase` from `'../db/index.js'`
       - Import `fileURLToPath` from `'node:url'` and `path` from `'node:path'`
       - Import `type FastifyInstance` from `'fastify'`

       - Augment Fastify types to add `db` decorator:
         ```typescript
         declare module 'fastify' {
           interface FastifyInstance {
             db: ReturnType<typeof import('../db/index.js').createDatabase>['db'];
           }
         }
         ```

       - Export default plugin wrapped in `fp()`:
         - Get database path from `fastify.config.DATABASE_PATH`
         - Call `createDatabase(dbPath)` to get `{ db, sqlite }`
         - Resolve migrations folder: use `path.dirname(fileURLToPath(import.meta.url))` to get __dirname, then `path.join(__dirname, '../../drizzle')` to reach the drizzle/ folder from the compiled dist/plugins/ location
         - Call `migrate(db, { migrationsFolder })` to apply pending migrations
         - Log: `fastify.log.info('Database connected and migrations applied')`
         - Decorate: `fastify.decorate('db', db)`
         - Add onClose hook to close sqlite connection: `fastify.addHook('onClose', () => { fastify.log.info('Closing database connection'); sqlite.close(); })`
       - Set plugin name: `{ name: 'database' }`

    2. Update src/server.ts:
       - Add import: `import databasePlugin from './plugins/database.js'`
       - Register the plugin inside buildServer after config decoration:
         ```typescript
         await fastify.register(databasePlugin);
         ```

    3. Run `npm run build` and `npm run check`

    4. Test the full startup:
       ```
       mkdir -p /tmp/wadsmedia-test
       DATABASE_PATH=/tmp/wadsmedia-test/test.db npx tsx src/index.ts
       ```
       Should log: database connected message, then server listening. Ctrl+C to stop.
       Verify the database file was created: `ls /tmp/wadsmedia-test/test.db`
       Clean up: `rm -rf /tmp/wadsmedia-test`
  </action>
  <verify>
    - `npm run build` succeeds
    - `npm run check` passes
    - Starting the server with `DATABASE_PATH=/tmp/wadsmedia-test/test.db npx tsx src/index.ts` logs "Database connected and migrations applied" and starts listening
    - `/tmp/wadsmedia-test/test.db` file exists after startup
    - WAL mode is active: `sqlite3 /tmp/wadsmedia-test/test.db "PRAGMA journal_mode;"` returns `wal` (if sqlite3 CLI available; otherwise skip)
    - Clean up temp files after verification
  </verify>
  <done>
    Database plugin registers db on Fastify instance via fastify-plugin. Migrations run automatically on startup. WAL mode and performance pragmas are set. Database connection closes on server shutdown. Server starts successfully with automatic database creation.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` -- compiles including new db/ and plugins/ directories
2. `npm run check` -- Biome passes on all files
3. `npx drizzle-kit generate` -- generates migrations without errors (idempotent if no schema changes)
4. Server startup creates database file and applies migrations automatically
5. Database file persists app_metadata table with correct schema
</verification>

<success_criteria>
- SQLite database created automatically at configured path on first run
- Migrations applied on startup without manual intervention
- WAL mode enabled for concurrent read performance
- Database accessible via fastify.db in route handlers and plugins
- Graceful shutdown closes database connection
- Drizzle Kit generate works for future schema changes
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
