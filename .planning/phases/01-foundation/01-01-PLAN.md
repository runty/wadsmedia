---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - biome.json
  - vitest.config.ts
  - src/index.ts
  - src/server.ts
  - src/config.ts
  - .env.example
  - .gitignore
autonomous: true

must_haves:
  truths:
    - "npm run build compiles TypeScript to dist/ without errors"
    - "npm run check passes Biome linting and formatting with zero errors"
    - "npm run dev starts the Fastify server on port 3000 and logs startup"
    - "Environment variables are validated on startup with clear error messages for invalid values"
  artifacts:
    - path: "package.json"
      provides: "Project manifest with type:module, scripts, dependencies"
      contains: '"type": "module"'
    - path: "tsconfig.json"
      provides: "TypeScript config extending @tsconfig/node22"
      contains: "@tsconfig/node22"
    - path: "biome.json"
      provides: "Biome linter and formatter config"
      contains: "biomejs.dev"
    - path: "src/config.ts"
      provides: "Zod v4 env var validation with typed config export"
      exports: ["loadConfig", "AppConfig"]
    - path: "src/server.ts"
      provides: "Fastify factory function with Pino logger config"
      exports: ["buildServer"]
    - path: "src/index.ts"
      provides: "Application entry point"
      min_lines: 5
  key_links:
    - from: "src/index.ts"
      to: "src/config.ts"
      via: "loadConfig() call"
      pattern: "loadConfig"
    - from: "src/index.ts"
      to: "src/server.ts"
      via: "buildServer(config) call"
      pattern: "buildServer"
    - from: "src/server.ts"
      to: "src/config.ts"
      via: "AppConfig type import"
      pattern: "AppConfig"
---

<objective>
Scaffold the WadsMedia Node.js/TypeScript project with strict ESM configuration, install all dependencies, configure tooling (TypeScript, Biome, Vitest), create the Zod-validated configuration module, and build the Fastify server factory with structured Pino logging.

Purpose: Establish the project skeleton that all subsequent plans and phases build upon. Correct ESM + TypeScript configuration at this stage prevents painful debugging later.
Output: A buildable, lintable, runnable Fastify server with validated env config and structured JSON logging.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize project, install dependencies, configure tooling</name>
  <files>
    package.json
    tsconfig.json
    biome.json
    vitest.config.ts
    .gitignore
    .env.example
  </files>
  <action>
    1. Run `npm init -y` in the project root, then update package.json:
       - Set `"name": "wadsmedia"`, `"version": "0.1.0"`, `"type": "module"`
       - Add `"engines": { "node": ">=22" }`
       - Add scripts: `dev`, `build`, `start`, `check`, `check:fix`, `test`, `test:run`, `db:generate`, `db:migrate`, `db:push`, `db:studio` (exact scripts from research)

    2. Install core dependencies:
       ```
       npm install fastify better-sqlite3 drizzle-orm zod
       ```
       Do NOT install pino directly -- Fastify bundles its own Pino version.

    3. Install dev dependencies:
       ```
       npm install -D typescript tsx vitest @biomejs/biome drizzle-kit pino-pretty fastify-plugin @tsconfig/node22 @types/better-sqlite3 @types/node
       ```

    4. Create tsconfig.json extending @tsconfig/node22:
       - `outDir: "./dist"`, `rootDir: "./src"`
       - `declaration: true`, `declarationMap: true`, `sourceMap: true`
       - `strict: true`, `noUncheckedIndexedAccess: true`
       - `resolveJsonModule: true`, `isolatedModules: true`, `verbatimModuleSyntax: true`
       - include: `["src/**/*.ts"]`, exclude: `["node_modules", "dist", "drizzle"]`

    5. Create biome.json with schema version matching installed version:
       - organizeImports enabled, linter enabled with recommended rules
       - formatter: space indent, width 2, line width 100
       - ignore: dist/, drizzle/, node_modules/

    6. Create vitest.config.ts with minimal config:
       ```typescript
       import { defineConfig } from 'vitest/config';
       export default defineConfig({ test: { globals: true } });
       ```

    7. Create .gitignore with: node_modules/, dist/, drizzle/, *.db, *.db-wal, *.db-shm, .env, /data/

    8. Create .env.example with all documented environment variables (from research), future-phase vars commented out.

    CRITICAL ESM NOTE: All .ts files must use .js extensions in relative imports (e.g., `import { x } from './config.js'`). This is required by moduleResolution "nodenext" and WILL cause runtime errors if omitted.
  </action>
  <verify>
    - `npm run build` completes without errors (tsc compiles successfully)
    - `npm run check` passes with zero lint/format errors
    - `ls dist/` shows compiled .js files
  </verify>
  <done>
    package.json exists with type:module and all scripts. tsconfig.json compiles. biome.json lints cleanly. All dependencies installed in node_modules.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create config module, server factory, and entry point</name>
  <files>
    src/config.ts
    src/server.ts
    src/index.ts
  </files>
  <action>
    1. Create src/config.ts:
       - Define Zod v4 schema for ALL env vars (PORT, HOST, NODE_ENV, DATABASE_PATH as required with defaults; Twilio, LLM, Sonarr, Radarr, Users as .optional())
       - PHONE_WHITELIST uses `.transform(val => val.split(','))` piped to `z.array(z.string().min(1)).optional()`
       - PORT uses `z.coerce.number().default(3000)`
       - Export `loadConfig()` function using `envSchema.safeParse(process.env)`. On failure, log each `result.error.issues` item (Zod v4 uses `.issues` not `.errors`) and `process.exit(1)`.
       - Export `AppConfig` type via `z.infer<typeof envSchema>`

    2. Create src/server.ts:
       - Import `AppConfig` from `'./config.js'` (note .js extension)
       - Augment Fastify types: `declare module 'fastify' { interface FastifyInstance { config: AppConfig } }`
       - Export `buildServer(config: AppConfig)` async function:
         - Create Fastify instance with logger config: if NODE_ENV=development use pino-pretty transport, otherwise `true` (JSON)
         - Decorate fastify with config: `fastify.decorate('config', config)`
         - Return fastify instance
       - Do NOT register database or health plugins yet (those come in plans 02 and 03)

    3. Create src/index.ts:
       - Import `loadConfig` from `'./config.js'`
       - Import `buildServer` from `'./server.js'`
       - Call `loadConfig()` to get validated config
       - Call `buildServer(config)` to create server
       - Call `server.listen({ port: config.PORT, host: config.HOST })`
       - Wrap listen in try/catch, log error and exit(1) on failure
       - Use top-level await (ESM supports this)

    4. Run `npm run build` to compile
    5. Run `npm run check` and fix any Biome issues
    6. Verify the server starts: `DATABASE_PATH=./test.db npx tsx src/index.ts` -- should log Fastify startup on port 3000 (Ctrl+C to stop). Remove test.db after.
  </action>
  <verify>
    - `npm run build` succeeds
    - `npm run check` passes
    - `DATABASE_PATH=./test.db npx tsx src/index.ts &` starts, then `curl http://localhost:3000/` returns a response (404 is fine, proves server is running). Kill the background process and remove test.db.
    - Setting an invalid PORT value (e.g., `PORT=abc DATABASE_PATH=./test.db npx tsx src/index.ts`) should fail with a validation error message and exit code 1
  </verify>
  <done>
    Config module validates env vars with Zod v4 and exits with clear errors on invalid input. Server factory creates a Fastify instance with structured JSON logging in production and pino-pretty in development. Entry point wires config to server and starts listening. `npm run build` and `npm run check` both pass.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` -- TypeScript compiles to dist/ without errors
2. `npm run check` -- Biome reports zero errors
3. `DATABASE_PATH=./test.db npx tsx src/index.ts` -- server starts on port 3000
4. `PORT=abc DATABASE_PATH=./test.db npx tsx src/index.ts` -- exits with validation error
5. `NODE_ENV=production DATABASE_PATH=./test.db npx tsx src/index.ts` -- logs output as JSON (not pretty-printed)
</verification>

<success_criteria>
- Project compiles, lints, and runs
- Env var validation works with typed config
- Fastify starts with structured logging (JSON in production, pretty in dev)
- All relative imports use .js extensions
- No Pino installed as direct dependency (Fastify manages its own)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
