---
phase: 12-web-admin-dashboard
plan: 03
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/conversation/tools/get-watch-history.ts
  - src/conversation/system-prompt.ts
autonomous: true

must_haves:
  truths:
    - "get_watch_history tool passes the user's plexUserId to tautulli.getHistory() when the user has a linked Plex account"
    - "get_watch_history falls back to global history (no userId filter) when user has no plexUserId linked"
    - "System prompt reflects that per-user watch history is available for linked accounts"
  artifacts:
    - path: "src/conversation/tools/get-watch-history.ts"
      provides: "Watch history tool with per-user Plex filtering"
      contains: "plexUserId"
    - path: "src/conversation/system-prompt.ts"
      provides: "Updated system prompt mentioning per-user watch history"
      contains: "linked Plex"
  key_links:
    - from: "src/conversation/tools/get-watch-history.ts"
      to: "src/db/schema.ts"
      via: "db query to look up user's plexUserId"
      pattern: "plexUserId|plex_user_id"
    - from: "src/conversation/tools/get-watch-history.ts"
      to: "src/media/tautulli/tautulli.client.ts"
      via: "tautulli.getHistory({ userId: plexUserId })"
      pattern: "getHistory.*userId"
---

<objective>
Enable per-user watch history filtering in the get_watch_history tool by looking up the user's plexUserId from the database and passing it to Tautulli queries. Update the system prompt to reflect this capability.

Purpose: Complete the Plex user linking data flow. Phase 12-01 adds the plexUserId column and the admin dashboard can set it. This plan makes the LLM tools actually use it, satisfying PLEX-04's per-user watch history requirement.
Output: get_watch_history tool that automatically filters by the current user's linked Plex account.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-web-admin-dashboard/12-01-SUMMARY.md

Key patterns:
- ToolContext has `db` (BetterSQLite3Database) and `userId` (number) — tool can query DB directly
- tautulli.getHistory() already accepts `userId?: number` parameter for per-user filtering
- Schema will have `plexUserId` column on users table after 12-01 migration
- Prior decision: "Global watch history in Phase 11; per-user filtering deferred to Phase 12"
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add per-user Plex filtering to get_watch_history tool and update system prompt</name>
  <files>
    src/conversation/tools/get-watch-history.ts
    src/conversation/system-prompt.ts
  </files>
  <action>
1. Update `src/conversation/tools/get-watch-history.ts`:

   At the top of the execute function (after the tautulli availability check), look up the current user's plexUserId from the database:

   ```typescript
   import { eq } from "drizzle-orm";
   import { users } from "../../db/schema.js";
   ```

   In the execute function:
   ```typescript
   // Look up the user's linked Plex account for per-user filtering
   let plexUserId: number | undefined;
   if (context.db) {
     const user = context.db
       .select({ plexUserId: users.plexUserId })
       .from(users)
       .where(eq(users.id, context.userId))
       .get();
     if (user?.plexUserId) {
       plexUserId = user.plexUserId;
     }
   }
   ```

   Then pass it to the getHistory call:
   ```typescript
   const history = await context.tautulli.getHistory({
     userId: plexUserId,  // undefined means global history (no filter)
     mediaType: args.mediaType,
     length: args.limit ?? 10,
   });
   ```

   This change is backward-compatible: if the user has no plexUserId linked (null), `plexUserId` remains undefined, and tautulli.getHistory() does not include the user_id param — same behavior as before (global history).

2. Update `src/conversation/system-prompt.ts` — find the watch history guidance section (currently says "Watch history currently shows global Plex activity across all users (per-user filtering will be available after Plex user linking)") and replace it with:

   ```
   - Watch history shows the user's personal Plex watch activity when their account is linked to Plex. If their account is not linked, it shows global Plex activity across all users.
   ```

   This is a one-line change in the system prompt string.
  </action>
  <verify>
    - `npm run build` passes
    - `npm run check` passes
    - `npm run test:run` passes
    - `grep "plexUserId" src/conversation/tools/get-watch-history.ts` confirms per-user lookup
    - `grep "userId: plexUserId" src/conversation/tools/get-watch-history.ts` confirms it's passed to getHistory
    - `grep "linked to Plex" src/conversation/system-prompt.ts` confirms updated prompt
  </verify>
  <done>
    get_watch_history tool queries the user's plexUserId from the database and passes it to tautulli.getHistory() for per-user filtering. Unlinked users fall back to global history. System prompt updated to reflect per-user capability.
  </done>
</task>

</tasks>

<verification>
- `npm run build` passes
- `npm run check` passes
- `npm run test:run` passes
- The get_watch_history tool reads plexUserId from the users table
- The Tautulli getHistory call includes userId when plexUserId is set
- System prompt correctly describes per-user vs global history behavior
</verification>

<success_criteria>
When a user with a linked Plex account asks "what have I been watching", the tool queries only their personal watch history. When a user without a linked account asks, they get global history (existing behavior preserved).
</success_criteria>

<output>
After completion, create `.planning/phases/12-web-admin-dashboard/12-03-SUMMARY.md`
</output>
