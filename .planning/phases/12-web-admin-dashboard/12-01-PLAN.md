---
phase: 12-web-admin-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/config.ts
  - src/db/schema.ts
  - src/admin/admin.plugin.ts
  - src/admin/admin.auth.ts
  - src/admin/admin.routes.ts
  - src/admin/admin.service.ts
  - src/server.ts
  - src/media/sonarr/sonarr.client.ts
  - src/media/radarr/radarr.client.ts
  - Dockerfile
autonomous: true
user_setup:
  - service: admin-dashboard
    why: "Session encryption and login password"
    env_vars:
      - name: ADMIN_SESSION_SECRET
        source: "Generate a random 32+ character string (e.g., openssl rand -hex 32)"
      - name: ADMIN_PASSWORD
        source: "Choose a password for dashboard login"

must_haves:
  truths:
    - "Admin plugin registers under /admin prefix with session auth, view engine, and static files"
    - "Login POST validates ADMIN_PASSWORD and sets encrypted session cookie scoped to /admin"
    - "Unauthenticated requests to /admin/* redirect to /admin/login"
    - "Sonarr and Radarr clients have healthCheck() methods"
    - "users table has a plexUserId column for Plex account linking"
    - "admin.service.ts provides all DB queries needed by dashboard routes"
    - "Dockerfile copies admin-views/ and admin-assets/ to production image"
  artifacts:
    - path: "src/admin/admin.plugin.ts"
      provides: "Fastify plugin registering view, static, session, and admin routes"
      min_lines: 40
    - path: "src/admin/admin.auth.ts"
      provides: "Login/logout handlers and requireAuth preHandler"
      min_lines: 30
    - path: "src/admin/admin.routes.ts"
      provides: "Route handlers for all /admin/* endpoints"
      min_lines: 50
    - path: "src/admin/admin.service.ts"
      provides: "Database query functions for admin dashboard"
      exports: ["getAllUsers", "getUserById", "updateUser", "softDeleteUser", "getUserMessages", "getMediaTrackingStats", "getRecentMediaAdditions", "setPlexUserId"]
    - path: "src/media/sonarr/sonarr.client.ts"
      provides: "SonarrClient with healthCheck()"
      contains: "healthCheck"
    - path: "src/media/radarr/radarr.client.ts"
      provides: "RadarrClient with healthCheck()"
      contains: "healthCheck"
  key_links:
    - from: "src/server.ts"
      to: "src/admin/admin.plugin.ts"
      via: "fastify.register(adminPlugin)"
      pattern: "register.*admin"
    - from: "src/admin/admin.plugin.ts"
      to: "@fastify/view, @fastify/static, @fastify/secure-session"
      via: "fastify.register() calls"
      pattern: "register.*view|register.*Static|register.*secureSession"
    - from: "src/admin/admin.routes.ts"
      to: "src/admin/admin.service.ts"
      via: "service function calls"
      pattern: "getAllUsers|getUserById|updateUser"
---

<objective>
Set up the admin dashboard backend: Fastify plugin infrastructure, session-based auth, admin service layer with all DB queries, schema migration for plexUserId, Sonarr/Radarr healthCheck gap closure, and Dockerfile updates for template/asset files.

Purpose: Establish the complete backend foundation so that plans 12-02 (frontend templates) and 12-03 (stats/Plex linking) can focus purely on UI and feature logic.
Output: Working admin plugin with auth, route stubs that return JSON (full template rendering added in 12-02), all service queries, schema migration, and healthCheck methods.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-web-admin-dashboard/12-RESEARCH.md

Key patterns from existing code:
- Fastify plugins use fp() wrapper from fastify-plugin, declare module augmentation for types
- Config uses Zod schema in src/config.ts with optional fields for services
- DB queries follow src/users/user.service.ts pattern: plain functions taking (db: DB, ...) args
- Schema uses drizzle-orm/sqlite-core; migrations generated by `npm run db:generate`
- Existing healthCheck() on PlexClient/TautulliClient: try/catch around a simple GET, return boolean
- SonarrClient/RadarrClient have private request() helper for typed API calls
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies, config, schema migration, and healthCheck gap closure</name>
  <files>
    package.json
    src/config.ts
    src/db/schema.ts
    src/media/sonarr/sonarr.client.ts
    src/media/radarr/radarr.client.ts
  </files>
  <action>
1. Install new dependencies:
   ```bash
   npm install @fastify/view @fastify/static @fastify/secure-session eta
   ```

2. Add admin env vars to `src/config.ts` Zod schema (both optional -- dashboard is opt-in):
   ```typescript
   ADMIN_SESSION_SECRET: z.string().min(32).optional(),
   ADMIN_PASSWORD: z.string().min(1).optional(),
   ```

3. Add `plexUserId` column to users table in `src/db/schema.ts`:
   ```typescript
   plexUserId: integer("plex_user_id"),  // nullable, Tautulli user_id for per-user watch history
   ```

4. Generate the Drizzle migration:
   ```bash
   npm run db:generate
   ```

5. Add `healthCheck()` method to `SonarrClient` in `src/media/sonarr/sonarr.client.ts`:
   ```typescript
   async healthCheck(): Promise<boolean> {
     try {
       await this.request("system/status", z.object({}).passthrough(), { timeoutMs: 5_000 });
       return true;
     } catch {
       return false;
     }
   }
   ```

6. Add identical `healthCheck()` method to `RadarrClient` in `src/media/radarr/radarr.client.ts`.
  </action>
  <verify>
    - `npm run build` compiles without errors
    - New migration SQL file exists in `drizzle/` with ALTER TABLE adding plex_user_id
    - `grep "healthCheck" src/media/sonarr/sonarr.client.ts src/media/radarr/radarr.client.ts` shows methods in both files
    - `grep "ADMIN_SESSION_SECRET" src/config.ts` confirms config added
  </verify>
  <done>
    Dependencies installed, config extended with ADMIN_SESSION_SECRET and ADMIN_PASSWORD, users table has plexUserId column with migration generated, Sonarr and Radarr clients both have healthCheck() methods matching the Plex/Tautulli pattern.
  </done>
</task>

<task type="auto">
  <name>Task 2: Admin plugin, auth, service layer, routes, server wiring, and Dockerfile</name>
  <files>
    src/admin/admin.plugin.ts
    src/admin/admin.auth.ts
    src/admin/admin.routes.ts
    src/admin/admin.service.ts
    src/server.ts
    Dockerfile
  </files>
  <action>
1. Create `src/admin/admin.service.ts` with database query functions. Follow the pattern in `src/users/user.service.ts` (plain functions, `db: DB` first param). All functions:

   - `getAllUsers(db)` — SELECT all from users ORDER BY createdAt DESC
   - `getUserById(db, id: number)` — SELECT * WHERE id = ?
   - `updateUser(db, id: number, fields: { displayName?: string; isAdmin?: boolean; status?: string })` — partial update with updatedAt = new Date()
   - `softDeleteUser(db, id: number)` — UPDATE status = "blocked", updatedAt = new Date() (preserve audit trail, do NOT cascade delete)
   - `getUserMessages(db, userId: number, opts?: { limit?: number; offset?: number })` — SELECT from messages WHERE userId = ? ORDER BY createdAt ASC, with default limit 100. Return raw rows (role, content, toolCalls, toolCallId, name, createdAt).
   - `getMediaTrackingStats(db)` — Return object with: totalRequests (count media_tracking), last7Days (count WHERE addedAt > 7 days ago), byMediaType (group by mediaType, count each)
   - `getRecentMediaAdditions(db, limit = 10)` — SELECT from media_tracking JOIN users ON userId ORDER BY addedAt DESC LIMIT ?, return title, year, mediaType, user displayName/phone, addedAt
   - `setPlexUserId(db, userId: number, plexUserId: number | null)` — UPDATE users SET plex_user_id = ?, updatedAt = new Date() WHERE id = ?

   Use `import { eq, desc, asc, sql, count, and, gte } from "drizzle-orm"` as needed. Import `users`, `messages`, `mediaTracking` from schema.

2. Create `src/admin/admin.auth.ts` with:

   - `requireAuth` preHandler function: checks `request.session.get("adminUserId")`. If missing: for htmx requests (check `hx-request` header), return `reply.header("HX-Redirect", "/admin/login").code(200).send()`; for browser requests, return `reply.redirect("/admin/login")`.
   - `loginHandler(fastify)` — POST /admin/login: parse body `{ password }`, validate against `fastify.config.ADMIN_PASSWORD`. On success, set `request.session.set("adminUserId", "admin")` and redirect to `/admin`. On failure, return the login template with an error message. For now (before templates exist in 12-02), return JSON `{ error: "Invalid password" }` with 401, or redirect 302 on success.
   - `logoutHandler` — POST /admin/logout: `request.session.delete()`, redirect to `/admin/login`.

3. Create `src/admin/admin.routes.ts` as an async Fastify plugin function (NOT wrapped in fp() — routes should be encapsulated within admin scope). Register all route handlers:

   - GET /admin → dashboard home (will render template in 12-02, for now return `reply.viewAsync("pages/dashboard", { ... })`)
   - GET /admin/login → login page
   - POST /admin/login → loginHandler
   - POST /admin/logout → logoutHandler
   - GET /admin/users → user list page
   - GET /admin/api/users/:id → user detail (htmx partial or full page)
   - POST /admin/api/users/:id → update user fields
   - POST /admin/api/users/:id/delete → soft delete user
   - GET /admin/api/users/:id/messages → chat history (htmx partial)
   - GET /admin/api/health → system health JSON (used by htmx polling)
   - GET /admin/api/stats → media tracking stats JSON
   - GET /admin/api/plex-users → list Tautulli users for linking dropdown
   - POST /admin/api/users/:id/link-plex → set plexUserId

   Apply `{ preHandler: [requireAuth] }` on ALL routes except GET /admin/login and POST /admin/login.

   Each route handler calls the appropriate admin.service function. For template rendering: use `reply.viewAsync("pages/pagename", { data })` for full page loads and `reply.viewAsync("partials/partialname", { data })` when `request.headers["hx-request"] === "true"`. Since templates don't exist yet (12-02 creates them), routes will fail at runtime until 12-02 runs — that's expected. The route structure and data flow are what matter here.

   For health endpoint: use `Promise.allSettled()` to call healthCheck() on sonarr, radarr, plex, tautulli (all optional on fastify instance). Return `{ sonarr: { configured, healthy }, radarr: { configured, healthy }, plex: { configured, healthy }, tautulli: { configured, healthy } }`.

   For plex-users endpoint: call `fastify.tautulli?.getUsers()` — return 404 if tautulli not configured.

4. Create `src/admin/admin.plugin.ts`:

   ```typescript
   import path from "node:path";
   import fastifyStatic from "@fastify/static";
   import secureSession from "@fastify/secure-session";
   import view from "@fastify/view";
   import { Eta } from "eta";
   import fp from "fastify-plugin";
   import adminRoutes from "./admin.routes.js";
   ```

   Register as fp() plugin (to access fastify.config, fastify.db, etc. from parent scope):
   - Guard: if `!fastify.config.ADMIN_SESSION_SECRET || !fastify.config.ADMIN_PASSWORD`, log warning "Admin dashboard not configured" and return early.
   - Register `@fastify/view` with Eta engine. Use `path.join(process.cwd(), "admin-views")` for template root (works in both dev via tsx and production Docker). Set `viewExt: "eta"`.
   - Register `@fastify/static` with root `path.join(process.cwd(), "admin-assets")`, prefix `/admin/assets/`, and `decorateReply: false` (avoid conflict with any other @fastify/static registration).
   - Register `@fastify/secure-session` with: secret from `fastify.config.ADMIN_SESSION_SECRET`, salt `"wadsmedia-admin!"` (exactly 16 bytes), cookie path `/admin`, httpOnly true, sameSite `"lax"`, maxAge 86400 (24h).
   - Register adminRoutes with prefix `/admin`.
   - Plugin name: `"admin-dashboard"`, dependencies: `["database"]`.

5. Wire into `src/server.ts`:
   - Import adminPlugin from `./admin/admin.plugin.js`
   - Register it AFTER notificationsPlugin (last in chain): `await fastify.register(adminPlugin);`

6. Update `Dockerfile` production stage — after the existing `COPY drizzle/ ./drizzle/` line, add:
   ```dockerfile
   # Copy admin dashboard templates and static assets
   COPY src/admin-views/ ./admin-views/
   COPY src/admin-assets/ ./admin-assets/
   ```
   These directories will be populated by plan 12-02. The COPY lines won't fail Docker build if the directories don't exist in the build context, but they need to be present when 12-02's assets are added. To prevent Docker build failure before 12-02 runs, create empty placeholder directories:
   ```bash
   mkdir -p src/admin-views src/admin-assets
   touch src/admin-views/.gitkeep src/admin-assets/.gitkeep
   ```
  </action>
  <verify>
    - `npm run build` compiles without errors (TypeScript type checks pass)
    - `ls src/admin/` shows admin.plugin.ts, admin.auth.ts, admin.routes.ts, admin.service.ts
    - `grep "admin-dashboard" src/admin/admin.plugin.ts` confirms plugin name
    - `grep "adminPlugin" src/server.ts` confirms wiring
    - `grep "admin-views" Dockerfile` confirms COPY lines
    - `ls src/admin-views/.gitkeep src/admin-assets/.gitkeep` confirms placeholder dirs exist
  </verify>
  <done>
    Admin plugin fully wired: auth (session + password), service layer (8 query functions), routes (14 endpoints), plugin infrastructure (view/static/session), server registration, and Dockerfile updated. Templates don't exist yet (12-02) but the backend is ready to render them.
  </done>
</task>

</tasks>

<verification>
- `npm run build` passes (all TypeScript compiles)
- `npm run check` passes (Biome linting)
- `npm run test:run` passes (no regressions)
- All 4 clients (Sonarr, Radarr, Plex, Tautulli) have healthCheck() methods
- Schema migration exists for plexUserId column
- Admin plugin conditionally registers (only when ADMIN_SESSION_SECRET + ADMIN_PASSWORD are set)
- 14 route handlers defined covering all dashboard functionality
- Service layer has 8 query functions
</verification>

<success_criteria>
The admin dashboard backend is fully operational: plugin infrastructure with auth, a complete service layer, route handlers for every dashboard feature, schema migration for Plex linking, and healthCheck methods on all 4 media clients. Server starts cleanly without admin env vars (plugin skipped) and with them (plugin registers, routes functional but templates missing until 12-02).
</success_criteria>

<output>
After completion, create `.planning/phases/12-web-admin-dashboard/12-01-SUMMARY.md`
</output>
