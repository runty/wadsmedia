---
phase: 12-web-admin-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/admin-views/layouts/main.eta
  - src/admin-views/pages/login.eta
  - src/admin-views/pages/dashboard.eta
  - src/admin-views/pages/users.eta
  - src/admin-views/pages/user-detail.eta
  - src/admin-views/partials/user-row.eta
  - src/admin-views/partials/user-edit-form.eta
  - src/admin-views/partials/chat-messages.eta
  - src/admin-views/partials/health-status.eta
  - src/admin-views/partials/stats-cards.eta
  - src/admin-assets/style.css
  - src/admin-assets/htmx.min.js
autonomous: false

must_haves:
  truths:
    - "Admin can visit /admin/login, enter the password, and be redirected to /admin"
    - "Admin can see a list of all users with name, phone, status, and admin badge"
    - "Admin can click Edit on a user row and toggle admin status or change display name inline"
    - "Admin can soft-delete a user with a confirmation"
    - "Admin can click a user to see their full chat history with user/assistant messages displayed as conversation bubbles"
    - "Tool call messages in chat history are collapsed into expandable summaries"
    - "Dashboard home shows system health indicators and media request stats"
  artifacts:
    - path: "src/admin-views/layouts/main.eta"
      provides: "Base HTML layout with nav, htmx script, and CSS"
      min_lines: 25
    - path: "src/admin-views/pages/login.eta"
      provides: "Login form page"
      min_lines: 15
    - path: "src/admin-views/pages/users.eta"
      provides: "User list table with htmx edit/delete actions"
      min_lines: 20
    - path: "src/admin-views/pages/user-detail.eta"
      provides: "User detail with chat history and Plex linking"
      min_lines: 30
    - path: "src/admin-views/pages/dashboard.eta"
      provides: "Dashboard home with stats and health"
      min_lines: 20
    - path: "src/admin-assets/style.css"
      provides: "Dashboard CSS styling"
      min_lines: 100
    - path: "src/admin-assets/htmx.min.js"
      provides: "htmx 2.0.8 vendored library"
  key_links:
    - from: "src/admin-views/pages/users.eta"
      to: "/admin/api/users/:id/edit"
      via: "hx-get on Edit button"
      pattern: "hx-get.*users.*edit"
    - from: "src/admin-views/partials/user-edit-form.eta"
      to: "/admin/api/users/:id"
      via: "hx-post on form submit"
      pattern: "hx-post.*users"
    - from: "src/admin-views/pages/user-detail.eta"
      to: "/admin/api/users/:id/messages"
      via: "hx-get for chat history lazy load"
      pattern: "hx-get.*messages"
    - from: "src/admin-views/pages/dashboard.eta"
      to: "/admin/api/health"
      via: "hx-get with polling trigger"
      pattern: "hx-get.*health.*trigger.*every"
---

<objective>
Create all Eta templates, static assets (htmx.min.js, CSS), and htmx-powered UI for the admin dashboard. This plan builds the visual layer on top of the backend API from 12-01.

Purpose: Deliver the complete admin UI for user management (list, edit, delete) and chat history viewing, satisfying requirements ADMN-04 and ADMN-05.
Output: Fully functional dashboard pages rendered by the existing Fastify routes from 12-01, plus vendored htmx.min.js and a custom stylesheet.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-web-admin-dashboard/12-RESEARCH.md
@.planning/phases/12-web-admin-dashboard/12-01-SUMMARY.md

Key references from research:
- Eta template syntax: `<%= it.var %>` for escaped output, `<%~ it.body %>` for raw HTML (layout body)
- htmx attributes: hx-get, hx-post, hx-target, hx-swap, hx-trigger, hx-confirm
- Layout pattern: main.eta wraps pages, `<%~ it.body %>` is the content slot
- @fastify/view with Eta uses `reply.viewAsync("pages/pagename", { data })` — path relative to views root, no extension needed
- Chat messages have roles: user, assistant, tool, system. tool messages have toolCallId linking back to assistant's toolCalls JSON.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Vendor htmx, create CSS, and build all Eta templates</name>
  <files>
    src/admin-assets/htmx.min.js
    src/admin-assets/style.css
    src/admin-views/layouts/main.eta
    src/admin-views/pages/login.eta
    src/admin-views/pages/dashboard.eta
    src/admin-views/pages/users.eta
    src/admin-views/pages/user-detail.eta
    src/admin-views/partials/user-row.eta
    src/admin-views/partials/user-edit-form.eta
    src/admin-views/partials/chat-messages.eta
    src/admin-views/partials/health-status.eta
    src/admin-views/partials/stats-cards.eta
  </files>
  <action>
1. **Vendor htmx 2.0.8:** Download htmx.min.js from `https://unpkg.com/htmx.org@2.0.8/dist/htmx.min.js` and save to `src/admin-assets/htmx.min.js`. Use curl or fetch. Do NOT use a CDN link in templates — vendor it for offline/private network use.

2. **Create `src/admin-assets/style.css`** — a clean, functional admin dashboard stylesheet. No CSS framework (keep it minimal). Key styles needed:

   - Body: system font stack, light gray background (#f5f5f5), dark text
   - Nav: dark sidebar or top bar with links to Dashboard, Users. Show "WadsMedia Admin" branding. Logout button.
   - Cards: white background, subtle shadow, rounded corners, padding. Used for stats and health indicators.
   - Tables: clean borders, alternating row colors, responsive horizontal scroll on mobile
   - Forms: styled inputs, buttons with hover states. Primary button (blue), danger button (red).
   - Chat bubbles: user messages right-aligned (blue-ish), assistant messages left-aligned (gray). Tool calls: collapsed by default, expandable `<details>` element with monospace JSON.
   - Status badges: green for healthy/active, red for unhealthy/blocked, yellow for pending
   - Flash messages: error (red border) and success (green border) banners
   - Responsive: stack sidebar below content on mobile (max-width: 768px)
   - htmx loading indicator: `.htmx-indicator` class for spinners during requests

3. **Create `src/admin-views/layouts/main.eta`** — base HTML layout:
   ```html
   <!DOCTYPE html>
   <html lang="en">
   <head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <title><%= it.title ? it.title + " - " : "" %>WadsMedia Admin</title>
     <link rel="stylesheet" href="/admin/assets/style.css">
     <script src="/admin/assets/htmx.min.js"></script>
   </head>
   <body>
     <nav><!-- Navigation: Dashboard, Users, Logout (POST /admin/logout via htmx) --></nav>
     <main><%~ it.body %></main>
   </body>
   </html>
   ```
   Nav should have links to `/admin` (Dashboard) and `/admin/users` (Users). Logout should be a form/button that POSTs to `/admin/logout`.

4. **Create `src/admin-views/pages/login.eta`** — standalone page (NO layout wrapper, login has its own minimal structure):
   - Centered card with "WadsMedia Admin" heading
   - Password input field (type="password", name="password")
   - Submit button "Log In"
   - If `it.error` is set, show error message (red banner above form)
   - Form POSTs to `/admin/login` (standard form submit, not htmx)

5. **Create `src/admin-views/pages/dashboard.eta`** — uses main layout:
   - Section 1: Stats cards (rendered by `partials/stats-cards.eta` include or inline)
     - Total media requests (count)
     - Last 7 days requests
     - Movies added / Series added breakdown
   - Section 2: System health (rendered by `partials/health-status.eta`)
     - 4 service cards: Sonarr, Radarr, Plex, Tautulli
     - Each shows: configured (yes/no), healthy (green dot / red dot)
     - Health auto-refreshes via htmx: `hx-get="/admin/api/health" hx-trigger="every 60s" hx-target="#health-panel" hx-swap="innerHTML"`
   - Section 3: Recent additions table (last 10 media items added)
     - Title, year, type (movie/series), added by (user name), date
   - Data comes from route handler: `{ stats, health, recentAdditions }`

6. **Create `src/admin-views/pages/users.eta`** — uses main layout:
   - Table with columns: Name, Phone, Status, Admin, Actions
   - Each row uses `partials/user-row.eta` pattern (or inline loop)
   - For each user: display displayName (or "-" if null), phone, status badge (green/yellow/red), admin badge (yes/no)
   - Actions column: "Edit" button (`hx-get="/admin/api/users/<%= user.id %>" hx-target="#user-<%= user.id %>" hx-swap="outerHTML"`) and "Delete" button (`hx-post="/admin/api/users/<%= user.id %>/delete" hx-confirm="Are you sure you want to remove this user?" hx-target="#user-<%= user.id %>" hx-swap="outerHTML"`)
   - Each row has `id="user-<%= user.id %>"` for htmx targeting
   - "View Chat" link on each user row navigates to `/admin/users/<%= user.id %>` (full page navigation, not htmx)
   - Data: `{ users }` array

7. **Create `src/admin-views/partials/user-row.eta`** — single table row for a user:
   - TR with id="user-{id}"
   - Cells: displayName, phone, status badge, admin badge, actions (Edit, Delete, View Chat link)
   - Used for htmx swap responses when editing/deleting

8. **Create `src/admin-views/partials/user-edit-form.eta`** — inline edit form that replaces a user row:
   - TR with form inputs for displayName (text), isAdmin (checkbox), status (select: active/pending/blocked)
   - Save button: `hx-post="/admin/api/users/<%= it.user.id %>" hx-target="#user-<%= it.user.id %>" hx-swap="outerHTML"` — server returns the updated `user-row.eta` partial
   - Cancel button: `hx-get="/admin/api/users/<%= it.user.id %>" hx-target="#user-<%= it.user.id %>" hx-swap="outerHTML"` — restores the read-only row

9. **Create `src/admin-views/pages/user-detail.eta`** — uses main layout:
   - Top: User info card (name, phone, status, admin, createdAt)
   - If Plex linking available (tautulli configured): Plex linking section with dropdown of Tautulli users and "Link" button. If already linked, show linked Plex username with "Unlink" button.
   - Bottom: Chat history section
     - Lazy-loaded via htmx: `<div hx-get="/admin/api/users/<%= it.user.id %>/messages" hx-trigger="revealed" hx-swap="innerHTML">Loading chat history...</div>`
   - Data: `{ user, plexUsers (optional), linkedPlexUser (optional) }`

10. **Create `src/admin-views/partials/chat-messages.eta`** — chat history display:
    - Loop over `it.messages` array
    - For each message based on role:
      - `user`: right-aligned blue bubble with content text, timestamp below
      - `assistant`: left-aligned gray bubble with content text, timestamp below
      - `tool`: collapsed inside a `<details>` element with summary "Tool: {name}" showing the tool call ID. The content shows the tool result (content field). Style in monospace.
      - `system`: skip (don't display system messages)
    - Group consecutive tool messages under their parent assistant message's tool_calls for cleaner display. The assistant message's toolCalls JSON contains `[{ id, function: { name, arguments } }]`. Show these as "Called: {name}({args summary})" before their results.
    - If no messages: show "No chat history for this user."
    - Handle pagination: if `it.hasMore`, show a "Load more" button with `hx-get="/admin/api/users/<%= it.userId %>/messages?offset=<%= it.nextOffset %>" hx-target="this" hx-swap="outerHTML"`

11. **Create `src/admin-views/partials/health-status.eta`** — health indicator cards:
    - 4 cards in a grid for Sonarr, Radarr, Plex, Tautulli
    - Each card: service name, configured badge, healthy indicator (green/red dot with "Healthy"/"Unreachable" text)
    - If not configured: show "Not Configured" in gray
    - Data: `{ sonarr: { configured, healthy }, radarr: ..., plex: ..., tautulli: ... }`

12. **Create `src/admin-views/partials/stats-cards.eta`** — stats display:
    - Cards showing: totalRequests, last7Days, movies count, series count
    - Data: `{ totalRequests, last7Days, byMediaType: { movie, series } }`

13. **Update admin route handlers in `src/admin/admin.routes.ts`** to properly pass template data. The routes from 12-01 should already call `reply.viewAsync()` — verify they pass the correct data objects matching what templates expect. Adjust if needed:
    - GET /admin → pass `{ stats, health, recentAdditions }` to "pages/dashboard"
    - GET /admin/login → render "pages/login" with `{ error: null }` (no layout)
    - GET /admin/users → pass `{ users }` to "pages/users"
    - GET /admin/users/:id → pass `{ user, plexUsers, linkedPlexUser }` to "pages/user-detail" (full page) or partials for htmx
    - GET /admin/api/users/:id → return "partials/user-row" or "partials/user-edit-form" based on query param `?edit=true`
    - POST /admin/api/users/:id → update user, return "partials/user-row" with updated user
    - POST /admin/api/users/:id/delete → soft delete, return empty TR or removal indicator
    - GET /admin/api/users/:id/messages → return "partials/chat-messages" with messages and pagination data
    - GET /admin/api/health → return "partials/health-status" for htmx, or JSON for non-htmx
    - GET /admin/api/stats → return "partials/stats-cards" for htmx, or JSON for non-htmx

   For the login page, since it should NOT use the layout, use `reply.viewAsync("pages/login", { error: null })` and have the login.eta be a complete HTML document itself (not using `<%~ it.body %>`).

14. Remove the `.gitkeep` placeholder files from `src/admin-views/` and `src/admin-assets/` (real files now exist).
  </action>
  <verify>
    - `npm run build` passes
    - `ls src/admin-assets/htmx.min.js src/admin-assets/style.css` confirms static assets
    - `ls src/admin-views/layouts/main.eta src/admin-views/pages/login.eta src/admin-views/pages/dashboard.eta src/admin-views/pages/users.eta src/admin-views/pages/user-detail.eta` confirms all page templates
    - `ls src/admin-views/partials/` shows user-row.eta, user-edit-form.eta, chat-messages.eta, health-status.eta, stats-cards.eta
    - `grep "hx-get\|hx-post\|hx-target" src/admin-views/pages/users.eta` confirms htmx attributes present
    - `grep "hx-trigger.*every" src/admin-views/pages/dashboard.eta` confirms health auto-refresh polling
  </verify>
  <done>
    All Eta templates created: login, dashboard, users list, user detail, and 5 partials for htmx swaps. htmx 2.0.8 vendored. CSS stylesheet provides clean admin look. Route handlers updated to pass correct template data. Admin can log in, view users, edit inline, soft-delete, and read chat history with tool calls collapsed.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify dashboard UI end-to-end</name>
  <files>None -- verification only</files>
  <action>
    Human verification of complete admin dashboard: login flow, user management (list, edit, delete), chat history viewer with collapsed tool calls, dashboard stats, and health monitoring indicators. All powered by htmx partial responses with Eta templates.
  </action>
  <verify>
    1. Set env vars: `ADMIN_SESSION_SECRET` (32+ chars) and `ADMIN_PASSWORD` (any value)
    2. Start dev server: `npm run dev`
    3. Open browser to `http://localhost:3000/admin` — should redirect to `/admin/login`
    4. Enter the ADMIN_PASSWORD — should redirect to `/admin` (dashboard home)
    5. Click "Users" in nav — should see user list with edit/delete actions
    6. Click "Edit" on a user row — should see inline form replacing the row
    7. Toggle admin checkbox and save — should see updated row
    8. Click "View Chat" on a user — should see their chat history with messages
    9. Verify tool call messages are collapsed in `<details>` elements
    10. Return to dashboard — verify health indicators and stats cards display
    11. Click "Logout" — should return to login page
  </verify>
  <done>
    Admin can log in, manage users (view, edit inline, soft-delete), read any user's chat history with tool calls collapsed, see system health and media request stats on the dashboard, and log out. All interactions work via htmx without full page reloads (except initial navigation).
  </done>
</task>

</tasks>

<verification>
- `npm run build` passes
- `npm run check` passes
- All templates render without Eta syntax errors
- Login flow works (password validation, session cookie, redirect)
- User list displays all users from database
- Inline edit (htmx) updates user and refreshes row
- Soft delete removes user from visible list
- Chat history loads with user/assistant bubbles and collapsed tool calls
- Health indicators show configured/healthy status for each service
- Stats cards show request counts
- Logout clears session and redirects to login
</verification>

<success_criteria>
Admin can log in via /admin/login, see the dashboard with stats and health, navigate to user management, edit users inline via htmx, soft-delete users, and view any user's full chat history with tool calls properly collapsed. The UI is clean and functional with a custom CSS stylesheet and vendored htmx.
</success_criteria>

<output>
After completion, create `.planning/phases/12-web-admin-dashboard/12-02-SUMMARY.md`
</output>
