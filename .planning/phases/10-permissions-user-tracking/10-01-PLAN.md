---
phase: 10-permissions-user-tracking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/conversation/types.ts
  - src/conversation/tools.ts
  - src/conversation/tool-loop.ts
  - src/conversation/engine.ts
  - src/plugins/webhook.ts
  - src/conversation/tools/remove-movie.ts
  - src/conversation/tools/remove-series.ts
  - src/conversation/system-prompt.ts
  - src/db/schema.ts
  - src/users/media-tracking.ts
  - src/conversation/tools/add-movie.ts
  - src/conversation/tools/add-series.ts
autonomous: true

must_haves:
  truths:
    - "Non-admin user calling remove_movie or remove_series gets a 'Permission denied' tool error (never reaches execution or destructive confirmation)"
    - "Admin user calling remove_movie or remove_series goes through normal destructive confirmation flow unchanged"
    - "Non-admin user adding a movie or series triggers an SMS to ADMIN_PHONE with who added what"
    - "Admin user adding media does NOT trigger a notification"
    - "Every successful add (movie or series) inserts a row into media_tracking with userId, mediaType, title, year, externalId, and timestamp"
    - "Existing tools without explicit requiredRole continue to work (safe default of 'any')"
  artifacts:
    - path: "src/conversation/types.ts"
      provides: "RequiredRole type, requiredRole on ToolDefinition, isAdmin/displayName/userPhone/messaging/db on ToolContext"
      contains: "requiredRole"
    - path: "src/conversation/tools.ts"
      provides: "requiredRole parameter on defineTool with 'any' default"
      contains: "requiredRole"
    - path: "src/conversation/tool-loop.ts"
      provides: "Permission check between validation and destructive check"
      contains: "Permission denied"
    - path: "src/db/schema.ts"
      provides: "media_tracking table definition"
      contains: "media_tracking"
    - path: "src/users/media-tracking.ts"
      provides: "insertMediaTracking function"
      exports: ["insertMediaTracking"]
    - path: "drizzle/"
      provides: "Migration SQL for media_tracking table"
  key_links:
    - from: "src/conversation/tool-loop.ts"
      to: "src/conversation/types.ts"
      via: "tool.requiredRole check against context.isAdmin"
      pattern: "tool\\.requiredRole.*admin.*context\\.isAdmin"
    - from: "src/plugins/webhook.ts"
      to: "src/conversation/engine.ts"
      via: "isAdmin passed from user object into processConversation"
      pattern: "isAdmin.*user\\.isAdmin"
    - from: "src/conversation/tools/add-movie.ts"
      to: "src/users/media-tracking.ts"
      via: "insertMediaTracking called after successful add"
      pattern: "insertMediaTracking"
    - from: "src/conversation/tools/add-series.ts"
      to: "src/users/media-tracking.ts"
      via: "insertMediaTracking called after successful add"
      pattern: "insertMediaTracking"
    - from: "src/conversation/tools/add-movie.ts"
      to: "src/messaging/types.ts"
      via: "context.messaging.send for admin notification"
      pattern: "context\\.messaging\\.send"
---

<objective>
Add role-based permission enforcement, per-user media tracking, and admin notification to the WadsMedia conversation engine.

Purpose: Non-admin users must be blocked from destructive actions at the code level (not just system prompt guidance), every media addition must be tracked for Phase 12 dashboard consumption, and admins must receive SMS when non-admin users add media.

Output: Extended type system with requiredRole, centralized permission guard in tool-loop.ts, media_tracking database table with Drizzle migration, tracking inserts in add tools, fire-and-forget admin SMS notifications, and system prompt permission awareness.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-permissions-user-tracking/10-RESEARCH.md
@src/conversation/types.ts
@src/conversation/tools.ts
@src/conversation/tool-loop.ts
@src/conversation/engine.ts
@src/plugins/webhook.ts
@src/db/schema.ts
@src/conversation/tools/add-movie.ts
@src/conversation/tools/add-series.ts
@src/conversation/tools/remove-movie.ts
@src/conversation/tools/remove-series.ts
@src/conversation/system-prompt.ts
@src/users/user.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Permission guard infrastructure with requiredRole enforcement</name>
  <files>
    src/conversation/types.ts
    src/conversation/tools.ts
    src/conversation/tool-loop.ts
    src/conversation/engine.ts
    src/plugins/webhook.ts
    src/conversation/tools/remove-movie.ts
    src/conversation/tools/remove-series.ts
    src/conversation/system-prompt.ts
  </files>
  <action>
**1. Extend types.ts (src/conversation/types.ts):**
- Add `export type RequiredRole = 'admin' | 'any';` after the ConfirmationTier type (line 23).
- Add `requiredRole: RequiredRole;` to the ToolDefinition interface (after `tier`).
- Add these fields to ToolContext interface (after `userId: number`):
  ```
  isAdmin: boolean;
  displayName: string | null;
  userPhone: string;
  messaging?: import("../messaging/types.js").MessagingProvider;
  db?: import("drizzle-orm/better-sqlite3").BetterSQLite3Database<typeof import("../db/schema.js")>;
  ```

**2. Extend defineTool() (src/conversation/tools.ts):**
- Import `RequiredRole` type from `./types.js`.
- Add `requiredRole: RequiredRole = 'any'` as the LAST parameter of `defineTool()` (after `execute`). This makes it optional with a safe default so existing tool definitions do NOT need changes.
- Include `requiredRole` in the returned object alongside `tier`, `paramSchema`, `execute`.

**3. Inject permission check in tool-loop.ts (src/conversation/tool-loop.ts):**
- After line 101 (the `continue;` closing the Zod validation failure block) and BEFORE line 104 (the destructive tier check `if (registry.isDestructive(...))`), insert:
  ```typescript
  // Permission check: block non-admins from admin-only tools
  if (tool.requiredRole === 'admin' && !context.isAdmin) {
    messages.push({
      role: 'tool',
      tool_call_id: toolCall.id,
      content: JSON.stringify({
        error: 'Permission denied. Only admins can perform this action. You can search, add, and view media, but removing requires admin access.',
      }),
    });
    continue;
  }
  ```
  CRITICAL: This MUST come BEFORE the destructive check. Non-admin users must never see the "Are you sure?" confirmation prompt for actions they cannot perform.

**4. Wire isAdmin through engine.ts (src/conversation/engine.ts):**
- Add `isAdmin: boolean;` to `ProcessConversationParams` interface.
- Destructure `isAdmin` from params alongside other fields.
- Update the ToolContext at the main flow (line 168, the `context: { sonarr, radarr, ... }` object) to include: `isAdmin, displayName, userPhone, messaging, db`.
- ALSO update the confirmation-flow ToolContext (line 95, inside the `if (isConfirmation(messageBody))` block where `tool.execute(parsedArgs, { ... })` is called) to include all the same fields: `isAdmin, displayName, userPhone, messaging, db`. This is defense-in-depth -- both context construction sites must be consistent.

**5. Pass isAdmin from webhook.ts (src/plugins/webhook.ts):**
- In the `processConversation()` call (around line 55-69), add `isAdmin: user.isAdmin,` to the params object. The `user` object from `request.user` already has the `isAdmin` field from the users table.

**6. Mark remove tools with requiredRole: 'admin':**
- In `src/conversation/tools/remove-movie.ts`: Change the `defineTool()` call to pass `'admin'` as the last argument (after the execute function). The function signature is `defineTool(name, description, parameters, tier, execute, requiredRole)`.
- In `src/conversation/tools/remove-series.ts`: Same change -- add `'admin'` as the last argument to `defineTool()`.

**7. Add permissions section to system prompt (src/conversation/system-prompt.ts):**
- Append this section to the end of the SYSTEM_PROMPT template string (before the closing backtick), after the "Download status:" section:
  ```
  Permissions:
  - Some users have admin access and some do not. This is enforced by the system, not by you.
  - If a tool call returns a "Permission denied" error, explain to the user that only admins can remove media from the library. Be friendly about it.
  - Suggest what they CAN do instead: search, add, view upcoming, check downloads, discover media.
  - Never attempt to circumvent permission restrictions.
  ```
  </action>
  <verify>
- `npx tsc --noEmit` compiles without errors (all types consistent, requiredRole defaults work for unchanged tools).
- Verify remove-movie.ts and remove-series.ts pass `'admin'` to defineTool.
- Verify tool-loop.ts permission check appears BEFORE destructive check by reading the file.
- Verify engine.ts has isAdmin in BOTH ToolContext construction sites (main flow and confirmation flow).
- `npm test` passes (existing tests unbroken by optional parameter addition).
  </verify>
  <done>
- RequiredRole type exists on ToolDefinition and defaults to 'any' for all existing tools.
- Permission check in tool-loop.ts blocks non-admin users from admin-only tools BEFORE destructive confirmation prompt.
- isAdmin flows from webhook.ts -> engine.ts -> tool-loop.ts -> permission check.
- remove_movie and remove_series are tagged requiredRole: 'admin'.
- System prompt includes permissions guidance section.
- All existing tools continue to work without modification (safe 'any' default).
  </done>
</task>

<task type="auto">
  <name>Task 2: Media tracking table, tracking inserts, and admin notification on add</name>
  <files>
    src/db/schema.ts
    src/users/media-tracking.ts
    src/conversation/tools/add-movie.ts
    src/conversation/tools/add-series.ts
  </files>
  <action>
**1. Add media_tracking table to schema.ts (src/db/schema.ts):**
- Append after the `pendingActions` table definition (after line 59):
  ```typescript
  // Phase 10: Per-user media addition tracking
  export const mediaTracking = sqliteTable('media_tracking', {
    id: integer('id').primaryKey({ autoIncrement: true }),
    userId: integer('user_id')
      .notNull()
      .references(() => users.id),
    mediaType: text('media_type', { enum: ['movie', 'series'] }).notNull(),
    title: text('title').notNull(),
    year: integer('year'),
    externalId: text('external_id').notNull(), // tmdbId for movies, tvdbId for series
    sonarrRadarrId: integer('sonarr_radarr_id'),
    addedAt: integer('added_at', { mode: 'timestamp' })
      .notNull()
      .$defaultFn(() => new Date()),
  });
  ```

**2. Generate Drizzle migration:**
- Run `npm run db:generate` to produce the migration SQL. This should create a new migration file in `drizzle/` with a single `CREATE TABLE media_tracking` statement. Verify it is additive-only (no ALTER TABLE on existing tables).

**3. Create media tracking module (src/users/media-tracking.ts):**
- New file with:
  ```typescript
  import type { BetterSQLite3Database } from 'drizzle-orm/better-sqlite3';
  import type * as schema from '../db/schema.js';
  import { mediaTracking } from '../db/schema.js';

  type DB = BetterSQLite3Database<typeof schema>;

  export interface TrackingRecord {
    userId: number;
    mediaType: 'movie' | 'series';
    title: string;
    year: number | null;
    externalId: string;
    sonarrRadarrId: number | null;
  }

  export function insertMediaTracking(db: DB, record: TrackingRecord) {
    return db.insert(mediaTracking).values({
      userId: record.userId,
      mediaType: record.mediaType,
      title: record.title,
      year: record.year,
      externalId: record.externalId,
      sonarrRadarrId: record.sonarrRadarrId,
    }).run();
  }
  ```
  Follow the existing pure-function-with-db-param pattern from user.service.ts.

**4. Hook tracking + notification into add-movie.ts (src/conversation/tools/add-movie.ts):**
- After the successful return object is constructed (after `const profileName = ...` around line 113, BEFORE the final `return { success: true, ... }` block), insert:
  ```typescript
  // Phase 10: Track media addition
  if (context.db) {
    const { insertMediaTracking } = await import('../../users/media-tracking.js');
    insertMediaTracking(context.db, {
      userId: context.userId,
      mediaType: 'movie',
      title: added.title,
      year: added.year ?? null,
      externalId: String(args.tmdbId),
      sonarrRadarrId: added.id ?? null,
    });
  }

  // Phase 10: Notify admin when non-admin adds media
  if (!context.isAdmin && context.messaging && context.config?.ADMIN_PHONE) {
    const who = context.displayName || 'A user';
    context.messaging.send({
      to: context.config.ADMIN_PHONE,
      body: `${who} added movie: ${added.title} (${added.year ?? 'N/A'}) [${routingReason}]`,
      from: context.config.TWILIO_PHONE_NUMBER,
    }).catch(() => {}); // Fire-and-forget: do not fail the add on notification error
  }
  ```
  CRITICAL: The notification send MUST use `.catch(() => {})` (fire-and-forget). If Twilio is down, the add still succeeds. Do NOT await the notification send.

**5. Hook tracking + notification into add-series.ts (src/conversation/tools/add-series.ts):**
- Same pattern as add-movie.ts, after `const profileName = ...` and BEFORE the final `return` block:
  ```typescript
  // Phase 10: Track media addition
  if (context.db) {
    const { insertMediaTracking } = await import('../../users/media-tracking.js');
    insertMediaTracking(context.db, {
      userId: context.userId,
      mediaType: 'series',
      title: added.title,
      year: added.year ?? null,
      externalId: String(args.tvdbId),
      sonarrRadarrId: added.id ?? null,
    });
  }

  // Phase 10: Notify admin when non-admin adds media
  if (!context.isAdmin && context.messaging && context.config?.ADMIN_PHONE) {
    const who = context.displayName || 'A user';
    context.messaging.send({
      to: context.config.ADMIN_PHONE,
      body: `${who} added series: ${added.title} (${added.year ?? 'N/A'}) [${routingReason}]`,
      from: context.config.TWILIO_PHONE_NUMBER,
    }).catch(() => {}); // Fire-and-forget
  }
  ```
  </action>
  <verify>
- `npx tsc --noEmit` compiles (media-tracking.ts types are valid, add tools' context usage matches extended ToolContext).
- Verify migration file exists in `drizzle/` and contains only `CREATE TABLE media_tracking` (no ALTER on existing tables).
- Verify `src/users/media-tracking.ts` exists with `insertMediaTracking` exported.
- Verify both add-movie.ts and add-series.ts have tracking insert AND admin notification blocks.
- Verify notification uses `.catch(() => {})` pattern (fire-and-forget) in both add tools.
- `npm test` passes.
- `npm run check` passes (Biome lint/format).
  </verify>
  <done>
- media_tracking table is defined in schema.ts with userId, mediaType, title, year, externalId, sonarrRadarrId, addedAt columns.
- Drizzle migration generated for new table (additive, no existing table changes).
- insertMediaTracking function exists in src/users/media-tracking.ts.
- Both add_movie and add_series insert tracking records after successful adds.
- Both add tools send admin SMS notification for non-admin users (fire-and-forget).
- Admin's own adds do NOT trigger notification (guarded by `!context.isAdmin`).
  </done>
</task>

</tasks>

<verification>
1. **Permission enforcement:** Read tool-loop.ts and confirm permission check is between Zod validation block and destructive-tier check. A non-admin calling remove_movie would hit "Permission denied" before ever seeing "Are you sure?".
2. **Type consistency:** `npx tsc --noEmit` passes -- requiredRole on ToolDefinition is set by defineTool's default for all existing tools.
3. **Context wiring:** Read engine.ts and confirm isAdmin flows into ToolContext at both construction sites (main flow + confirmation flow).
4. **Tracking table:** Read the generated migration SQL and confirm it is a single CREATE TABLE with no ALTER TABLE statements.
5. **Notification guard:** Both add tools check `!context.isAdmin` before sending admin notification.
6. **Fire-and-forget:** Both add tools use `.catch(() => {})` on notification send.
7. **Full test suite:** `npm test` and `npm run check` pass.
</verification>

<success_criteria>
- Non-admin user attempting remove_movie/remove_series is blocked with "Permission denied" error returned to LLM (no confirmation prompt shown).
- Admin user remove operations work unchanged (destructive confirmation, then execute).
- Every add_movie/add_series call inserts a media_tracking row with correct userId, mediaType, title, year, externalId, timestamp.
- Non-admin adds trigger SMS to ADMIN_PHONE with user name, media title, year, and routing info.
- Admin adds do NOT trigger notification SMS.
- All existing tools work unchanged (requiredRole defaults to 'any').
- TypeScript compiles, tests pass, Biome checks pass.
</success_criteria>

<output>
After completion, create `.planning/phases/10-permissions-user-tracking/10-01-SUMMARY.md`
</output>
