---
phase: 20-notification-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/notifications/formatters.ts
  - src/notifications/notify.ts
autonomous: true

must_haves:
  truths:
    - "Telegram notifications render with HTML: bold titles, episode/movie details, no raw markdown"
    - "SMS notifications are truncated cleanly before 160 chars without mid-word cuts"
    - "SMS notifications longer than 160 chars fall back to MMS delivery"
    - "Both Telegram and SMS users receive properly formatted notifications from the same dispatch call"
  artifacts:
    - path: "src/notifications/formatters.ts"
      provides: "Provider-aware notification formatters producing HTML for Telegram and plain text for SMS"
      exports: ["formatSonarrNotification", "formatRadarrNotification"]
    - path: "src/notifications/notify.ts"
      provides: "Provider-aware notification dispatch with Telegram HTML formatting and SMS MMS fallback"
      exports: ["notifyAllActiveUsers"]
  key_links:
    - from: "src/notifications/formatters.ts"
      to: "src/notifications/notify.ts"
      via: "formatters produce both HTML and plain text variants consumed by notifyAllActiveUsers"
      pattern: "format(Sonarr|Radarr)Notification"
    - from: "src/notifications/notify.ts"
      to: "src/messaging/telegram-provider.ts"
      via: "sends Telegram notifications with parseMode HTML"
      pattern: "parseMode.*HTML"
    - from: "src/notifications/notify.ts"
      to: "src/messaging/twilio-provider.ts"
      via: "sends SMS with MMS fallback for long messages"
      pattern: "mediaUrl"
---

<objective>
Make proactive notifications (Sonarr/Radarr download/grab events) render beautifully on each provider: Telegram gets HTML formatting with bold titles, and SMS gets length-aware truncation with MMS fallback for longer content.

Purpose: Users on different messaging providers currently receive identical plain text notifications. Telegram users miss out on rich HTML formatting, and SMS users risk carrier truncation on longer messages.

Output: Updated formatters producing provider-aware output and updated notify dispatch using provider-specific send options.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/notifications/formatters.ts
@src/notifications/notify.ts
@src/notifications/types.ts
@src/messaging/types.ts
@src/messaging/telegram-provider.ts
@src/messaging/twilio-provider.ts
@src/plugins/notifications.ts
@src/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Provider-aware notification formatters</name>
  <files>src/notifications/formatters.ts</files>
  <action>
Refactor both `formatSonarrNotification` and `formatRadarrNotification` to return an object with both HTML and plain text variants instead of a single string. This avoids duplicating format logic while letting the dispatch function choose the right variant per provider.

New return type (add to file or inline):
```ts
interface FormattedNotification {
  html: string;   // Telegram HTML format
  plain: string;  // SMS plain text format
}
```

Update `formatSonarrNotification` to return `FormattedNotification | null`:
- **plain** (SMS): Keep the existing format exactly as-is: `"Downloaded: Show Name S01E05 - Episode Title"`
- **html** (Telegram): Same content but with HTML formatting:
  - Bold the prefix: `<b>Downloaded</b>` or `<b>Upgraded</b>` or `<b>Grabbing</b>`
  - Bold the series title: `<b>Show Name</b>`
  - Episode label in code style: `<code>S01E05</code>`
  - Episode title in italic: `<i>- Episode Title</i>`
  - Example: `<b>Downloaded</b>: <b>Breaking Bad</b> <code>S05E16</code> <i>- Felina</i>`

Update `formatRadarrNotification` to return `FormattedNotification | null`:
- **plain**: Keep existing: `"Downloaded: Movie Title (2024)"`
- **html**:
  - Bold prefix: `<b>Downloaded</b>` or `<b>Upgraded</b>` or `<b>Grabbing</b>`
  - Bold movie title: `<b>Movie Title</b>`
  - Year in parentheses (not bolded): `(2024)`
  - Example: `<b>Downloaded</b>: <b>Dune: Part Two</b> (2024)`

Export the `FormattedNotification` type so notify.ts can use it.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Verify the return type is `FormattedNotification | null` for both functions. Check that the existing plain text output matches the original format exactly.
  </verify>
  <done>Both formatters return an object with `html` and `plain` properties. HTML uses `<b>`, `<code>`, `<i>` tags appropriately. Plain text is identical to previous string output.</done>
</task>

<task type="auto">
  <name>Task 2: Provider-aware notification dispatch with SMS MMS fallback</name>
  <files>src/notifications/notify.ts</files>
  <action>
Update `notifyAllActiveUsers` to use the new `FormattedNotification` object and send provider-appropriate messages.

Change the `message: string` parameter to `notification: FormattedNotification` (import the type from formatters.ts).

Update the caller contract: the function now receives a FormattedNotification instead of a plain string.

For each user in the loop:

**Telegram users** (user.telegramChatId && telegramMessaging):
- Send with `body: notification.html` and `parseMode: 'HTML'`
- This leverages the existing parseMode support in TelegramMessagingProvider

**SMS users** (user.phone):
- Use `notification.plain` as the message body
- If the plain text exceeds 160 characters:
  1. Truncate to 157 chars + "..." ensuring no mid-word cut (find last space before 157, truncate there, append "...")
  2. Send as MMS by including `mediaUrl: [config.MMS_PIXEL_URL]` if MMS_PIXEL_URL is configured (same pattern as engine.ts line ~350)
  3. If MMS_PIXEL_URL is NOT configured, just send the truncated plain text as SMS
- If 160 chars or under, send as normal SMS

Update the log line to include the provider used: `log.info({ userCount, sentCount, smsCount, telegramCount, message: notification.plain }, "Notification dispatched")`

Also update `src/plugins/notifications.ts` to pass the FormattedNotification object from formatters instead of the string. The formatter functions now return `FormattedNotification | null`, so the null check stays the same, but the non-null value is an object not a string.

In notifications.ts, change:
```ts
const message = formatSonarrNotification(payload);
if (message) {
  notifyAllActiveUsers(..., message, ...);
}
```
to:
```ts
const notification = formatSonarrNotification(payload);
if (notification) {
  notifyAllActiveUsers(..., notification, ...);
}
```
Same for Radarr handler. The `_config` parameter is still passed through.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Run `npm test` -- existing tests pass. Verify that the Telegram send path includes `parseMode: 'HTML'` and the SMS path has MMS fallback logic.
  </verify>
  <done>
Telegram users receive HTML-formatted notifications with parseMode HTML. SMS users get length-aware plain text: messages over 160 chars are truncated at word boundary with "..." and sent as MMS when MMS_PIXEL_URL is configured. Both providers dispatch from the same notifyAllActiveUsers call.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm test` passes (existing conversation tests unaffected)
3. `npx biome check src/notifications/` passes lint/format
4. Manual code review: formatSonarrNotification and formatRadarrNotification return `{ html, plain }` objects
5. Manual code review: notify.ts sends Telegram with parseMode HTML and SMS with MMS fallback for >160 chars
6. Manual code review: notifications.ts plugin passes FormattedNotification objects to notifyAllActiveUsers
</verification>

<success_criteria>
- Telegram notification for a Sonarr Download event renders as: `<b>Downloaded</b>: <b>Show Name</b> <code>S01E05</code> <i>- Episode Title</i>`
- SMS notification for the same event is: `Downloaded: Show Name S01E05 - Episode Title` (plain text)
- SMS messages over 160 chars are truncated at word boundary with "..." and sent as MMS
- SMS messages 160 chars or under are sent as standard SMS
- All TypeScript compiles, all tests pass, all lint passes
</success_criteria>

<output>
After completion, create `.planning/phases/20-notification-polish/20-01-SUMMARY.md`
</output>
