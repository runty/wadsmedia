---
phase: 20-notification-polish
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - src/notifications/notify.ts
  - src/plugins/notifications.ts
autonomous: true

must_haves:
  truths:
    - "Failed notification sends are retried exactly once before being marked as failed"
    - "Persistent failures (all retries exhausted) trigger an admin alert via preferred channel"
    - "Every notification send outcome (success/failure/retry) is logged with structured details"
    - "Notification delivery stats are visible in application logs"
  artifacts:
    - path: "src/notifications/notify.ts"
      provides: "Retry logic wrapping individual sends, admin alerting on persistent failure, structured delivery logging"
      exports: ["notifyAllActiveUsers"]
    - path: "src/plugins/notifications.ts"
      provides: "Admin messaging reference passed to notifyAllActiveUsers for failure alerting"
      exports: ["default"]
  key_links:
    - from: "src/notifications/notify.ts"
      to: "src/messaging/types.ts"
      via: "retry wraps MessagingProvider.send() calls with single retry on failure"
      pattern: "messaging\\.send|telegramMessaging\\.send"
    - from: "src/notifications/notify.ts"
      to: "admin alert"
      via: "persistent failures send admin notification via preferred channel (Telegram if configured, else SMS)"
      pattern: "adminMessaging.*send|telegramMessaging.*send.*admin"
    - from: "src/plugins/notifications.ts"
      to: "src/notifications/notify.ts"
      via: "passes admin messaging config and Telegram provider for admin alerting"
      pattern: "notifyAllActiveUsers"
---

<objective>
Add delivery tracking with retry and admin alerting to the notification dispatch system. Failed sends are retried once, and if both attempts fail, an admin alert is sent summarizing which users could not be reached.

Purpose: Currently, notification failures are caught-and-logged with no retry or escalation. Users silently miss notifications when a transient provider error occurs. Admins have no visibility into delivery failures unless they read raw logs.

Output: Updated notify.ts with retry logic, structured delivery logging, and admin alerting. Updated notifications.ts plugin to pass admin config.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/20-notification-polish/20-01-SUMMARY.md

@src/notifications/notify.ts
@src/notifications/formatters.ts
@src/plugins/notifications.ts
@src/messaging/types.ts
@src/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Retry logic and structured delivery tracking in notify.ts</name>
  <files>src/notifications/notify.ts</files>
  <action>
Add retry-on-failure wrapping around each individual user send in `notifyAllActiveUsers`. The function signature gains two new optional parameters for admin alerting:
- `adminMessaging?: MessagingProvider` -- the preferred admin notification channel (Telegram if configured, else SMS provider)
- `adminAddress?: string` -- the admin's address on that channel (ADMIN_TELEGRAM_CHAT_ID or ADMIN_PHONE)

Inside the per-user loop, wrap each send call in a retry helper:

```ts
async function sendWithRetry(
  provider: MessagingProvider,
  message: OutboundMessage,
  log: FastifyBaseLogger,
  userLabel: string,
): Promise<{ success: boolean; attempts: number; error?: string }> {
  for (let attempt = 1; attempt <= 2; attempt++) {
    try {
      await provider.send(message);
      if (attempt > 1) {
        log.info({ userLabel, attempt }, "Notification retry succeeded");
      }
      return { success: true, attempts: attempt };
    } catch (err) {
      const errorMsg = err instanceof Error ? err.message : String(err);
      if (attempt === 1) {
        log.warn({ err, userLabel, attempt }, "Notification send failed, retrying");
      } else {
        log.error({ err, userLabel, attempt }, "Notification send failed after retry");
      }
      if (attempt === 2) {
        return { success: false, attempts: 2, error: errorMsg };
      }
    }
  }
  // TypeScript exhaustiveness (unreachable)
  return { success: false, attempts: 2, error: "Unknown error" };
}
```

Replace the existing try/catch around each user's send with `sendWithRetry`. Track outcomes:

```ts
const failures: Array<{ userLabel: string; error: string }> = [];
let successCount = 0;
let retrySuccessCount = 0;
let failureCount = 0;
```

After the loop, log a structured summary:
```ts
log.info({
  userCount: activeUsers.length,
  successCount,
  retrySuccessCount,
  failureCount,
  message: notification.plain,
}, "Notification dispatch complete");
```

If there are failures AND adminMessaging + adminAddress are provided, send an admin alert (fire-and-forget with .catch):
```ts
if (failures.length > 0 && adminMessaging && adminAddress) {
  const failedList = failures.map(f => `- ${f.userLabel}: ${f.error}`).join("\n");
  const alertBody = `Notification delivery failed for ${failures.length} user(s):\n${failedList}`;
  adminMessaging.send({ to: adminAddress, body: alertBody })
    .catch(alertErr => log.error({ err: alertErr }, "Failed to send admin delivery alert"));
}
```

The `userLabel` should be the user's phone (masked: last 4 digits) or telegram chat ID, whichever is applicable -- just enough for the admin to identify the user without logging full PII. For phone: `"SMS:***${phone.slice(-4)}"`. For Telegram: `"TG:${telegramChatId}"`.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Verify that each send is wrapped in retry logic. Verify failures array is populated and admin alert is sent when failures exist.
  </verify>
  <done>
Each notification send retries once on failure. All outcomes (success, retry-success, failure) are tracked with structured counters. Persistent failures (both attempts failed) accumulate in a failures list. Admin receives a summary alert listing which users could not be reached.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire admin alerting config into notification plugin</name>
  <files>src/plugins/notifications.ts</files>
  <action>
Update both webhook handlers (Sonarr and Radarr) to pass the admin messaging provider and address to `notifyAllActiveUsers`.

Determine the admin's preferred messaging channel using the existing pattern from Phase 15 (Telegram preferred when ADMIN_TELEGRAM_CHAT_ID is set):

```ts
// Determine admin alert channel (Telegram preferred, SMS fallback)
const adminTelegramChatId = fastify.config.ADMIN_TELEGRAM_CHAT_ID;
const adminMessaging = adminTelegramChatId && fastify.telegramMessaging
  ? fastify.telegramMessaging
  : fastify.messaging;
const adminAddress = adminTelegramChatId && fastify.telegramMessaging
  ? adminTelegramChatId
  : fastify.config.ADMIN_PHONE;
```

Compute these once at plugin registration time (outside the route handlers), then pass to each `notifyAllActiveUsers` call:

```ts
notifyAllActiveUsers(
  fastify.db,
  fastify.messaging,
  fastify.config,
  notification,
  request.log,
  fastify.telegramMessaging,
  adminMessaging,    // new
  adminAddress,      // new
)
```

The `.catch()` on the fire-and-forget call stays as-is -- it catches errors from `notifyAllActiveUsers` itself (not individual sends, which are now handled internally).
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Run `npm test` -- all tests pass. Run `npx biome check src/notifications/ src/plugins/notifications.ts` -- lint passes. Verify both Sonarr and Radarr handlers pass admin messaging config.
  </verify>
  <done>
Both webhook handlers pass admin messaging provider and address to notifyAllActiveUsers. Admin alerts for persistent delivery failures go via Telegram when ADMIN_TELEGRAM_CHAT_ID is configured, otherwise via SMS to ADMIN_PHONE.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm test` passes
3. `npx biome check src/` passes
4. Code review: sendWithRetry retries exactly once (2 attempts total)
5. Code review: failures array tracks all failed users with error details
6. Code review: admin alert sent fire-and-forget when failures exist
7. Code review: structured log includes successCount, retrySuccessCount, failureCount
8. Code review: notifications.ts passes adminMessaging and adminAddress to notifyAllActiveUsers
</verification>

<success_criteria>
- Each notification send attempt retries once on failure (2 attempts max)
- Retry success is logged at info level, final failure at error level
- Admin receives a single alert message listing all users who could not be reached
- Admin alert uses Telegram if ADMIN_TELEGRAM_CHAT_ID is set, otherwise SMS
- Dispatch summary log includes success/retry/failure counts
- No existing tests broken, all TypeScript compiles, lint passes
</success_criteria>

<output>
After completion, create `.planning/phases/20-notification-polish/20-02-SUMMARY.md`
</output>
