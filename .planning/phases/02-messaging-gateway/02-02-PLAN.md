---
phase: 02-messaging-gateway
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/plugins/messaging.ts
  - src/plugins/webhook.ts
  - src/server.ts
  - src/config.ts
autonomous: true
user_setup:
  - service: twilio
    why: "SMS/RCS message sending and receiving"
    env_vars:
      - name: TWILIO_ACCOUNT_SID
        source: "Twilio Console -> Account Info -> Account SID"
      - name: TWILIO_AUTH_TOKEN
        source: "Twilio Console -> Account Info -> Auth Token"
      - name: TWILIO_PHONE_NUMBER
        source: "Twilio Console -> Phone Numbers -> Active Numbers (E.164 format, e.g. +15551234567)"
    dashboard_config:
      - task: "Configure webhook URL for your Twilio phone number"
        location: "Twilio Console -> Phone Numbers -> Active Numbers -> [your number] -> Messaging -> A MESSAGE COMES IN -> set Webhook URL to https://your-domain/webhook/twilio (POST)"

must_haves:
  truths:
    - "POST /webhook/twilio receives Twilio form-encoded webhooks and responds with TwiML XML"
    - "Requests with invalid or missing X-Twilio-Signature are rejected with 403"
    - "The messaging provider is accessible on the Fastify instance as fastify.messaging"
    - "Config validates Twilio credentials at plugin registration time with a clear error if missing"
    - "TWILIO_MESSAGING_SERVICE_SID is supported as optional config for RCS+SMS fallback"
  artifacts:
    - path: "src/plugins/messaging.ts"
      provides: "Fastify plugin decorating instance with MessagingProvider"
      exports: ["default"]
    - path: "src/plugins/webhook.ts"
      provides: "POST /webhook/twilio route with signature validation preHandler"
      exports: ["default"]
    - path: "src/server.ts"
      provides: "Server factory with formbody, messaging, and webhook plugins registered"
      contains: "formbody"
    - path: "src/config.ts"
      provides: "TWILIO_MESSAGING_SERVICE_SID optional config"
      contains: "TWILIO_MESSAGING_SERVICE_SID"
  key_links:
    - from: "src/plugins/webhook.ts"
      to: "src/plugins/messaging.ts"
      via: "fastify.messaging decorator (validateWebhook, parseInbound, formatEmptyReply)"
      pattern: "fastify\\.messaging\\."
    - from: "src/plugins/messaging.ts"
      to: "src/messaging/twilio-provider.ts"
      via: "new TwilioMessagingProvider(accountSid, authToken)"
      pattern: "new TwilioMessagingProvider"
    - from: "src/plugins/webhook.ts"
      to: "X-Twilio-Signature header"
      via: "preHandler hook reads header and calls validateWebhook"
      pattern: "x-twilio-signature"
    - from: "src/server.ts"
      to: "src/plugins/messaging.ts"
      via: "fastify.register(messagingPlugin)"
      pattern: "register\\(messagingPlugin\\)"
    - from: "src/plugins/webhook.ts"
      to: "x-forwarded-proto header"
      via: "URL reconstruction for signature validation behind reverse proxy"
      pattern: "x-forwarded-proto"
---

<objective>
Wire the messaging provider into Fastify with webhook endpoint, signature validation, and formbody parsing -- completing the full messaging gateway.

Purpose: Connects the Plan 01 provider interface to live HTTP traffic. Incoming Twilio webhooks are validated for authenticity (MSG-02), parsed into normalized messages, and acknowledged with TwiML. The provider is registered as a Fastify decorator for use by future phases (MSG-03 outbound sending). Config is updated to support optional Messaging Service SID for RCS fallback.

Output: Two Fastify plugins (messaging + webhook), updated server.ts with plugin registration, and updated config.ts with TWILIO_MESSAGING_SERVICE_SID.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-messaging-gateway/02-RESEARCH.md
@.planning/phases/02-messaging-gateway/02-01-SUMMARY.md
@src/server.ts
@src/config.ts
@src/messaging/types.ts
@src/messaging/twilio-provider.ts
@src/plugins/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create messaging and webhook Fastify plugins</name>
  <files>
    src/plugins/messaging.ts
    src/plugins/webhook.ts
  </files>
  <action>
Install `@fastify/formbody`: `npm install @fastify/formbody`

**src/plugins/messaging.ts:**

Create a Fastify plugin using `fastify-plugin` (fp) wrapper that:

1. Reads `TWILIO_ACCOUNT_SID` and `TWILIO_AUTH_TOKEN` from `fastify.config`
2. Validates both are present -- if either is missing, throw `new Error("TWILIO_ACCOUNT_SID and TWILIO_AUTH_TOKEN are required")` with a clear message. Do NOT change the Zod schema to make them required (keeps Phase 1 standalone -- per research recommendation).
3. Creates a new `TwilioMessagingProvider(accountSid, authToken)` instance
4. Decorates fastify instance: `fastify.decorate("messaging", provider)`
5. Logs: `fastify.log.info("Messaging provider registered (Twilio)")`
6. Plugin name: `"messaging"`

Add the Fastify module augmentation for TypeScript:
```typescript
declare module "fastify" {
  interface FastifyInstance {
    messaging: import("../messaging/types.js").MessagingProvider;
  }
}
```

**src/plugins/webhook.ts:**

Create a Fastify plugin using `fastify-plugin` (fp) wrapper that:

1. Defines a `validateTwilioSignature` preHandler hook:
   - Reads `x-twilio-signature` from `request.headers`
   - If missing or not a string, reply 403 with `{ error: "Missing Twilio signature" }`
   - Reconstructs the webhook URL using `x-forwarded-proto` header (defaulting to `"http"`) and `request.headers.host` (defaulting to `"localhost"`), combined with `request.url` (which includes query params -- critical for signature validation). Format: `${protocol}://${host}${request.url}`
   - Calls `fastify.messaging.validateWebhook({ signature, url, body: request.body as Record<string, string> })`
   - If invalid, logs warning and replies 403 with `{ error: "Invalid signature" }`

2. Registers POST `/webhook/twilio` route with `preHandler: validateTwilioSignature`:
   - Parses inbound message: `fastify.messaging.parseInbound(request.body as Record<string, string>)`
   - Logs: `request.log.info({ from: message.from, body: message.body }, "Incoming message")`
   - Responds with empty TwiML: `fastify.messaging.formatEmptyReply()` (Phase 2 acknowledges only; conversation logic added in Phase 5+)
   - Sets content type: `reply.type("text/xml")` -- Twilio expects TwiML XML, NOT JSON

3. Plugin name: `"webhook"`, dependencies: `["messaging"]`

Import patterns:
- `import type { FastifyInstance, FastifyRequest, FastifyReply } from "fastify"`
- `import fp from "fastify-plugin"`
- Use `.js` extensions in relative imports
  </action>
  <verify>
Run `npm run build` -- compiles with no errors. Run `npm run check` -- Biome passes. Verify both plugins export default fp-wrapped functions.
  </verify>
  <done>
messaging.ts decorates Fastify with the provider, webhook.ts registers POST /webhook/twilio with signature validation preHandler. Both compile and lint cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update config and server to register messaging plugins</name>
  <files>
    src/config.ts
    src/server.ts
  </files>
  <action>
**src/config.ts:**

Add one new optional field to the Zod env schema:
- `TWILIO_MESSAGING_SERVICE_SID: z.string().min(1).optional()` -- placed in the Twilio section, after TWILIO_PHONE_NUMBER

This supports RCS+SMS fallback via Twilio Messaging Services. When present, outbound messages use this SID instead of the from-number for automatic RCS-first with SMS fallback. Keep all existing Twilio fields as optional (do not change them to required).

**src/server.ts:**

1. Add imports at the top:
   - `import formbody from "@fastify/formbody"`
   - `import messagingPlugin from "./plugins/messaging.js"`
   - `import webhookPlugin from "./plugins/webhook.js"`

2. Register plugins in the correct order after existing plugins:
   - `await fastify.register(formbody)` -- MUST be before webhook plugin so request.body is parsed for form-encoded webhooks
   - `await fastify.register(messagingPlugin)` -- creates the provider instance
   - `await fastify.register(webhookPlugin)` -- registers the /webhook/twilio route (depends on messaging)

The final registration order should be: databasePlugin, healthPlugin, formbody, messagingPlugin, webhookPlugin.

Do NOT change any existing plugin registrations. Do NOT modify databasePlugin or healthPlugin.
  </action>
  <verify>
Run `npm run build` -- full project compiles with no errors. Run `npm run check` -- Biome passes with no errors. Verify TWILIO_MESSAGING_SERVICE_SID appears in config.ts. Verify server.ts imports and registers all three new plugins in correct order.
  </verify>
  <done>
Config includes optional TWILIO_MESSAGING_SERVICE_SID. Server registers formbody, messaging, and webhook plugins in correct dependency order. Full project builds and lints clean.
  </done>
</task>

</tasks>

<verification>
- `npm run build` passes with no errors
- `npm run check` passes with no Biome errors
- POST /webhook/twilio route exists in the application
- Messaging provider is accessible as `fastify.messaging`
- Signature validation rejects requests without valid X-Twilio-Signature
- Webhook responds with text/xml content type (TwiML)
- formbody plugin registered before webhook plugin
- TWILIO_MESSAGING_SERVICE_SID is in config schema as optional
- Application still starts without Twilio env vars (they fail at messaging plugin registration, not config parse)
</verification>

<success_criteria>
- Webhook endpoint receives POST requests at /webhook/twilio with form-encoded body parsing
- Invalid/missing signatures return 403 (MSG-02 security)
- Valid requests are parsed into InboundMessage and acknowledged with empty TwiML
- Messaging provider is decorated on Fastify instance for outbound use by future phases (MSG-03)
- Config supports optional Messaging Service SID for RCS fallback (MSG-04)
- All existing functionality (health check, database) continues working
</success_criteria>

<output>
After completion, create `.planning/phases/02-messaging-gateway/02-02-SUMMARY.md`
</output>
