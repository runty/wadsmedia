---
phase: 02-messaging-gateway
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/messaging/types.ts
  - src/messaging/twilio-provider.ts
autonomous: true

must_haves:
  truths:
    - "A MessagingProvider interface defines send, validateWebhook, parseInbound, formatReply, and formatEmptyReply without importing Twilio"
    - "TwilioMessagingProvider implements MessagingProvider using the twilio SDK"
    - "Outbound messages support both direct from-number and messagingServiceSid for RCS fallback"
    - "Signature validation delegates to twilio.validateRequest with correct parameter types"
  artifacts:
    - path: "src/messaging/types.ts"
      provides: "MessagingProvider interface, InboundMessage, OutboundMessage, SendResult types"
      exports: ["MessagingProvider", "InboundMessage", "OutboundMessage", "SendResult"]
    - path: "src/messaging/twilio-provider.ts"
      provides: "TwilioMessagingProvider class implementing MessagingProvider"
      exports: ["TwilioMessagingProvider"]
  key_links:
    - from: "src/messaging/twilio-provider.ts"
      to: "src/messaging/types.ts"
      via: "implements MessagingProvider"
      pattern: "implements MessagingProvider"
    - from: "src/messaging/twilio-provider.ts"
      to: "twilio"
      via: "SDK import for client, validateRequest, twiml.MessagingResponse"
      pattern: "import twilio from \"twilio\""
---

<objective>
Create the messaging provider interface and Twilio adapter class -- the ports-and-adapters foundation for all messaging operations.

Purpose: Establishes a provider-agnostic messaging contract (MSG-01) that decouples core logic from Twilio. The interface defines send, validate, parse, and reply operations. The Twilio adapter implements them using the official SDK.

Output: Two files in src/messaging/ -- a pure TypeScript interface module and a Twilio SDK adapter class.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-messaging-gateway/02-RESEARCH.md
@src/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create messaging provider interface and types</name>
  <files>src/messaging/types.ts</files>
  <action>
Create `src/messaging/types.ts` with the following type definitions and interface:

**InboundMessage interface:**
- `messageSid: string` -- unique Twilio message ID
- `from: string` -- sender phone number (E.164 format)
- `to: string` -- recipient phone number (E.164 format)
- `body: string` -- message text content
- `numMedia: number` -- count of attached media

**OutboundMessage interface:**
- `to: string` -- recipient phone number (E.164 format)
- `body: string` -- message text content (plain text, text-first per MSG-04)
- `messagingServiceSid?: string` -- optional Twilio Messaging Service SID for RCS+SMS fallback
- `from?: string` -- optional sender phone number (used when no messagingServiceSid)

**SendResult interface:**
- `sid: string` -- provider message ID
- `status: string` -- delivery status (e.g., "queued", "sent")

**MessagingProvider interface:**
- `send(message: OutboundMessage): Promise<SendResult>` -- send an outbound message
- `validateWebhook(params: { signature: string; url: string; body: Record<string, string> }): boolean` -- validate incoming webhook authenticity
- `parseInbound(body: Record<string, string>): InboundMessage` -- parse raw webhook body into normalized message
- `formatReply(text: string): string` -- generate TwiML XML string for immediate reply
- `formatEmptyReply(): string` -- generate empty TwiML response (acknowledge without reply)

All types must be exported. The interface must NOT import anything from twilio -- it is provider-agnostic. Use ESM export syntax.
  </action>
  <verify>
Run `npx tsc --noEmit` -- file compiles with no errors. Verify no twilio imports in types.ts.
  </verify>
  <done>
types.ts exports MessagingProvider, InboundMessage, OutboundMessage, and SendResult. No external dependencies -- pure TypeScript types.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Twilio messaging provider adapter</name>
  <files>src/messaging/twilio-provider.ts</files>
  <action>
Install the twilio SDK: `npm install twilio`

Create `src/messaging/twilio-provider.ts` implementing `MessagingProvider`:

**Class: TwilioMessagingProvider**

Constructor takes `accountSid: string` and `authToken: string`. Creates a Twilio client via `twilio(accountSid, authToken)` and stores authToken for signature validation.

**Import pattern (critical for ESM):**
- `import twilio from "twilio"` for the client factory and `validateRequest` static method
- `import { twiml } from "twilio"` for `MessagingResponse`
- Destructure: `const { MessagingResponse } = twiml;`

**send(message):** Calls `this.client.messages.create()` with `body`, `to`, and conditionally either `messagingServiceSid` or `from` (prefer messagingServiceSid when present). Returns `{ sid: result.sid, status: result.status }`.

**validateWebhook(params):** Delegates to `twilio.validateRequest(this.authToken, params.signature, params.url, params.body)`. Returns the boolean result directly.

**parseInbound(body):** Maps Twilio's PascalCase form params to the InboundMessage interface:
- `messageSid` from `body.MessageSid ?? ""`
- `from` from `body.From ?? ""`
- `to` from `body.To ?? ""`
- `body` from `body.Body ?? ""`
- `numMedia` from `Number.parseInt(body.NumMedia ?? "0", 10)`

**formatReply(text):** Creates a new `MessagingResponse()`, calls `.message(text)`, returns `.toString()`.

**formatEmptyReply():** Creates a new `MessagingResponse()`, returns `.toString()` (no message added).

Use `.js` extension in the relative import of types.ts (ESM convention per project pattern).
  </action>
  <verify>
Run `npm run build` -- project compiles with no errors. Run `npm run check` -- Biome passes. Verify the class implements all 5 methods from MessagingProvider.
  </verify>
  <done>
TwilioMessagingProvider class compiles, implements all MessagingProvider methods, uses twilio SDK for send/validate/parse/format operations.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- `npm run check` passes with no Biome errors
- `src/messaging/types.ts` exists and exports MessagingProvider, InboundMessage, OutboundMessage, SendResult
- `src/messaging/twilio-provider.ts` exists and exports TwilioMessagingProvider
- TwilioMessagingProvider implements all 5 methods from MessagingProvider interface
- No Twilio imports in types.ts (provider-agnostic)
- twilio package is in package.json dependencies
</verification>

<success_criteria>
- MessagingProvider interface is provider-agnostic (no Twilio dependency)
- TwilioMessagingProvider correctly implements the interface using the twilio SDK
- Both files compile and pass Biome checks
- OutboundMessage supports both from-number and messagingServiceSid patterns
</success_criteria>

<output>
After completion, create `.planning/phases/02-messaging-gateway/02-01-SUMMARY.md`
</output>
