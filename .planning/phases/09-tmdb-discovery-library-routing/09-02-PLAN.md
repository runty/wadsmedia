---
phase: 09-tmdb-discovery-library-routing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/media/brave/brave.client.ts
  - src/media/brave/brave.schemas.ts
  - src/media/brave/brave.types.ts
  - src/conversation/tools/web-search.ts
  - src/conversation/tools/index.ts
  - src/conversation/types.ts
  - src/plugins/brave.ts
  - src/plugins/conversation.ts
  - src/config.ts
  - src/conversation/system-prompt.ts
autonomous: true
user_setup:
  - service: Brave Search
    why: "Web search fallback for vague media queries"
    env_vars:
      - name: BRAVE_SEARCH_API_KEY
        source: "https://api-dashboard.search.brave.com -> API Keys"

must_haves:
  truths:
    - "User can describe media vaguely ('that movie where the guy relives the same day') and get useful web search results"
    - "Web search results include title, URL, and description for each result"
    - "App starts gracefully when BRAVE_SEARCH_API_KEY is not set (web search unavailable)"
    - "LLM is instructed to use web_search only when TMDB structured search fails or query is too vague"
  artifacts:
    - path: "src/media/brave/brave.client.ts"
      provides: "BraveSearchClient class with search method"
      exports: ["BraveSearchClient"]
    - path: "src/media/brave/brave.schemas.ts"
      provides: "Zod schemas for Brave Search API responses"
      exports: ["BraveSearchResponseSchema", "BraveSearchResultSchema"]
    - path: "src/conversation/tools/web-search.ts"
      provides: "web_search LLM tool for vague media queries"
      exports: ["webSearchTool"]
    - path: "src/plugins/brave.ts"
      provides: "Fastify plugin creating BraveSearchClient and decorating fastify.brave"
      exports: ["default"]
  key_links:
    - from: "src/conversation/tools/web-search.ts"
      to: "src/media/brave/brave.client.ts"
      via: "context.brave on ToolContext"
      pattern: "context\\.brave\\."
    - from: "src/plugins/brave.ts"
      to: "src/media/brave/brave.client.ts"
      via: "new BraveSearchClient()"
      pattern: "new BraveSearchClient"
    - from: "src/plugins/conversation.ts"
      to: "src/conversation/tools/web-search.ts"
      via: "registry.register(webSearchTool)"
      pattern: "register\\(webSearchTool\\)"
---

<objective>
Build the Brave Search API client and web_search LLM tool, providing a fallback for vague media queries that TMDB structured search cannot handle.

Purpose: Satisfies DISC-02 (web search fallback for vague descriptions). When a user says "that movie where the guy relives the same day," TMDB discover endpoints cannot help -- but a web search for "movie where guy relives same day" returns "Groundhog Day" immediately.

Output: BraveSearchClient class, Brave Fastify plugin, web_search tool registered in conversation engine.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-tmdb-discovery-library-routing/09-RESEARCH.md

Key source files to reference:
@src/media/errors.ts (reuse ConnectionError, MediaServerError, ValidationError)
@src/plugins/sonarr.ts (Fastify plugin pattern)
@src/conversation/tools.ts (defineTool pattern)
@src/conversation/types.ts (ToolContext -- will have tmdb? added by 09-01 if it runs first, but this plan is independent)
@src/config.ts (env schema)
@src/plugins/conversation.ts (tool registration)
@src/conversation/system-prompt.ts (system prompt)
@src/conversation/tools/index.ts (barrel export)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Brave Search client and web_search tool with full wiring</name>
  <files>
    src/media/brave/brave.client.ts
    src/media/brave/brave.schemas.ts
    src/media/brave/brave.types.ts
    src/conversation/tools/web-search.ts
    src/conversation/tools/index.ts
    src/conversation/types.ts
    src/plugins/brave.ts
    src/plugins/conversation.ts
    src/config.ts
    src/conversation/system-prompt.ts
  </files>
  <action>
Create the Brave Search client and wire it into the application:

**src/media/brave/brave.schemas.ts** -- Zod schemas:
- `BraveSearchResultSchema`: `{ title: z.string(), url: z.string(), description: z.string() }.passthrough()`
- `BraveSearchResponseSchema`: `{ web: z.object({ results: z.array(BraveSearchResultSchema) }).optional(), query: z.object({ original: z.string() }).optional() }.passthrough()`

**src/media/brave/brave.types.ts** -- Types inferred from schemas:
- `BraveSearchResult = z.infer<typeof BraveSearchResultSchema>`
- `BraveSearchResponse = z.infer<typeof BraveSearchResponseSchema>`

**src/media/brave/brave.client.ts** -- BraveSearchClient class:
- Constructor takes `apiKey: string`
- `search(query: string, count = 5): Promise<BraveSearchResult[]>`
- Base URL: `https://api.search.brave.com/res/v1/web/search`
- Auth header: `X-Subscription-Token: {apiKey}`
- Accept: `application/json`
- Query params: `q={query}` and `count={count}`
- 10s timeout via AbortSignal.timeout
- Error handling: ConnectionError for TypeError/TimeoutError, MediaServerError for non-2xx
- Parse response with BraveSearchResponseSchema, return `result.data.web?.results ?? []`
- Follow the exact implementation from the research document

**src/config.ts** -- Add optional Brave env var:
- `BRAVE_SEARCH_API_KEY: z.string().min(1).optional()` -- Brave Search API subscription token

NOTE: If 09-01 has already modified this file (adding TMDB_ACCESS_TOKEN), add the Brave key alongside it. If running in parallel, add both independently -- they are separate lines with no conflict.

**src/conversation/types.ts** -- Extend ToolContext:
- Add `brave?: import("../media/brave/brave.client.js").BraveSearchClient` to ToolContext

NOTE: If 09-01 has already added `tmdb?`, add `brave?` alongside it. If running in parallel, both add separate fields -- no structural conflict.

**src/plugins/brave.ts** -- Fastify plugin following sonarr.ts pattern:
- Declare module augmentation: `fastify.brave?: BraveSearchClient`
- If `BRAVE_SEARCH_API_KEY` not set, log warning and return (graceful skip)
- Create `new BraveSearchClient(BRAVE_SEARCH_API_KEY)`
- `fastify.decorate("brave", client)`
- Log: `"Brave Search configured"`
- Dependencies: `["database"]`

**src/conversation/tools/web-search.ts** -- web_search tool:
- Name: `web_search`
- Description: `"Search the web for media information when TMDB structured search cannot find what the user is looking for. Best for vague descriptions like 'that movie where the guy relives the same day' or 'show about a chemistry teacher who becomes a drug dealer'. Returns web page titles and descriptions."`
- Parameters:
  - `query: z.string().describe("Web search query. Include 'movie' or 'TV show' in the query for better results.")`
- Tier: `"safe"`
- Executor:
  1. If `!context.brave`, return `{ error: "Web search is not configured (set BRAVE_SEARCH_API_KEY)" }`
  2. Call `context.brave.search(args.query, 5)`
  3. Map results: `{ title, url, description }` (no transformation needed, Brave returns exactly these fields)
  4. Return `{ results: [...], query: args.query }`

**src/conversation/tools/index.ts** -- Add export:
- `export { webSearchTool } from "./web-search.js";`

**src/plugins/conversation.ts** -- Register new tool:
- Import `webSearchTool` from tools barrel
- Add `registry.register(webSearchTool)` after existing registrations
- Find where ToolContext is constructed and add `brave: fastify.brave` to the context object (same location where tmdb will be added by 09-01)

**src/conversation/system-prompt.ts** -- Add web search guidance:
- Add to capabilities list: `- Search the web for media when descriptions are vague`
- Add new section:
```
Web search fallback:
- Use web_search ONLY when the user describes media vaguely and you cannot identify it from the description alone or via discover_media.
- Examples of vague queries: "that movie where the guy relives the same day", "show about a chemistry teacher", "movie with the spinning top at the end".
- Always include "movie" or "TV show" in the web search query for better results.
- After getting web search results, try to identify the specific title and then use search_movies or search_series to find it in Sonarr/Radarr for adding.
```

NOTE: Both 09-01 and 09-02 modify system-prompt.ts, conversation.ts, types.ts, config.ts, and tools/index.ts. These modifications are additive (appending lines, adding fields) and structurally non-conflicting. If running in parallel, the executor should handle merge gracefully. If run sequentially, the second plan simply adds to what the first already created.
  </action>
  <verify>
Run `npx tsc --noEmit` -- all files compile. Run `npx biome check src/` for lint compliance. Verify `src/media/brave/` has 3 files. Verify web_search tool exports from barrel index. Count tools -- should be 12 if 09-01 ran first (10 base + discover_media + web_search), or 11 if this ran first (10 base + web_search).
  </verify>
  <done>
web_search tool is registered and callable. BraveSearchClient handles Brave Search API with proper auth and error handling. ToolContext includes optional brave field. Fastify brave plugin creates and decorates client. Config accepts optional BRAVE_SEARCH_API_KEY. System prompt guides LLM to use web_search as a fallback for vague queries. App starts gracefully without BRAVE_SEARCH_API_KEY.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npx biome check src/` passes with zero errors
3. All 3 files in `src/media/brave/` exist and export expected symbols
4. `src/conversation/tools/web-search.ts` exports `webSearchTool`
5. `src/plugins/brave.ts` follows identical pattern to `src/plugins/sonarr.ts` (graceful skip when unconfigured)
6. `src/config.ts` includes `BRAVE_SEARCH_API_KEY` as optional
7. `src/conversation/types.ts` ToolContext includes `brave?` field
8. System prompt includes web search fallback guidance
</verification>

<success_criteria>
- BraveSearchClient fully implemented with search method and proper error handling
- web_search tool accepts query param and returns title, url, description for each result
- Brave client integrated into Fastify via plugin with graceful degradation
- Total tool count after both 09-01 and 09-02: 12 (10 existing + discover_media + web_search)
- All code compiles and lints cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/09-tmdb-discovery-library-routing/09-02-SUMMARY.md`
</output>
