---
phase: 09-tmdb-discovery-library-routing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/media/tmdb/tmdb.http.ts
  - src/media/tmdb/tmdb.schemas.ts
  - src/media/tmdb/tmdb.types.ts
  - src/media/tmdb/tmdb.utils.ts
  - src/media/tmdb/tmdb.client.ts
  - src/conversation/tools/discover-media.ts
  - src/conversation/tools/index.ts
  - src/conversation/types.ts
  - src/plugins/tmdb.ts
  - src/plugins/conversation.ts
  - src/config.ts
  - src/conversation/system-prompt.ts
autonomous: true
user_setup:
  - service: TMDB
    why: "TMDB API access token for media discovery"
    env_vars:
      - name: TMDB_ACCESS_TOKEN
        source: "https://www.themoviedb.org/settings/api -> API Read Access Token (v4 auth)"

must_haves:
  truths:
    - "User can ask 'show me sci-fi movies from the 90s' and get relevant TMDB results with metadata"
    - "User can ask 'what has Oscar Isaac been in' and get movies featuring that actor"
    - "Discovery results include title, year, overview, rating, poster URL, and language"
    - "Genre names are resolved to TMDB genre IDs internally (user never sees IDs)"
    - "Actor names are resolved to TMDB person IDs internally via search/person"
    - "App starts gracefully when TMDB_ACCESS_TOKEN is not set (TMDB features unavailable)"
  artifacts:
    - path: "src/media/tmdb/tmdb.client.ts"
      provides: "TmdbClient class with genre cache, person search, discover movies, discover TV"
      exports: ["TmdbClient"]
    - path: "src/media/tmdb/tmdb.http.ts"
      provides: "TMDB-specific HTTP helper with Bearer auth and /3/ prefix"
      exports: ["tmdbRequest"]
    - path: "src/media/tmdb/tmdb.schemas.ts"
      provides: "Zod schemas for all TMDB API responses"
      exports: ["GenreListSchema", "DiscoverMovieResponseSchema", "DiscoverTvResponseSchema", "PersonSearchResponseSchema", "MovieDetailSchema", "TvDetailSchema"]
    - path: "src/conversation/tools/discover-media.ts"
      provides: "Single discover_media LLM tool covering movie and TV discovery"
      exports: ["discoverMediaTool"]
    - path: "src/plugins/tmdb.ts"
      provides: "Fastify plugin creating TmdbClient and decorating fastify.tmdb"
      exports: ["default"]
  key_links:
    - from: "src/conversation/tools/discover-media.ts"
      to: "src/media/tmdb/tmdb.client.ts"
      via: "context.tmdb on ToolContext"
      pattern: "context\\.tmdb\\."
    - from: "src/plugins/tmdb.ts"
      to: "src/media/tmdb/tmdb.client.ts"
      via: "new TmdbClient() and loadGenres()"
      pattern: "new TmdbClient"
    - from: "src/plugins/conversation.ts"
      to: "src/conversation/tools/discover-media.ts"
      via: "registry.register(discoverMediaTool)"
      pattern: "register\\(discoverMediaTool\\)"
---

<objective>
Build the TMDB API client and discover_media LLM tool, enabling users to discover movies and TV shows by genre, actor, year, or language through natural language.

Purpose: Satisfies DISC-01 (structured discovery by actor/genre/network/year) and DISC-03 (enriched metadata in results). This is the foundation for Phase 9 -- the TMDB client is also used by Plan 09-03 for routing metadata.

Output: TmdbClient class, TMDB Fastify plugin, discover_media tool registered in conversation engine, config + ToolContext updated.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-tmdb-discovery-library-routing/09-RESEARCH.md

Key source files to reference:
@src/media/http.ts (existing HTTP helper pattern -- DO NOT modify, create separate TMDB helper)
@src/media/errors.ts (reuse ConnectionError, MediaServerError, ValidationError)
@src/media/sonarr/sonarr.client.ts (client class pattern to follow)
@src/plugins/sonarr.ts (Fastify plugin pattern to follow)
@src/conversation/tools.ts (defineTool + ToolRegistry pattern)
@src/conversation/tools/add-movie.ts (existing tool example)
@src/conversation/types.ts (ToolContext to extend)
@src/config.ts (env schema to extend)
@src/plugins/conversation.ts (tool registration)
@src/conversation/system-prompt.ts (system prompt to extend)
</context>

<tasks>

<task type="auto">
  <name>Task 1: TMDB client infrastructure (HTTP helper, schemas, types, utils, client class)</name>
  <files>
    src/media/tmdb/tmdb.http.ts
    src/media/tmdb/tmdb.schemas.ts
    src/media/tmdb/tmdb.types.ts
    src/media/tmdb/tmdb.utils.ts
    src/media/tmdb/tmdb.client.ts
  </files>
  <action>
Create the `src/media/tmdb/` directory with five files following the exact patterns from the research document:

**tmdb.http.ts** -- TMDB-specific HTTP helper:
- `tmdbRequest<T>(options: TmdbRequestOptions, schema: z.ZodType<T>): Promise<T>`
- Uses `Authorization: Bearer {accessToken}` header (NOT X-Api-Key)
- Base URL: `https://api.themoviedb.org/3`
- Path is appended directly (e.g. `search/person`, `discover/movie`) -- no `/api/v3/` prefix
- Supports query params via `Record<string, string | number | boolean>`
- 10s default timeout via AbortSignal.timeout
- Error classification: ConnectionError for TypeError/TimeoutError, MediaServerError for non-2xx (special 429 message for rate limit), ValidationError for schema mismatch
- Import error classes from `../errors.js` (reuse existing, do not create new ones)

**tmdb.schemas.ts** -- Zod schemas for TMDB API responses:
- `GenreSchema`, `GenreListSchema` (for genre list endpoints)
- `DiscoverMovieItemSchema`, `DiscoverMovieResponseSchema` (paginated movie results with id, title, original_title, overview, release_date, genre_ids, original_language, vote_average, vote_count, poster_path, popularity)
- `DiscoverTvItemSchema`, `DiscoverTvResponseSchema` (paginated TV results with id, name, original_name, overview, first_air_date, genre_ids, original_language, origin_country, vote_average, vote_count, poster_path, popularity)
- `PersonSchema`, `PersonSearchResponseSchema` (paginated person results with id, name, popularity, known_for_department)
- `MovieDetailSchema` (for routing: id, title, original_language, genres, production_countries, spoken_languages)
- `TvDetailSchema` (for routing: id, name, original_language, origin_country, genres, number_of_seasons)
- Use helper `PaginatedSchema<T>` for the paginated wrapper (page, results, total_pages, total_results)
- All schemas use `.passthrough()` on the item level to tolerate extra fields
- Follow exact schema shapes from the research document

**tmdb.types.ts** -- TypeScript types inferred from schemas:
- Export `GenreMap` as `Map<string, number>` (lowercase genre name -> genre ID)
- Infer all response types from schemas: `DiscoverMovieResult`, `DiscoverTvResult`, `PersonSearchResult`, `MovieDetail`, `TvDetail`

**tmdb.utils.ts** -- Utility functions:
- `tmdbImageUrl(path: string | null | undefined, size?: ValidSize): string | null`
- Valid sizes: `"w92" | "w154" | "w185" | "w342" | "w500" | "w780" | "original"`
- Default size: `"w500"`
- Returns null if path is null/undefined
- Returns `https://image.tmdb.org/t/p/{size}{path}` otherwise

**tmdb.client.ts** -- TmdbClient class following SonarrClient pattern:
- Constructor takes `accessToken: string`
- `movieGenres: GenreMap` and `tvGenres: GenreMap` initialized as empty Maps
- `loadGenres(): Promise<void>` -- fetches `/3/genre/movie/list` and `/3/genre/tv/list` in parallel, populates genre maps (lowercase name -> ID)
- `resolveGenreId(name: string, type: "movie" | "tv"): number | undefined` -- exact match first, then fuzzy (includes) match
- `searchPerson(query: string): Promise<PersonSearchResult | null>` -- returns first result or null
- `discoverMovies(params)` and `discoverTv(params)` -- translate camelCase params to TMDB snake_case query params, call tmdbRequest with appropriate schemas
- `getMovieDetails(tmdbId: number)` and `getTvDetails(tmdbId: number)` -- for routing metadata
- Follow the exact method signatures and parameter mapping from the research document
  </action>
  <verify>
Run `npx tsc --noEmit` -- all five new files compile without errors. Verify the tmdb/ directory has all five files. Run `npx biome check src/media/tmdb/` for lint compliance.
  </verify>
  <done>
TmdbClient class exists with genre caching, person search, movie/TV discovery, and detail retrieval methods. All Zod schemas validate TMDB API response shapes. Image URL utility handles null paths and valid sizes. HTTP helper uses Bearer token auth with proper error classification.
  </done>
</task>

<task type="auto">
  <name>Task 2: discover_media tool, Fastify plugin, and wiring</name>
  <files>
    src/conversation/tools/discover-media.ts
    src/conversation/tools/index.ts
    src/conversation/types.ts
    src/plugins/tmdb.ts
    src/plugins/conversation.ts
    src/config.ts
    src/conversation/system-prompt.ts
  </files>
  <action>
Wire the TMDB client into the application and create the discover_media tool:

**src/config.ts** -- Add optional TMDB env var to the envSchema:
- `TMDB_ACCESS_TOKEN: z.string().min(1).optional()` -- TMDB API v3 read access token (Bearer auth)

**src/conversation/types.ts** -- Extend ToolContext:
- Add `tmdb?: import("../media/tmdb/tmdb.client.js").TmdbClient` to the ToolContext interface (same lazy import pattern as sonarr/radarr)

**src/plugins/tmdb.ts** -- Fastify plugin following sonarr.ts pattern:
- Declare module augmentation: `fastify.tmdb?: TmdbClient`
- If `TMDB_ACCESS_TOKEN` not set, log warning and return (graceful skip)
- Create `new TmdbClient(TMDB_ACCESS_TOKEN)`
- Call `await client.loadGenres()` wrapped in try/catch (log error, register client anyway -- genres will be empty but client still usable for detail lookups)
- `fastify.decorate("tmdb", client)`
- Log genre counts: `{ movieGenres: client.movieGenres.size, tvGenres: client.tvGenres.size }`
- Dependencies: `["database"]` (consistent with other plugins)

**src/conversation/tools/discover-media.ts** -- Single compound tool:
- Name: `discover_media`
- Description: `"Discover movies or TV shows by genre, actor, year, language, or keyword. Use for requests like 'sci-fi movies from the 90s', 'what has Oscar Isaac been in', or 'Korean dramas'. NOT for title search -- use search_movies/search_series for title lookups."`
- Parameters (all optional except type):
  - `type: z.enum(["movie", "tv"])` -- Whether to discover movies or TV shows
  - `genre: z.string().optional()` -- Genre name (e.g. "sci-fi", "comedy", "horror")
  - `actor: z.string().optional()` -- Actor name (e.g. "Oscar Isaac")
  - `yearFrom: z.number().optional()` -- Earliest release year
  - `yearTo: z.number().optional()` -- Latest release year
  - `language: z.string().optional()` -- Original language ISO 639-1 code (e.g. "ko", "ja")
  - `keyword: z.string().optional()` -- Theme or keyword (e.g. "time travel")
- Tier: `"safe"`
- Executor logic:
  1. If `!context.tmdb`, return `{ error: "TMDB is not configured (set TMDB_ACCESS_TOKEN)" }`
  2. If `args.genre`, resolve via `context.tmdb.resolveGenreId(args.genre, args.type)` -- if not found, log but continue (genre filter silently omitted, better than error)
  3. If `args.actor`, resolve via `context.tmdb.searchPerson(args.actor)` -- if not found, return `{ error: \`Could not find actor "${args.actor}" on TMDB\` }`
  4. For movie: call `discoverMovies` with genre ID, cast ID, date range from yearFrom/yearTo, language, sortBy "popularity.desc", voteCountGte 50
  5. For TV: call `discoverTv` with genre ID, date range, language, sortBy "popularity.desc", voteCountGte 50
  6. Map results (slice to top 8): `{ title, year (from release_date/first_air_date), tmdbId (the id field), overview (truncated to 150 chars), rating (vote_average), posterUrl (via tmdbImageUrl), language (original_language) }`. For TV, also include `originCountry`.
  7. Return `{ results: [...], totalResults: response.total_results }`
- Follow the exact executor logic from the research document

**src/conversation/tools/index.ts** -- Add export:
- `export { discoverMediaTool } from "./discover-media.js";`

**src/plugins/conversation.ts** -- Register new tool and pass TMDB to context:
- Import `discoverMediaTool` from the tools barrel
- Add `registry.register(discoverMediaTool)` after existing registrations
- The ToolContext wiring happens in the tool-loop.ts where context is built -- but verify it already passes `fastify.tmdb` to the context. If not, find where ToolContext is constructed (likely in the webhook handler or processConversation) and add `tmdb: fastify.tmdb`.

**Important: Find where ToolContext is built** -- likely in `src/routes/webhook.ts` or `src/conversation/engine.ts` or wherever `processConversation` is called. Add `tmdb: fastify.tmdb` to the context object. Read the file first to find the exact location.

**src/conversation/system-prompt.ts** -- Add discovery guidance after existing capabilities:
- Add to capabilities list: `- Discover movies and TV shows by genre, actor, year, or language (TMDB)`
- Add new section after "Search behavior":
```
Discovery behavior:
- Use discover_media for browsing/filtering queries (genre, actor, year, language) -- NOT for title search.
- Always include type (movie or tv) based on what the user is asking for. If unclear, default to "movie".
- For actor queries ("what has X been in"), pass the actor name and let TMDB resolve it.
- For genre queries, use common genre names: sci-fi, comedy, drama, horror, thriller, action, animation, documentary, romance, mystery, fantasy, crime, western, war.
- For year range queries ("90s movies"), translate to yearFrom=1990, yearTo=1999.
- Include the rating and year when presenting discovery results.
- If discovery returns no results, suggest the user try web_search for vague queries.
```
  </action>
  <verify>
Run `npx tsc --noEmit` -- all modified files compile. Run `npx biome check src/` for lint compliance. Verify the plugin loads by checking that the tmdb plugin file follows the same Fastify plugin pattern as sonarr.ts. Count tools in conversation plugin -- should be 11 (10 existing + discover_media).
  </verify>
  <done>
discover_media tool is registered and callable. ToolContext includes optional tmdb field. Fastify tmdb plugin creates and decorates TmdbClient with genre cache loaded at startup. Config accepts optional TMDB_ACCESS_TOKEN. System prompt guides LLM on when to use discover_media vs search tools. App starts gracefully without TMDB_ACCESS_TOKEN.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npx biome check src/` passes with zero errors
3. All 5 files in `src/media/tmdb/` exist and export expected symbols
4. `src/conversation/tools/discover-media.ts` exports `discoverMediaTool`
5. `src/plugins/tmdb.ts` follows identical pattern to `src/plugins/sonarr.ts` (graceful skip when unconfigured)
6. `src/config.ts` includes `TMDB_ACCESS_TOKEN` as optional
7. `src/conversation/types.ts` ToolContext includes `tmdb?` field
8. `src/plugins/conversation.ts` registers discoverMediaTool (total tool count = 11)
9. System prompt includes discovery behavior guidance
</verification>

<success_criteria>
- TmdbClient class fully implemented with genre caching, person search, discovery (movie + TV), and detail methods
- discover_media tool accepts type, genre, actor, yearFrom, yearTo, language, keyword params
- TMDB client integrated into Fastify via plugin with graceful degradation
- Tool count is 11 (10 existing + 1 new discover_media)
- All code compiles and lints cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/09-tmdb-discovery-library-routing/09-01-SUMMARY.md`
</output>
