---
phase: 09-tmdb-discovery-library-routing
plan: 03
type: tdd
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/media/routing/library-router.ts
  - src/media/routing/library-router.types.ts
  - src/media/radarr/radarr.schemas.ts
  - src/conversation/tools/add-series.ts
  - src/conversation/tools/add-movie.ts
  - src/config.ts
  - src/conversation/system-prompt.ts
  - tests/routing.test.ts
autonomous: true

must_haves:
  truths:
    - "Anime series (Japanese language + Animation genre) are routed to the anime root folder automatically"
    - "Non-anime series are routed to the default (first) root folder"
    - "Asian-language movies are routed to the CMovies root folder automatically"
    - "Non-Asian-language movies are routed to the default (first) root folder"
    - "User can override routing via libraryOverride parameter on add_series and add_movie"
    - "System defaults to 1080p quality profile when available (matched by name containing '1080')"
    - "Routing falls back gracefully when hint folders are not found (uses first folder)"
  artifacts:
    - path: "src/media/routing/library-router.ts"
      provides: "Pure routing functions routeSeries and routeMovie"
      exports: ["routeSeries", "routeMovie"]
    - path: "src/media/routing/library-router.types.ts"
      provides: "RoutingDecision, SeriesRoutingMetadata, MovieRoutingMetadata types"
      exports: ["RoutingDecision", "SeriesRoutingMetadata", "MovieRoutingMetadata"]
    - path: "tests/routing.test.ts"
      provides: "Unit tests for routing pure functions"
      contains: "describe.*routeSeries|describe.*routeMovie"
  key_links:
    - from: "src/conversation/tools/add-series.ts"
      to: "src/media/routing/library-router.ts"
      via: "routeSeries() called with metadata"
      pattern: "routeSeries\\("
    - from: "src/conversation/tools/add-movie.ts"
      to: "src/media/routing/library-router.ts"
      via: "routeMovie() called with metadata"
      pattern: "routeMovie\\("
    - from: "src/conversation/tools/add-series.ts"
      to: "user libraryOverride param"
      via: "optional Zod parameter on add_series"
      pattern: "libraryOverride"
    - from: "src/conversation/tools/add-movie.ts"
      to: "user libraryOverride param"
      via: "optional Zod parameter on add_movie"
      pattern: "libraryOverride"
---

<objective>
Implement smart library routing as pure functions with TDD, then integrate into add_series and add_movie tools.

Purpose: Satisfies ROUT-01 (anime auto-detection for Sonarr), ROUT-02 (Asian-language auto-detection for Radarr), ROUT-03 (user override), and ROUT-04 (default 1080p quality). Routing is the most testable logic in Phase 9 -- pure functions with defined I/O make this a natural TDD candidate.

Output: Tested routing functions, modified add tools with routing integration, libraryOverride parameter on add tools.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-tmdb-discovery-library-routing/09-RESEARCH.md
@.planning/phases/09-tmdb-discovery-library-routing/09-01-SUMMARY.md

Key source files:
@src/conversation/tools/add-series.ts (to modify with routing)
@src/conversation/tools/add-movie.ts (to modify with routing)
@src/media/sonarr/sonarr.types.ts (RootFolder, QualityProfile, AddSeriesInput types)
@src/media/radarr/radarr.types.ts (RootFolder, QualityProfile, AddMovieInput types)
@src/media/radarr/radarr.schemas.ts (needs originalLanguage field added)
@src/config.ts (needs routing hint env vars)
@src/conversation/system-prompt.ts (needs routing override guidance)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Routing types, pure functions, and unit tests (TDD)</name>
  <files>
    src/media/routing/library-router.types.ts
    src/media/routing/library-router.ts
    tests/routing.test.ts
  </files>
  <action>
Implement routing logic using RED-GREEN-REFACTOR TDD cycle:

**RED phase -- Write failing tests first in `tests/routing.test.ts`:**

Create test file with the following test cases for `routeSeries`:
1. `"routes anime (Japanese + Animation genre) to anime folder"` -- input: genres=["Animation","Action"], originalLanguage="ja", animeRootFolderHint="anime" with rootFolders=[{id:1,path:"/tv"},{id:2,path:"/tv/anime"}] -> expect rootFolderPath="/tv/anime", seriesType="anime"
2. `"routes non-anime to default folder"` -- input: genres=["Drama"], originalLanguage="en" -> expect rootFolderPath="/tv" (first folder), seriesType="standard"
3. `"does not misclassify Animation without Japanese language"` -- input: genres=["Animation"], originalLanguage="en" -> expect rootFolderPath="/tv", seriesType="standard"
4. `"does not misclassify Japanese without Animation genre"` -- input: genres=["Drama","Action"], originalLanguage="ja" -> expect rootFolderPath="/tv", seriesType="standard"
5. `"falls back to first folder when anime hint folder not found"` -- input: anime signals present but animeRootFolderHint="animefolder" with rootFolders=[{id:1,path:"/tv"}] (no match) -> expect rootFolderPath="/tv"
6. `"detects anime from explicit 'Anime' genre string regardless of language"` -- input: genres=["Anime","Action"], originalLanguage="en" -> expect rootFolderPath="/tv/anime", seriesType="anime"

Create test cases for `routeMovie`:
1. `"routes Japanese movie to CMovies folder"` -- input: originalLanguage="ja", cmoviesRootFolderHint="cmovies" with rootFolders=[{id:1,path:"/movies"},{id:2,path:"/movies/cmovies"}] -> expect rootFolderPath="/movies/cmovies"
2. `"routes Korean movie to CMovies folder"` -- input: originalLanguage="ko" -> expect CMovies folder
3. `"routes Chinese movie to CMovies folder"` -- input: originalLanguage="zh" -> expect CMovies folder
4. `"routes English movie to default folder"` -- input: originalLanguage="en" -> expect rootFolderPath="/movies" (first folder)
5. `"falls back to first folder when CMovies hint folder not found"` -- input: Asian language but hint folder not in rootFolders -> expect first folder
6. `"routes Thai, Hindi, Tamil, Telugu, Vietnamese, Malay, Tagalog, Indonesian to CMovies"` -- test all Asian languages from research: th, hi, ta, te, vi, ms, tl, id

Create test cases for `findQualityProfile` (helper used by both):
1. `"selects profile matching '1080' hint"` -- profiles=[{id:1,name:"Any"},{id:2,name:"HD-1080p"}], hint="1080" -> expect id=2
2. `"falls back to first profile when hint not found"` -- profiles=[{id:1,name:"Any"}], hint="4K" -> expect id=1
3. `"matches case-insensitively"` -- profiles=[{id:1,name:"HD-1080P"}], hint="1080p" -> expect id=1

Run tests -- they should ALL FAIL (RED).

**GREEN phase -- Implement routing functions:**

**src/media/routing/library-router.types.ts:**
```typescript
export interface RoutingDecision {
  rootFolderPath: string;
  qualityProfileId: number;
  seriesType?: "standard" | "daily" | "anime";
  reason: string;
}

export interface SeriesRoutingMetadata {
  genres: string[];
  originalLanguage?: string;
  network?: string | null;
}

export interface MovieRoutingMetadata {
  originalLanguage: string;
  genres: string[];
}

export interface RoutingConfig {
  animeRootFolderHint?: string;
  cmoviesRootFolderHint?: string;
  defaultQualityHint?: string;
}
```

**src/media/routing/library-router.ts:**
- `findQualityProfile(profiles: QualityProfile[], hint?: string): number` -- case-insensitive includes match on profile name, falls back to `profiles[0].id`
- Import `QualityProfile` and `RootFolder` types from sonarr types (they are structurally identical to radarr types -- use sonarr's since it is the same shape `{ id: number, name: string }` and `{ id: number, path: string }`)
- `routeSeries(metadata: SeriesRoutingMetadata, rootFolders: RootFolder[], qualityProfiles: QualityProfile[], config: RoutingConfig): RoutingDecision`
  - Anime detection: TWO signals required -- (1) `originalLanguage === "ja"` AND (2) genres includes "animation" (case-insensitive). OR: genres includes "anime" (case-insensitive) regardless of language (strong signal from TheTVDB).
  - If anime detected and animeRootFolderHint provided, find folder whose path includes the hint (case-insensitive). If found, use it. If not found, fall back to first folder.
  - If not anime, use first root folder.
  - Always use `findQualityProfile(qualityProfiles, config.defaultQualityHint)` for quality.
  - Return RoutingDecision with `reason` explaining the classification.
- `routeMovie(metadata: MovieRoutingMetadata, rootFolders: RootFolder[], qualityProfiles: QualityProfile[], config: RoutingConfig): RoutingDecision`
  - Asian language list: `["ja", "ko", "zh", "th", "hi", "ta", "te", "vi", "ms", "tl", "id"]` (from research)
  - If `originalLanguage` is in the Asian language list AND cmoviesRootFolderHint is provided, find folder whose path includes the hint (case-insensitive). If found, use it. If not, fall back to first folder.
  - Otherwise, use first root folder.
  - Always use `findQualityProfile(qualityProfiles, config.defaultQualityHint)`.
  - Return RoutingDecision with `reason`.

Run tests -- they should ALL PASS (GREEN).

**REFACTOR phase:** Clean up if needed, ensure all tests still pass.
  </action>
  <verify>
Run `npx vitest run tests/routing.test.ts` -- all tests pass. Run `npx tsc --noEmit` -- compiles. Run `npx biome check src/media/routing/` -- lints clean.
  </verify>
  <done>
Pure routing functions exist with full test coverage. routeSeries correctly detects anime via two-signal rule (Japanese + Animation) or explicit "Anime" genre. routeMovie correctly detects Asian-language movies for CMovies routing. findQualityProfile selects 1080p profile by hint. All edge cases covered (fallbacks, missing folders, case sensitivity).
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate routing into add tools with override parameter</name>
  <files>
    src/media/radarr/radarr.schemas.ts
    src/conversation/tools/add-series.ts
    src/conversation/tools/add-movie.ts
    src/config.ts
    src/conversation/system-prompt.ts
  </files>
  <action>
Wire routing functions into the existing add tools and add override support:

**src/media/radarr/radarr.schemas.ts** -- Add originalLanguage to MovieLookupSchema:
- Add `originalLanguage: z.object({ id: z.number(), name: z.string() }).optional()` to the MovieLookupSchema object
- This makes the routing type-safe instead of relying on `.passthrough()` runtime data
- Keep the `.passthrough()` on the overall schema (tolerance for other unknown fields)

**src/config.ts** -- Add routing hint env vars:
- `SONARR_ANIME_ROOT_FOLDER_HINT: z.string().default("anime")` -- Substring to match in Sonarr root folder paths for anime
- `RADARR_CMOVIES_ROOT_FOLDER_HINT: z.string().default("cmovies")` -- Substring to match in Radarr root folder paths for CMovies
- `DEFAULT_QUALITY_PROFILE_HINT: z.string().default("1080")` -- Substring to match in quality profile names

**src/conversation/tools/add-series.ts** -- Replace hardcoded defaults with routing:
1. Add `libraryOverride: z.enum(["anime", "tv"]).optional().describe("Override auto-detected library routing. Use 'anime' to force anime library, 'tv' to force regular TV library.")` to the Zod params
2. Import `routeSeries` from `../../media/routing/library-router.js` and `SeriesRoutingMetadata` from `../../media/routing/library-router.types.js`
3. After the Sonarr lookup (the `const series = results.find(...)` line), build routing metadata:
   ```
   const routingMeta: SeriesRoutingMetadata = {
     genres: series.genres,
     network: series.network ?? null,
   };
   ```
   NOTE: Sonarr lookup already returns `genres` and `network`. The `originalLanguage` is NOT available from Sonarr lookup -- leave it undefined. This means routing relies on genres alone (which includes the "Anime" string from TheTVDB when applicable). If TMDB is available on context, optionally enrich with `originalLanguage` by searching TMDB by title (but this is a stretch goal -- the genre-based detection should be sufficient for v1).
4. If `args.libraryOverride` is provided, bypass routing:
   - `"anime"`: find rootFolder matching anime hint, use seriesType "anime"
   - `"tv"`: use first rootFolder, use seriesType "standard"
5. Otherwise, call `routeSeries(routingMeta, context.sonarr.rootFolders, context.sonarr.qualityProfiles, { animeRootFolderHint: config.SONARR_ANIME_ROOT_FOLDER_HINT, defaultQualityHint: config.DEFAULT_QUALITY_PROFILE_HINT })`
6. Replace the hardcoded `qualityProfile = context.sonarr.qualityProfiles[0]` and `rootFolder = context.sonarr.rootFolders[0]` with the routing decision values
7. Pass `seriesType: routing.seriesType` in the addSeries call (this is critical for Sonarr to use anime-style absolute episode numbering)
8. Include `routing.reason` in the success response so the LLM can tell the user where it was placed

**How to access config from tool executor:** The tool executor receives `(args, context)`. The config is NOT currently on ToolContext. Two options:
- Option A (preferred): Add `config: AppConfig` to ToolContext interface in types.ts and pass it when building context
- Option B: Import `loadConfig` directly (breaks pattern)
Use Option A. Add `config: import("../config.js").AppConfig` to ToolContext in types.ts. Pass `config: fastify.config` where ToolContext is built (same location where sonarr/radarr/tmdb/brave are passed).

**src/conversation/tools/add-movie.ts** -- Replace hardcoded defaults with routing:
1. Add `libraryOverride: z.enum(["movies", "cmovies"]).optional().describe("Override auto-detected library routing. Use 'cmovies' to force Asian movies library, 'movies' to force regular movies library.")` to the Zod params
2. Import `routeMovie` from `../../media/routing/library-router.js` and `MovieRoutingMetadata` from `../../media/routing/library-router.types.js`
3. After the Radarr lookup (`const movie = await context.radarr.lookupByTmdbId(...)`), build routing metadata:
   ```
   const routingMeta: MovieRoutingMetadata = {
     originalLanguage: movie.originalLanguage?.name?.toLowerCase() ?? "en",
     genres: movie.genres,
   };
   ```
   Wait -- the research says `originalLanguage` from Radarr is `{ id: number, name: string }` but the Asian language check uses ISO 639-1 codes (2-letter like "ja", "ko"). The `name` field is the full language name ("Japanese", "Korean"), not the ISO code. We need the ISO code. Options:
   - The `.passthrough()` data from Radarr may include `originalLanguage.name` as the language name. The research lists Asian languages by ISO code. We need to map.
   - Better approach: Use `movie.originalLanguage?.name` but build the ASIAN_LANGUAGES list using full language names as well as ISO codes for matching flexibility. OR: just use the Radarr `originalLanguage` structure as-is and match by name.
   - Simplest: Change `MovieRoutingMetadata.originalLanguage` to accept the language name string AND add a `ASIAN_LANGUAGE_NAMES` set alongside the ISO codes: `["japanese", "korean", "chinese", "thai", "hindi", "tamil", "telugu", "vietnamese", "malay", "tagalog", "indonesian"]`. Match case-insensitively.
   - Also: TMDB detail response (accessible via `context.tmdb?.getMovieDetails(tmdbId)`) returns `original_language` as ISO 639-1 code. If TMDB is available, prefer it. If not, fall back to Radarr language name matching.

   Implementation: In `routeMovie`, accept both ISO codes AND full names. The function checks `originalLanguage` against BOTH the ISO list and the name list. In the add-movie executor:
   ```
   // Prefer TMDB ISO code if available, fall back to Radarr language name
   let langForRouting: string;
   if (context.tmdb) {
     try {
       const tmdbDetails = await context.tmdb.getMovieDetails(args.tmdbId);
       langForRouting = tmdbDetails.original_language; // ISO 639-1 code
     } catch {
       langForRouting = movie.originalLanguage?.name ?? "English";
     }
   } else {
     langForRouting = movie.originalLanguage?.name ?? "English";
   }
   ```
4. If `args.libraryOverride` is provided, bypass routing:
   - `"cmovies"`: find rootFolder matching cmovies hint
   - `"movies"`: use first rootFolder
5. Otherwise, call `routeMovie(routingMeta, context.radarr.rootFolders, context.radarr.qualityProfiles, { cmoviesRootFolderHint: config.RADARR_CMOVIES_ROOT_FOLDER_HINT, defaultQualityHint: config.DEFAULT_QUALITY_PROFILE_HINT })`
6. Replace hardcoded quality/rootFolder with routing decision values
7. Include `routing.reason` in success response

**Update library-router.ts** -- Make `routeMovie` accept both ISO codes and language names:
- ASIAN_LANGUAGE_CODES: `["ja", "ko", "zh", "th", "hi", "ta", "te", "vi", "ms", "tl", "id"]`
- ASIAN_LANGUAGE_NAMES: `["japanese", "korean", "chinese", "mandarin", "cantonese", "thai", "hindi", "tamil", "telugu", "vietnamese", "malay", "tagalog", "indonesian"]`
- Check: `ASIAN_LANGUAGE_CODES.includes(lang.toLowerCase()) || ASIAN_LANGUAGE_NAMES.includes(lang.toLowerCase())`

**src/conversation/system-prompt.ts** -- Add routing guidance:
- Add to library management section:
```
Library routing:
- When adding a TV show, the system automatically detects anime (Japanese + Animation genre) and routes to the anime library folder. Tell the user where it was routed.
- When adding a movie, the system automatically detects Asian-language films and routes to the appropriate library folder. Tell the user where it was routed.
- If the user says "add this to the anime library" or "put this in regular TV", pass the libraryOverride parameter to override auto-detection.
- For add_series: libraryOverride can be "anime" or "tv".
- For add_movie: libraryOverride can be "cmovies" or "movies".
- Default quality profile is 1080p. Only change if the user explicitly requests a different quality.
```
  </action>
  <verify>
Run `npx vitest run tests/routing.test.ts` -- all tests still pass (including new tests for language name matching). Run `npx tsc --noEmit` -- compiles. Run `npx biome check src/` -- lints clean. Verify add_series.ts calls routeSeries. Verify add_movie.ts calls routeMovie. Verify both tools have libraryOverride parameter.
  </verify>
  <done>
add_series uses routeSeries for automatic anime detection and routing. add_movie uses routeMovie for automatic Asian-language detection and routing. Both tools accept libraryOverride parameter for user override. Quality profile defaults to 1080p match. Radarr schema includes typed originalLanguage field. System prompt guides LLM on routing behavior and override syntax. All routing tests pass.
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run` -- all tests pass (routing tests + any existing tests)
2. `npx tsc --noEmit` -- zero errors
3. `npx biome check src/` -- zero errors
4. `src/media/routing/library-router.ts` exports `routeSeries` and `routeMovie`
5. `src/conversation/tools/add-series.ts` calls `routeSeries()` and has `libraryOverride` param
6. `src/conversation/tools/add-movie.ts` calls `routeMovie()` and has `libraryOverride` param
7. `src/media/radarr/radarr.schemas.ts` includes `originalLanguage` field
8. `src/config.ts` includes `SONARR_ANIME_ROOT_FOLDER_HINT`, `RADARR_CMOVIES_ROOT_FOLDER_HINT`, `DEFAULT_QUALITY_PROFILE_HINT`
9. System prompt includes routing guidance
</verification>

<success_criteria>
- Anime auto-detection works for Japanese + Animation genre OR explicit "Anime" genre
- Asian-language movies auto-detected and routed to CMovies folder
- User can override routing via libraryOverride on both add tools
- 1080p quality profile selected by default
- All routing edge cases tested (fallback, missing folders, case insensitivity)
- Existing add_series and add_movie functionality preserved (no regression)
</success_criteria>

<output>
After completion, create `.planning/phases/09-tmdb-discovery-library-routing/09-03-SUMMARY.md`
</output>
