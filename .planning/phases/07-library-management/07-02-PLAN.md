---
phase: 07-library-management
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/conversation/system-prompt.ts
  - src/plugins/conversation.ts
autonomous: true

must_haves:
  truths:
    - "System prompt instructs the LLM to use tmdbId/tvdbId from search results when adding media"
    - "System prompt instructs the LLM to use libraryId (not tmdbId/tvdbId) from search results when removing media"
    - "System prompt instructs the LLM to resolve anaphoric references ('add that one', 'the second one') from previous search results"
    - "System prompt instructs the LLM to not ask about quality profiles or root folders (sensible defaults applied automatically)"
    - "All four library management tools are registered in the ToolRegistry alongside existing search tools"
  artifacts:
    - path: "src/conversation/system-prompt.ts"
      provides: "Library management guidance in system prompt"
      contains: "libraryId"
    - path: "src/plugins/conversation.ts"
      provides: "Registration of addMovieTool, addSeriesTool, removeMovieTool, removeSeriesTool"
      contains: "addMovieTool"
  key_links:
    - from: "src/plugins/conversation.ts"
      to: "src/conversation/tools/index.ts"
      via: "import and registry.register() for all 4 new tools"
      pattern: "registry\\.register\\(addMovieTool\\)"
    - from: "src/conversation/system-prompt.ts"
      to: "LLM behavior for library management"
      via: "System prompt text sections"
      pattern: "libraryId|tmdbId|tvdbId"
---

<objective>
Update the system prompt with library management guidance and register all four new tools in the conversation plugin.

Purpose: The system prompt guides the LLM on how to use add/remove tools correctly (using IDs from search results, not asking about quality profiles, resolving conversational references). Tool registration wires the new tools into the conversation engine so they are available during LLM interactions. This plan also addresses LIB-04 (context reference resolution) entirely through system prompt guidance -- no custom code needed since the LLM reads its own conversation history.

Output: Updated system prompt and conversation plugin with all library management tools registered.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-library-management/07-RESEARCH.md
@.planning/phases/07-library-management/07-01-SUMMARY.md
@.planning/phases/06-search-and-discovery/06-02-SUMMARY.md

Source files to reference:
@src/conversation/system-prompt.ts (existing system prompt to extend)
@src/plugins/conversation.ts (existing plugin to add tool registrations)
@src/conversation/tools/index.ts (barrel index with all 8 tool exports)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update system prompt with library management and context resolution guidance</name>
  <files>src/conversation/system-prompt.ts</files>
  <action>
Extend the existing `SYSTEM_PROMPT` string in `src/conversation/system-prompt.ts` by adding a new section after the "Response format:" section. Add these two new sections:

```
Library management:
- When the user wants to add a movie, call add_movie with the tmdbId from search_movies results.
- When the user wants to add a TV show, call add_series with the tvdbId from search_series results.
- Sensible defaults for quality profile and download path are applied automatically. Do not ask the user about these settings.
- For remove operations, use the libraryId from search results (where inLibrary is true), NOT the tmdbId or tvdbId.
- Always tell the user what was added (title, year) and confirm that a search for downloads has started.
- If a movie or show is already in the library, tell the user instead of trying to add it again.

Conversational context:
- If the user refers to a previous search result ("add that one", "add it", "the second one", "number 3"), use the corresponding tmdbId or tvdbId from those results.
- If the user says "remove that" or "delete the first one" after a search, use the libraryId from the in-library result.
- When context is ambiguous, ask the user to clarify which result they mean.
```

Keep ALL existing content (role, capabilities, search behavior, response format sections) intact. Append these two new sections at the end, before the final backtick of the template literal.

The "Conversational context" section addresses LIB-04 (context reference resolution) purely through LLM instruction -- the LLM reads its own conversation history where previous tool results (with numbered items, tmdbIds, tvdbIds, libraryIds) are preserved.
  </action>
  <verify>Run `npx tsc --noEmit` -- file compiles. Run `npx biome check src/conversation/system-prompt.ts` -- no lint errors. Verify the system prompt contains "libraryId", "tmdbId", "tvdbId", "add that one", "the second one".</verify>
  <done>System prompt contains library management guidance and conversational context resolution instructions. All existing sections preserved.</done>
</task>

<task type="auto">
  <name>Task 2: Register all four library management tools in conversation plugin</name>
  <files>src/plugins/conversation.ts</files>
  <action>
Modify `src/plugins/conversation.ts`:

1. Update the import from `"../conversation/tools/index.js"` to include the four new tools:
   ```typescript
   import {
     addMovieTool,
     addSeriesTool,
     getUpcomingEpisodesTool,
     getUpcomingMoviesTool,
     removeMovieTool,
     removeSeriesTool,
     searchMoviesTool,
     searchSeriesTool,
   } from "../conversation/tools/index.js";
   ```

2. Add four `registry.register()` calls after the existing four registrations:
   ```typescript
   registry.register(addMovieTool);
   registry.register(addSeriesTool);
   registry.register(removeMovieTool);
   registry.register(removeSeriesTool);
   ```

The log line `{ model: LLM_MODEL, tools: registry.getDefinitions().length }` will automatically report the new count (9 total: check_status + 4 search/discovery + 4 library management).
  </action>
  <verify>Run `npx tsc --noEmit` -- file compiles. Run `npx biome check src/plugins/conversation.ts` -- no lint errors. Verify the file contains 8 `registry.register()` calls (4 existing + 4 new).</verify>
  <done>All four library management tools registered in ToolRegistry. Conversation plugin imports and registers addMovieTool, addSeriesTool, removeMovieTool, removeSeriesTool.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npx biome check src/conversation/system-prompt.ts src/plugins/conversation.ts` passes
3. System prompt mentions libraryId, tmdbId, tvdbId for correct ID usage
4. System prompt has conversational context guidance ("add that one", "the second one")
5. conversation.ts has 8 registry.register() calls
6. conversation.ts imports all 8 tools from barrel index
</verification>

<success_criteria>
- System prompt guides LLM to use tmdbId/tvdbId for add operations, libraryId for remove operations
- System prompt instructs LLM to resolve anaphoric references from conversation history
- System prompt tells LLM not to ask about quality profiles or root folders
- All 4 new library management tools are registered in ToolRegistry (9 tools total including check_status)
- All files compile and pass lint
</success_criteria>

<output>
After completion, create `.planning/phases/07-library-management/07-02-SUMMARY.md`
</output>
