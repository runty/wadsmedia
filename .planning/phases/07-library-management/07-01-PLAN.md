---
phase: 07-library-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/conversation/tools/add-movie.ts
  - src/conversation/tools/add-series.ts
  - src/conversation/tools/remove-movie.ts
  - src/conversation/tools/remove-series.ts
  - src/conversation/tools/search-movies.ts
  - src/conversation/tools/search-series.ts
  - src/conversation/tools/index.ts
autonomous: true

must_haves:
  truths:
    - "add_movie tool takes a tmdbId, looks up the movie, applies quality/path defaults from cached config, and POSTs to Radarr"
    - "add_series tool takes a tvdbId, looks up the series via tvdb: prefix search, applies quality/path defaults from cached config, and POSTs to Sonarr"
    - "remove_movie tool takes a Radarr library ID and optional deleteFiles flag, classified as destructive tier"
    - "remove_series tool takes a Sonarr library ID and optional deleteFiles flag, classified as destructive tier"
    - "Search tools return libraryId when media is already in library, enabling the remove flow"
  artifacts:
    - path: "src/conversation/tools/add-movie.ts"
      provides: "add_movie tool definition"
      exports: ["addMovieTool"]
    - path: "src/conversation/tools/add-series.ts"
      provides: "add_series tool definition"
      exports: ["addSeriesTool"]
    - path: "src/conversation/tools/remove-movie.ts"
      provides: "remove_movie tool definition with destructive tier"
      exports: ["removeMovieTool"]
    - path: "src/conversation/tools/remove-series.ts"
      provides: "remove_series tool definition with destructive tier"
      exports: ["removeSeriesTool"]
    - path: "src/conversation/tools/index.ts"
      provides: "Barrel re-export of all 8 tools"
  key_links:
    - from: "src/conversation/tools/add-movie.ts"
      to: "RadarrClient.lookupByTmdbId + addMovie"
      via: "context.radarr method calls"
      pattern: "context\\.radarr\\.lookupByTmdbId|context\\.radarr\\.addMovie"
    - from: "src/conversation/tools/add-series.ts"
      to: "SonarrClient.searchSeries + addSeries"
      via: "context.sonarr method calls with tvdb: prefix"
      pattern: "context\\.sonarr\\.searchSeries|context\\.sonarr\\.addSeries"
    - from: "src/conversation/tools/remove-movie.ts"
      to: "RadarrClient.removeMovie"
      via: "context.radarr.removeMovie with destructive tier"
      pattern: "context\\.radarr\\.removeMovie"
    - from: "src/conversation/tools/remove-series.ts"
      to: "SonarrClient.removeSeries"
      via: "context.sonarr.removeSeries with destructive tier"
      pattern: "context\\.sonarr\\.removeSeries"
---

<objective>
Create all four library management tool definitions (add_movie, add_series, remove_movie, remove_series) and extend existing search tools with libraryId for the remove flow.

Purpose: These tools enable users to add and remove media from their Sonarr/Radarr libraries through natural conversation. The add tools use sensible defaults from cached server config (first quality profile, first root folder) so users never need to specify these. The remove tools use "destructive" tier to trigger the existing confirmation system.

Output: Six tool files (4 new, 2 modified), updated barrel index.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-library-management/07-RESEARCH.md
@.planning/phases/06-search-and-discovery/06-01-SUMMARY.md

Source files to reference:
@src/conversation/tools.ts (defineTool, ToolRegistry)
@src/conversation/types.ts (ToolContext, ConfirmationTier)
@src/conversation/tools/search-movies.ts (existing search_movies tool to modify)
@src/conversation/tools/search-series.ts (existing search_series tool to modify)
@src/conversation/tools/index.ts (barrel index to extend)
@src/media/radarr/radarr.client.ts (addMovie, removeMovie, lookupByTmdbId, qualityProfiles, rootFolders)
@src/media/sonarr/sonarr.client.ts (addSeries, removeSeries, searchSeries, qualityProfiles, rootFolders)
@src/media/sonarr/sonarr.types.ts (AddSeriesInput -- requires title, tvdbId, qualityProfileId, rootFolderPath, titleSlug, images, seasons, monitored)
@src/media/radarr/radarr.types.ts (AddMovieInput -- requires title, tmdbId, qualityProfileId, rootFolderPath, monitored, minimumAvailability)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create add_movie and add_series tool definitions</name>
  <files>
    src/conversation/tools/add-movie.ts
    src/conversation/tools/add-series.ts
  </files>
  <action>
Create `src/conversation/tools/add-movie.ts`:

Follow the exact `defineTool()` pattern from `search-movies.ts`. The tool:
- Name: `"add_movie"`
- Description: `"Add a movie to the wanted/download list by its TMDB ID. Automatically applies sensible quality and path defaults. Searches for the movie immediately after adding. Use when the user wants to add, download, get, or request a movie."`
- Parameters: `z.object({ tmdbId: z.number().describe("The TMDB ID of the movie to add (from search_movies results)") })`
- Tier: `"safe"` (adding is not destructive)
- Executor:
  1. Null-check `context.radarr` -> return `{ error: "Movie server (Radarr) is not configured" }`
  2. Call `context.radarr.lookupByTmdbId(args.tmdbId)` to get full movie data
  3. Check if already in library: `if (movie.id > 0)` -> return `{ alreadyInLibrary: true, title, year, message }`
  4. Get defaults: `context.radarr.qualityProfiles[0]` and `context.radarr.rootFolders[0]`
  5. If either is undefined -> return `{ error: "Radarr configuration incomplete (no quality profiles or root folders configured)" }`
  6. Call `context.radarr.addMovie({ title: movie.title, tmdbId: movie.tmdbId, qualityProfileId: qualityProfile.id, rootFolderPath: rootFolder.path, monitored: true, minimumAvailability: "announced", addOptions: { searchForMovie: true } })`
  7. Return `{ success: true, title: added.title, year: added.year, qualityProfile: qualityProfile.name, message: "Added ... and searching for downloads" }`

Create `src/conversation/tools/add-series.ts`:

Same pattern. The tool:
- Name: `"add_series"`
- Description: `"Add a TV show to the wanted/download list by its TVDB ID. Automatically applies sensible quality, path, and monitoring defaults. Searches for missing episodes immediately. Use when the user wants to add, download, get, or request a TV show or series."`
- Parameters: `z.object({ tvdbId: z.number().describe("The TVDB ID of the series to add (from search_series results)") })`
- Tier: `"safe"`
- Executor:
  1. Null-check `context.sonarr` -> return `{ error: "TV server (Sonarr) is not configured" }`
  2. Look up by TVDB ID: `context.sonarr.searchSeries(\`tvdb:${args.tvdbId}\`)` then `.find(s => s.tvdbId === args.tvdbId)`
  3. If not found -> return `{ error: "Could not find series with that TVDB ID" }`
  4. Check already in library: `if (series.id > 0)` -> return `{ alreadyInLibrary: true, title, year, message }`
  5. Get defaults from `context.sonarr.qualityProfiles[0]` and `context.sonarr.rootFolders[0]`
  6. If either undefined -> return error
  7. Call `context.sonarr.addSeries({ title: series.title, tvdbId: series.tvdbId, qualityProfileId: qualityProfile.id, rootFolderPath: rootFolder.path, titleSlug: series.titleSlug, images: series.images, seasons: series.seasons, monitored: true, seasonFolder: true, addOptions: { searchForMissingEpisodes: true, monitor: "all" } })`
  8. Return `{ success: true, title: added.title, year: added.year, seasonCount: added.seasons.length, qualityProfile: qualityProfile.name, message: "Added ... and searching for episodes" }`

IMPORTANT: The `addSeries` call MUST include `titleSlug`, `images`, and `seasons` from the lookup result. These are required by the Sonarr API and exist on the `SeriesLookupResult` type from the search.

IMPORTANT: Use `"all"` for monitor mode (not `"lastSeason"` which may be incorrect per research findings).
  </action>
  <verify>Run `npx tsc --noEmit` -- both new files must compile without errors. Run `npx biome check src/conversation/tools/add-movie.ts src/conversation/tools/add-series.ts` -- no lint errors.</verify>
  <done>add_movie and add_series tool definitions exist, compile cleanly, use sensible defaults from cached config, and follow the established defineTool pattern.</done>
</task>

<task type="auto">
  <name>Task 2: Create remove_movie and remove_series tools, extend search tools with libraryId, update barrel index</name>
  <files>
    src/conversation/tools/remove-movie.ts
    src/conversation/tools/remove-series.ts
    src/conversation/tools/search-movies.ts
    src/conversation/tools/search-series.ts
    src/conversation/tools/index.ts
  </files>
  <action>
Create `src/conversation/tools/remove-movie.ts`:

- Name: `"remove_movie"`
- Description: `"Remove a movie from the library. Uses the Radarr library ID (the libraryId from search results, NOT the tmdbId). This is a destructive action requiring user confirmation. Use when the user wants to remove, delete, or get rid of a movie from their library."`
- Parameters: `z.object({ id: z.number().describe("The Radarr library ID of the movie (the 'libraryId' from search results, NOT the tmdbId)"), deleteFiles: z.boolean().optional().describe("Also delete downloaded files (default: false)") })`
- Tier: `"destructive"` -- this triggers the confirmation interception in toolCallLoop
- Executor:
  1. Null-check `context.radarr`
  2. Call `context.radarr.removeMovie(args.id, { deleteFiles: args.deleteFiles ?? false, addImportExclusion: false })`
  3. Return `{ success: true, message: args.deleteFiles ? "Movie removed and files deleted" : "Movie removed from library (files kept on disk)" }`

Create `src/conversation/tools/remove-series.ts`:

Same pattern but for Sonarr:
- Name: `"remove_series"`
- Tier: `"destructive"`
- Executor calls `context.sonarr.removeSeries(args.id, { deleteFiles: args.deleteFiles ?? false, addImportListExclusion: false })`
- Note: Sonarr uses `addImportListExclusion` (not `addImportExclusion` like Radarr)

Modify `src/conversation/tools/search-movies.ts`:

The remove tools need the internal Radarr/Sonarr ID (not tmdbId/tvdbId). The search tools currently return `inLibrary: boolean` but not the library ID. Extend them:

1. Change `libraryTmdbIds` Set to a Map: `const libraryMovieMap = new Map(libraryMovies.map(m => [m.tmdbId, m]));`
2. In the results mapping, replace `inLibrary: libraryTmdbIds.has(movie.tmdbId)` with:
   ```
   const libraryMovie = libraryMovieMap.get(movie.tmdbId);
   return {
     ...existing fields...,
     inLibrary: !!libraryMovie,
     libraryId: libraryMovie?.id ?? null,
   };
   ```

Modify `src/conversation/tools/search-series.ts`:

Same modification:
1. Change `libraryTvdbIds` Set to a Map: `const librarySeriesMap = new Map(librarySeries.map(s => [s.tvdbId, s]));`
2. Add `libraryId: librarySeries?.id ?? null` to results (use the correct variable name from the Map lookup)

Update `src/conversation/tools/index.ts`:

Add re-exports for all four new tools:
```typescript
export { addMovieTool } from "./add-movie.js";
export { addSeriesTool } from "./add-series.js";
export { removeMovieTool } from "./remove-movie.js";
export { removeSeriesTool } from "./remove-series.js";
```
Keep all existing exports.
  </action>
  <verify>Run `npx tsc --noEmit` -- all files must compile. Run `npx biome check src/conversation/tools/` -- no lint errors. Verify barrel index exports 8 tools total (4 existing + 4 new) by checking the file contents.</verify>
  <done>remove_movie and remove_series tools exist with destructive tier. Search tools return libraryId for in-library items. Barrel index re-exports all 8 tools.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes (all new and modified files compile)
2. `npx biome check src/conversation/tools/` passes (no lint errors)
3. All 4 new tool files exist: add-movie.ts, add-series.ts, remove-movie.ts, remove-series.ts
4. Barrel index exports all 8 tools
5. Add tools use "safe" tier; remove tools use "destructive" tier
6. Add tools reference `qualityProfiles[0]` and `rootFolders[0]` for sensible defaults
7. Add series tool passes `titleSlug`, `images`, `seasons` from lookup result
8. Search tools return `libraryId` when `inLibrary` is true
</verification>

<success_criteria>
- add_movie takes tmdbId, looks up movie, applies cached quality/path defaults, POSTs to Radarr, returns success with title/year
- add_series takes tvdbId, looks up series via tvdb: prefix search, applies cached defaults including titleSlug/images/seasons, POSTs to Sonarr
- remove_movie and remove_series use "destructive" tier, take library ID and optional deleteFiles
- search_movies and search_series return libraryId for in-library items
- All files compile and pass lint
</success_criteria>

<output>
After completion, create `.planning/phases/07-library-management/07-01-SUMMARY.md`
</output>
