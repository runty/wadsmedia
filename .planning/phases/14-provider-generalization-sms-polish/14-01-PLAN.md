---
phase: 14-provider-generalization-sms-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/messaging/types.ts
  - src/messaging/twilio-provider.ts
  - src/config.ts
  - src/plugins/messaging.ts
autonomous: true

must_haves:
  truths:
    - "MessagingProvider interface has no TwiML-specific method names (no formatReply, no formatEmptyReply)"
    - "MessagingProvider.validateWebhook accepts generic headers+body, not Twilio-specific signature+body params"
    - "MessagingProvider.parseInbound accepts unknown, not Record<string, string>"
    - "MessagingProvider has a providerName readonly property"
    - "TwilioMessagingProvider encapsulates from address internally (callers never pass from)"
    - "OutboundMessage has no from field"
    - "MMS_PIXEL_URL is a configurable env var in AppConfig"
    - "Telegram config vars exist in AppConfig schema"
  artifacts:
    - path: "src/messaging/types.ts"
      provides: "Generalized MessagingProvider interface, OutboundMessage, InboundMessage, WebhookValidationParams"
      contains: "providerName"
    - path: "src/messaging/twilio-provider.ts"
      provides: "TwilioMessagingProvider implementing generalized interface"
      contains: "formatWebhookResponse"
    - path: "src/config.ts"
      provides: "AppConfig with MMS_PIXEL_URL and TELEGRAM_BOT_TOKEN"
      contains: "MMS_PIXEL_URL"
    - path: "src/plugins/messaging.ts"
      provides: "Messaging plugin passing fromNumber to TwilioMessagingProvider constructor"
      contains: "TWILIO_PHONE_NUMBER"
  key_links:
    - from: "src/messaging/twilio-provider.ts"
      to: "src/messaging/types.ts"
      via: "implements MessagingProvider"
      pattern: "implements MessagingProvider"
    - from: "src/plugins/messaging.ts"
      to: "src/messaging/twilio-provider.ts"
      via: "constructs provider with fromNumber"
      pattern: "new TwilioMessagingProvider"
---

<objective>
Generalize the MessagingProvider interface to be provider-agnostic and update the Twilio implementation to match.

Purpose: Remove Twilio/TwiML-specific assumptions from the shared messaging interface so Telegram (and future providers) can implement it cleanly. Encapsulate sender identity inside the provider so callers never need to know about `from` addresses.
Output: Provider-agnostic MessagingProvider interface, updated TwilioMessagingProvider, new config vars for MMS pixel URL and Telegram.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/messaging/types.ts
@src/messaging/twilio-provider.ts
@src/config.ts
@src/plugins/messaging.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generalize MessagingProvider interface and message types</name>
  <files>src/messaging/types.ts</files>
  <action>
Rewrite src/messaging/types.ts with these changes:

1. **InboundMessage**: Keep all existing fields but add `providerMessageId: string` (rename from messageSid -- Twilio-specific name). Keep `messageSid` as a deprecated alias OR just rename it to `providerMessageId`. Since this is internal and only used in webhook.ts logging, rename it directly. Keep `buttonPayload` and `buttonText` (RCS-compatible, will map to Telegram inline keyboard callbacks too).

2. **OutboundMessage**: Remove `from` field entirely. Remove `contentSid`, `contentVariables`, `messagingServiceSid` -- these are Twilio-specific. Create a new shape:
```typescript
export interface OutboundMessage {
  to: string;
  body?: string;
  mediaUrl?: string[];
  // Future Telegram fields (Phase 15 will use these)
  inlineKeyboard?: InlineButton[][];
  parseMode?: "Markdown" | "HTML";
  photo?: string;
}

export interface InlineButton {
  text: string;
  callbackData?: string;
  url?: string;
}
```

However, TwilioMessagingProvider still needs contentSid/contentVariables/messagingServiceSid internally. Handle this by having `TwilioMessagingProvider.send()` accept `OutboundMessage` but also accept Twilio-specific fields via a separate method or by extending. The cleanest approach: keep `OutboundMessage` generic (no Twilio fields), and create a `TwilioOutboundMessage` type that extends it with the Twilio-specific fields. The `TwilioMessagingProvider.send()` internally casts or accepts both.

Actually, simpler: keep the Twilio-specific fields in the Twilio provider file as a local type. The shared OutboundMessage stays clean. The content-templates.ts and message-formatter.ts that build rich card messages will need to construct Twilio-specific messages -- they can import the Twilio-specific type from twilio-provider.ts.

Final OutboundMessage (shared):
```typescript
export interface OutboundMessage {
  to: string;
  body?: string;
  mediaUrl?: string[];
}
```

3. **SendResult**: Rename `sid` to `providerMessageId`. Keep `status`.

4. **WebhookValidationParams**: New type:
```typescript
export interface WebhookValidationParams {
  headers: Record<string, string | string[] | undefined>;
  url: string;
  body: unknown;
}
```

5. **MessagingProvider**: Generalized interface:
```typescript
export interface MessagingProvider {
  readonly providerName: string;
  send(message: OutboundMessage): Promise<SendResult>;
  validateWebhook(params: WebhookValidationParams): boolean;
  parseInbound(body: unknown): InboundMessage;
  formatWebhookResponse(text?: string): string | null;
}
```

Key changes from current:
- `validateWebhook` takes `WebhookValidationParams` (generic headers/body) instead of `{ signature: string; url: string; body: Record<string, string> }`
- `parseInbound` takes `unknown` instead of `Record<string, string>`
- `formatReply(text)` + `formatEmptyReply()` merged into `formatWebhookResponse(text?)`. Returns the response body string, or null for providers that don't reply inline (Telegram sends via API, not webhook response). When text is undefined/empty, returns empty response (for Twilio: empty TwiML). When text is provided, returns response with message (for Twilio: TwiML with message).
- `providerName` added as readonly property

6. Do NOT add InlineButton/parseMode/photo yet -- those are Phase 15 concerns. Keep OutboundMessage minimal.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | head -50` -- expect type errors in files that consume the old interface (twilio-provider.ts, engine.ts, webhook.ts, etc). The types.ts file itself should have no errors.
  </verify>
  <done>
MessagingProvider interface has no TwiML-specific names. OutboundMessage has no `from` field. InboundMessage uses `providerMessageId`. WebhookValidationParams uses generic headers/body. formatWebhookResponse replaces formatReply+formatEmptyReply.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update TwilioMessagingProvider and config</name>
  <files>src/messaging/twilio-provider.ts, src/config.ts, src/plugins/messaging.ts</files>
  <action>
**src/messaging/twilio-provider.ts:**

1. Update constructor to accept and store `fromNumber: string` (the Twilio phone number). This encapsulates sender identity inside the provider.
```typescript
constructor(accountSid: string, authToken: string, fromNumber: string) {
  this.client = twilio(accountSid, authToken);
  this.authToken = authToken;
  this.fromNumber = fromNumber;
}
```

2. Add `readonly providerName = "twilio" as const;`

3. Update `send()`: Internally add `from: this.fromNumber` to every Twilio API call. The `message: OutboundMessage` param no longer has `from`. For rich card sending (contentSid), create a separate `sendRichCard()` method or handle via a Twilio-specific extended type. Since rich cards are currently disabled (RCS brand approval needed), simplify: keep just the plain text + MMS path. The content template path can be re-added when RCS is enabled. For now, send() handles:
   - Plain text: `{ body, to, from: this.fromNumber }`
   - MMS (with mediaUrl): `{ body, to, from: this.fromNumber, mediaUrl }`

   If `messagingServiceSid` support is needed, accept it in constructor too (optional). Check if TWILIO_MESSAGING_SERVICE_SID is used -- it's in config but let's keep it as constructor param for future use.

   Updated constructor: `constructor(accountSid: string, authToken: string, fromNumber: string, messagingServiceSid?: string)`

   In send(): use messagingServiceSid if provided, otherwise use fromNumber:
   ```typescript
   const fromOrService = this.messagingServiceSid
     ? { messagingServiceSid: this.messagingServiceSid }
     : { from: this.fromNumber };
   ```

4. Update `validateWebhook()` to accept `WebhookValidationParams`:
```typescript
validateWebhook(params: WebhookValidationParams): boolean {
  const signature = params.headers["x-twilio-signature"];
  if (typeof signature !== "string") return false;
  const body = params.body as Record<string, string>;
  return validateRequest(this.authToken, signature, params.url, body);
}
```

5. Update `parseInbound()` to accept `unknown`:
```typescript
parseInbound(body: unknown): InboundMessage {
  const b = body as Record<string, string>;
  return {
    providerMessageId: b.MessageSid ?? "",
    from: b.From ?? "",
    to: b.To ?? "",
    body: b.Body ?? "",
    numMedia: Number.parseInt(b.NumMedia ?? "0", 10),
    buttonPayload: b.ButtonPayload ?? null,
    buttonText: b.ButtonText ?? null,
  };
}
```

6. Replace `formatReply()` + `formatEmptyReply()` with `formatWebhookResponse()`:
```typescript
formatWebhookResponse(text?: string): string {
  const response = new MessagingResponse();
  if (text) {
    response.message(text);
  }
  return response.toString();
}
```
Note: Twilio always returns TwiML (never null), so return type is `string` which satisfies `string | null`.

**src/config.ts:**

Add these env vars to the schema:
```typescript
// MMS pixel URL (for forcing MMS mode on long messages)
MMS_PIXEL_URL: z.string().url().optional(),

// Telegram (optional, for Phase 15+)
TELEGRAM_BOT_TOKEN: z.string().min(1).optional(),
TELEGRAM_WEBHOOK_SECRET: z.string().min(1).optional(),
```

**src/plugins/messaging.ts:**

Pass `fromNumber` and `messagingServiceSid` to constructor:
```typescript
const provider = new TwilioMessagingProvider(
  TWILIO_ACCOUNT_SID,
  TWILIO_AUTH_TOKEN,
  fastify.config.TWILIO_PHONE_NUMBER ?? "",
  fastify.config.TWILIO_MESSAGING_SERVICE_SID,
);
```
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | head -80` -- the messaging layer files (types.ts, twilio-provider.ts, config.ts, messaging.ts plugin) should compile cleanly. Remaining errors should only be in consumer files (engine.ts, webhook.ts, etc.) that still use old interface.
  </verify>
  <done>
TwilioMessagingProvider encapsulates from address. Config has MMS_PIXEL_URL and TELEGRAM_BOT_TOKEN. Messaging plugin passes fromNumber to constructor. Provider implements generalized interface with providerName, formatWebhookResponse, generic validateWebhook and parseInbound.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` on messaging layer files compiles clean
- `grep -r "formatReply\|formatEmptyReply" src/messaging/` returns no matches
- `grep "from:" src/messaging/types.ts` returns no matches in OutboundMessage
- `grep "providerName" src/messaging/twilio-provider.ts` returns a match
- `grep "MMS_PIXEL_URL" src/config.ts` returns a match
</verification>

<success_criteria>
MessagingProvider interface is fully provider-agnostic. TwilioMessagingProvider encapsulates Twilio-specific concerns (from address, TwiML generation, signature extraction). Config includes MMS_PIXEL_URL and Telegram env vars. No TwiML-specific method names remain in the shared interface.
</success_criteria>

<output>
After completion, create `.planning/phases/14-provider-generalization-sms-polish/14-01-SUMMARY.md`
</output>
