---
phase: 14-provider-generalization-sms-polish
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - src/conversation/engine.ts
  - src/conversation/types.ts
  - src/plugins/webhook.ts
  - src/users/onboarding.ts
  - src/notifications/notify.ts
  - src/conversation/tools/add-movie.ts
  - src/conversation/tools/add-series.ts
  - src/plugins/notifications.ts
  - src/conversation/message-formatter.ts
autonomous: true

must_haves:
  truths:
    - "No file in src/ references userPhone (all renamed to replyAddress)"
    - "No file in src/ passes from: to messaging.send() (provider encapsulates it)"
    - "Dead splitForSms() function is deleted from engine.ts"
    - "MMS pixel URL uses config.MMS_PIXEL_URL env var instead of hardcoded wadsmedia.runty.net"
    - "webhook.ts uses formatWebhookResponse() instead of formatReply/formatEmptyReply"
    - "webhook.ts passes headers to validateWebhook instead of extracting signature"
  artifacts:
    - path: "src/conversation/engine.ts"
      provides: "Conversation engine using replyAddress and provider-agnostic messaging"
      contains: "replyAddress"
    - path: "src/conversation/types.ts"
      provides: "ToolContext with replyAddress instead of userPhone"
      contains: "replyAddress"
    - path: "src/plugins/webhook.ts"
      provides: "Webhook handler using generalized provider interface"
      contains: "formatWebhookResponse"
  key_links:
    - from: "src/plugins/webhook.ts"
      to: "src/messaging/types.ts"
      via: "uses MessagingProvider.formatWebhookResponse and validateWebhook"
      pattern: "formatWebhookResponse"
    - from: "src/conversation/engine.ts"
      to: "src/messaging/types.ts"
      via: "calls messaging.send() without from field"
      pattern: "messaging\\.send"
    - from: "src/conversation/engine.ts"
      to: "src/config.ts"
      via: "reads MMS_PIXEL_URL from config"
      pattern: "MMS_PIXEL_URL"
---

<objective>
Update all consumers of the MessagingProvider interface to use the generalized API from Plan 01.

Purpose: Complete the refactoring by updating every file that calls messaging.send(), uses formatReply/formatEmptyReply, passes userPhone, or references the hardcoded pixel URL. Also remove dead splitForSms() code (SMS-02).
Output: All source files compile and use the generalized messaging interface. SMS-01 and SMS-02 requirements fulfilled.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-provider-generalization-sms-polish/14-01-SUMMARY.md
@src/conversation/engine.ts
@src/conversation/types.ts
@src/plugins/webhook.ts
@src/users/onboarding.ts
@src/notifications/notify.ts
@src/conversation/tools/add-movie.ts
@src/conversation/tools/add-series.ts
@src/plugins/notifications.ts
@src/conversation/message-formatter.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor conversation engine and types</name>
  <files>src/conversation/engine.ts, src/conversation/types.ts</files>
  <action>
**src/conversation/types.ts:**

In the `ToolContext` interface, rename `userPhone: string` to `replyAddress: string`. This is a semantic rename -- the value is still a phone number for SMS users, but will be a Telegram chat ID for Telegram users in Phase 15.

**src/conversation/engine.ts:**

1. **Rename userPhone to replyAddress** in `ProcessConversationParams` interface and all usages throughout the file. Specifically:
   - Interface field: `userPhone: string` -> `replyAddress: string`
   - Destructuring: `userPhone,` -> `replyAddress,`
   - All `to: userPhone` -> `to: replyAddress`
   - Tool context construction (2 places: confirmation handler at ~line 115 and tool loop at ~line 195): `userPhone,` -> `replyAddress,`

2. **Remove `from:` from every `messaging.send()` call.** There are 5 send() calls in engine.ts (lines ~133, ~144, ~158, ~231, ~244). Remove `from: config.TWILIO_PHONE_NUMBER` from each. The OutboundMessage type no longer has `from` -- the provider handles it internally.

3. **Replace hardcoded pixel URL (SMS-01).** Line ~234:
   ```typescript
   // BEFORE:
   ...(useMms ? { mediaUrl: [`https://wadsmedia.runty.net/admin/assets/pixel.png`] } : {})
   // AFTER:
   ...(useMms && config.MMS_PIXEL_URL ? { mediaUrl: [config.MMS_PIXEL_URL] } : {})
   ```
   When MMS_PIXEL_URL is not set, long messages are sent as plain SMS (graceful degradation). This is intentional -- MMS forcing is opt-in.

4. **Delete the dead `splitForSms()` function (SMS-02).** Remove the entire function (lines ~282-319). It is not called anywhere -- the MMS approach replaced it. Verify with grep that no other file imports or calls it.

5. **Remove the unused `formatAsRichCard` import** at line ~23 if it's there (rich cards are disabled). Check first -- if it's still imported, remove it since the rich card code block is commented out.
  </action>
  <verify>
Run these commands:
- `grep -n "userPhone" src/conversation/engine.ts src/conversation/types.ts` -- should return NO matches
- `grep -n "from:" src/conversation/engine.ts` -- should return NO matches containing `from: config.TWILIO_PHONE`
- `grep -n "splitForSms" src/conversation/engine.ts` -- should return NO matches
- `grep -n "wadsmedia.runty.net" src/conversation/engine.ts` -- should return NO matches
- `grep -n "replyAddress" src/conversation/engine.ts` -- should return multiple matches
- `grep -n "MMS_PIXEL_URL" src/conversation/engine.ts` -- should return a match
  </verify>
  <done>
engine.ts uses replyAddress everywhere, never passes from: to messaging.send(), uses MMS_PIXEL_URL from config, and has no splitForSms() dead code. ToolContext in types.ts uses replyAddress.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update webhook handler and all remaining callers</name>
  <files>src/plugins/webhook.ts, src/users/onboarding.ts, src/notifications/notify.ts, src/conversation/tools/add-movie.ts, src/conversation/tools/add-series.ts, src/plugins/notifications.ts, src/conversation/message-formatter.ts</files>
  <action>
**src/plugins/webhook.ts:**

1. Update `validateTwilioSignature` preHandler to pass the full request headers to `validateWebhook` instead of extracting x-twilio-signature manually:
```typescript
const isValid = fastify.messaging.validateWebhook({
  headers: request.headers as Record<string, string | string[] | undefined>,
  url,
  body: request.body,
});
```
Remove the manual `const signature = request.headers["x-twilio-signature"]` extraction and its string type check -- the provider now handles that internally.

2. Update `parseInbound` call: `request.body as Record<string, string>` -> just `request.body` (parseInbound now accepts `unknown`).

3. Replace `formatEmptyReply()` -> `formatWebhookResponse()` (no args = empty response). There are 2 calls.

4. Replace `formatReply(onboardingReply)` -> `formatWebhookResponse(onboardingReply)`. There is 1 call.

5. Update `processConversation` call: `userPhone: user.phone` -> `replyAddress: user.phone`. (The value is still user.phone for Twilio webhook -- it's the reply address for this provider.)

6. Remove `from: fastify.config.TWILIO_PHONE_NUMBER` from both `messaging.send()` calls in the error handlers (~lines 79, 91).

7. Rename the preHandler function from `validateTwilioSignature` to something more generic like `validateWebhookSignature` since the provider-specific logic is now inside the provider.

**src/users/onboarding.ts:**

Remove `from: config.TWILIO_PHONE_NUMBER` from the `messaging.send()` call at line ~62. The provider handles `from` internally.

**src/notifications/notify.ts:**

1. Remove `from: config.TWILIO_PHONE_NUMBER` from the `messaging.send()` call at line ~34.
2. Remove the guard `if (!config.TWILIO_PHONE_NUMBER)` at line ~18. This check is no longer needed because sender identity is encapsulated in the provider. If the provider was constructed without a valid from number, that's caught at construction time (in the messaging plugin). For now, keep a simplified guard: the function should still check that messaging provider is available, but it doesn't need to check TWILIO_PHONE_NUMBER specifically. Actually, the messaging provider is always passed as a parameter, so it's always available. Remove the TWILIO_PHONE_NUMBER guard entirely. The function just sends.

**src/conversation/tools/add-movie.ts:**

Remove `from: context.config.TWILIO_PHONE_NUMBER` from the admin notification `messaging.send()` call at line ~135. The send() call becomes:
```typescript
context.messaging.send({
  to: context.config.ADMIN_PHONE,
  body: `${who} added movie: ${added.title} (${added.year ?? "N/A"}) [${routingReason}]`,
}).catch(() => {});
```

**src/conversation/tools/add-series.ts:**

Same change as add-movie.ts -- remove `from: context.config.TWILIO_PHONE_NUMBER` from the admin notification send() call at line ~135.

**src/plugins/notifications.ts:**

Remove the `TWILIO_PHONE_NUMBER` guard at lines ~10-12 that skips plugin registration. Replace with a check that messaging is available (it's a dependency, so it always is). Actually, the current guard prevents notification routes from registering if no phone number is configured. With provider generalization, this guard should check if ANY messaging provider is configured. For now, since Twilio is still the only provider, keep the guard but change it to check for messaging provider availability rather than a specific env var. Since messaging is a declared dependency and would throw during registration if not configured, the routes will only register if messaging is available. Remove the TWILIO_PHONE_NUMBER guard entirely -- the dependency declaration handles it.

**src/conversation/message-formatter.ts:**

The `RichCardContext` interface has `phoneNumber` and `accountSid`/`authToken` -- these are Twilio-specific. Since rich cards are currently disabled (the formatAsRichCard call in engine.ts is commented out), leave this file largely as-is but note it will need further refactoring when RCS is re-enabled. For now, no changes needed unless it causes compile errors from the OutboundMessage type change (the `from: richContext.phoneNumber` field). Check if it compiles. If OutboundMessage no longer has `from`, this file will error. Fix by keeping the Twilio-specific outbound construction internal to message-formatter.ts -- it can construct a plain object with `from` and cast it, since it's Twilio-specific code. Or simpler: since this code path is disabled, just update it minimally to compile. Remove `from` from the outboundMessage construction since OutboundMessage no longer has it. The rich card send path in engine.ts is commented out anyway.
  </action>
  <verify>
Run these commands:
- `npx tsc --noEmit` -- should compile with zero errors
- `grep -rn "userPhone" src/` -- should return NO matches
- `grep -rn "from: config\.TWILIO_PHONE\|from: fastify\.config\.TWILIO_PHONE\|from: context\.config.*TWILIO_PHONE" src/` -- should return NO matches
- `grep -rn "formatReply\|formatEmptyReply" src/` -- should return NO matches
- `grep -rn "wadsmedia\.runty\.net" src/` -- should return NO matches
- `grep -rn "splitForSms" src/` -- should return NO matches
- `npm run check` -- Biome linting passes
- `npm run build` -- TypeScript compilation succeeds
  </verify>
  <done>
All files compile cleanly. No file references userPhone, passes from: to messaging.send(), uses formatReply/formatEmptyReply, or contains the hardcoded pixel URL. SMS-01 (configurable pixel URL) and SMS-02 (dead splitForSms removal) are complete. The entire messaging layer is provider-agnostic.
  </done>
</task>

</tasks>

<verification>
Full project verification:
1. `npm run build` succeeds (TypeScript compiles)
2. `npm run check` passes (Biome linting)
3. `grep -rn "userPhone" src/` returns NO matches
4. `grep -rn "formatReply\b\|formatEmptyReply" src/` returns NO matches
5. `grep -rn "splitForSms" src/` returns NO matches
6. `grep -rn "wadsmedia\.runty\.net" src/` returns NO matches
7. `grep -rn "from: config\.TWILIO\|from: fastify\.config\.TWILIO\|from: context\.config.*TWILIO" src/` returns NO matches
</verification>

<success_criteria>
Every consumer of the MessagingProvider interface uses the generalized API. The conversation engine uses replyAddress. No Twilio-specific concerns leak outside the Twilio provider. SMS-01 (MMS_PIXEL_URL env var) and SMS-02 (splitForSms removal) are complete. The full project builds and lints cleanly.
</success_criteria>

<output>
After completion, create `.planning/phases/14-provider-generalization-sms-polish/14-02-SUMMARY.md`
</output>
