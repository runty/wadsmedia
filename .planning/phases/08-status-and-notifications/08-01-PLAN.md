---
phase: 08-status-and-notifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/conversation/tools/get-download-queue.ts
  - src/conversation/tools/index.ts
  - src/conversation/system-prompt.ts
  - src/plugins/conversation.ts
autonomous: true

must_haves:
  truths:
    - "User can text 'what's downloading?' and receive current queue status with progress percentages"
    - "Queue results show human-readable series/movie titles, not numeric IDs or release filenames"
    - "Empty queue returns a clear 'nothing downloading' message"
    - "System prompt guides LLM to use the queue tool for status queries"
  artifacts:
    - path: "src/conversation/tools/get-download-queue.ts"
      provides: "get_download_queue tool definition"
      exports: ["getDownloadQueueTool"]
    - path: "src/conversation/tools/index.ts"
      provides: "Barrel re-export including new queue tool"
      contains: "getDownloadQueueTool"
    - path: "src/conversation/system-prompt.ts"
      provides: "System prompt with download status guidance"
      contains: "download"
    - path: "src/plugins/conversation.ts"
      provides: "Queue tool registered in ToolRegistry"
      contains: "getDownloadQueueTool"
  key_links:
    - from: "src/conversation/tools/get-download-queue.ts"
      to: "SonarrClient.getQueue() and RadarrClient.getQueue()"
      via: "context.sonarr.getQueue() and context.radarr.getQueue()"
      pattern: "context\\.(sonarr|radarr)\\.getQueue"
    - from: "src/plugins/conversation.ts"
      to: "src/conversation/tools/get-download-queue.ts"
      via: "registry.register(getDownloadQueueTool)"
      pattern: "registry\\.register\\(getDownloadQueueTool\\)"
---

<objective>
Create the `get_download_queue` LLM tool that fetches active downloads from both Sonarr and Radarr, resolves human-readable titles, calculates progress percentages, and returns an LLM-friendly summary. Update the system prompt with download status guidance and register the tool in the conversation plugin.

Purpose: Satisfies STAT-01 (download progress and queue status). Also covers the system prompt update for STAT-02 which is already implemented by Phase 6 tools (get_upcoming_episodes, get_upcoming_movies) -- no new tool code needed for schedules, just a system prompt mention.
Output: Working download queue tool registered and ready for end-to-end use.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-status-and-notifications/08-RESEARCH.md

@src/conversation/tools.ts
@src/conversation/tools/search-movies.ts
@src/conversation/tools/index.ts
@src/conversation/system-prompt.ts
@src/plugins/conversation.ts
@src/media/sonarr/sonarr.client.ts
@src/media/radarr/radarr.client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create get_download_queue tool definition</name>
  <files>
    src/conversation/tools/get-download-queue.ts
    src/conversation/tools/index.ts
  </files>
  <action>
Create `src/conversation/tools/get-download-queue.ts` with a `getDownloadQueueTool` using the `defineTool()` pattern:

- **Name:** `get_download_queue`
- **Description:** "Check the current download queue for active and pending downloads. Shows what media is being downloaded, progress, and estimated time remaining. Use when the user asks about download status, queue, what's downloading, or progress."
- **Parameters:** `z.object({})` (no parameters needed)
- **Tier:** `"safe"`
- **Executor logic:**
  1. Null-check both `context.sonarr` and `context.radarr`. If neither is configured, return `{ error: "No media servers configured" }`.
  2. For Sonarr (if available):
     - Fetch queue and series list in parallel: `Promise.all([context.sonarr.getQueue({ pageSize: 20 }), context.sonarr.getSeries()])`
     - Build a `Map<number, string>` from `seriesId -> title` using the series list (same pattern as Phase 6 calendar enrichment in `get-upcoming.ts`)
     - Map each queue record to: `{ title: record.title, series: seriesMap.get(record.seriesId) ?? "Unknown Series", status: record.status, trackedDownloadState: record.trackedDownloadState, progress: calculated from (size - sizeleft) / size * 100, timeleft: record.timeleft, estimatedCompletionTime: record.estimatedCompletionTime }`
     - Wrap in try/catch; on error push `"Could not reach TV server (Sonarr)"` to errors array
  3. For Radarr (if available):
     - Fetch queue: `context.radarr.getQueue({ pageSize: 20 })`
     - Map each queue record to: `{ title: record.title, status: record.status, trackedDownloadState: record.trackedDownloadState, progress: calculated from (size - sizeleft) / size * 100, timeleft: record.timeleft, estimatedCompletionTime: record.estimatedCompletionTime }`
     - Wrap in try/catch; on error push `"Could not reach movie server (Radarr)"` to errors array
  4. Return object with: episodes array (if non-empty), movies array (if non-empty), errors (if any), or `{ message: "No active downloads" }` if both queues are empty and no errors.

Progress calculation: `record.size && record.sizeleft != null ? Math.round(((record.size - record.sizeleft) / record.size) * 100) : null`

**Important:** Use `record.sizeleft` (lowercase 'l') matching the QueueRecordSchema field name. Check the actual field name in `src/media/sonarr/sonarr.schemas.ts` and `src/media/radarr/radarr.schemas.ts`.

Add the export to the barrel index in `src/conversation/tools/index.ts`:
```typescript
export { getDownloadQueueTool } from "./get-download-queue.js";
```
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors.
Run `npx biome check src/conversation/tools/` -- no lint errors.
Confirm `src/conversation/tools/get-download-queue.ts` exists and exports `getDownloadQueueTool`.
Confirm `src/conversation/tools/index.ts` includes the new export.
  </verify>
  <done>
`get_download_queue` tool definition exists, compiles, follows established defineTool pattern with null-checks, parallel fetches, and progress calculation. Barrel index re-exports it.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update system prompt and register queue tool</name>
  <files>
    src/conversation/system-prompt.ts
    src/plugins/conversation.ts
  </files>
  <action>
**System prompt update** (`src/conversation/system-prompt.ts`):

Add a "Download status:" section to the SYSTEM_PROMPT after the "Conversational context:" section:

```
Download status:
- Use get_download_queue to check what is currently downloading when the user asks about downloads, queue, progress, or status.
- Show download progress as a percentage when available.
- Include estimated time remaining when the data is available.
- If the queue is empty, tell the user nothing is currently downloading.
- Keep queue status responses concise -- list active items with progress, skip completed ones.
```

The "Available capabilities:" list already mentions "Check download queue status" and "View upcoming episodes and releases" so no change needed there.

**Tool registration** (`src/plugins/conversation.ts`):

1. Add `getDownloadQueueTool` to the import from `"../conversation/tools/index.js"`.
2. Add `registry.register(getDownloadQueueTool);` after the existing `registry.register(removeSeriesTool);` line.

This brings the total to 9 tool registrations (10 total including check_status from createToolRegistry).
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors.
Run `npx biome check src/` -- no lint errors.
Confirm system prompt contains "Download status:" section.
Confirm conversation.ts imports and registers getDownloadQueueTool.
  </verify>
  <done>
System prompt includes download status guidance. Queue tool is registered in the ToolRegistry alongside all existing tools. End-to-end wiring complete: user text about downloads -> LLM selects get_download_queue -> tool fetches from Sonarr/Radarr -> LLM formats response.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npx biome check src/` passes with zero errors
3. `src/conversation/tools/get-download-queue.ts` exists with getDownloadQueueTool export
4. `src/conversation/tools/index.ts` re-exports getDownloadQueueTool
5. `src/conversation/system-prompt.ts` contains "Download status:" section
6. `src/plugins/conversation.ts` imports and registers getDownloadQueueTool
7. Total registered tools = 10 (check_status + 4 search/discovery + 4 library management + 1 queue)
</verification>

<success_criteria>
STAT-01 fully satisfied: get_download_queue tool fetches both Sonarr and Radarr queues, resolves series titles, calculates progress, and returns LLM-friendly data.
STAT-02 confirmed already satisfied: get_upcoming_episodes and get_upcoming_movies tools exist from Phase 6; system prompt already mentions schedule capabilities.
System prompt guides LLM on download status queries.
Tool registered and wired end-to-end.
</success_criteria>

<output>
After completion, create `.planning/phases/08-status-and-notifications/08-01-SUMMARY.md`
</output>
