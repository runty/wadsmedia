---
phase: 21-admin-experience
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema.ts
  - src/admin/admin.service.ts
  - src/admin/admin.routes.ts
  - admin-views/pages/users.eta
  - admin-views/partials/user-row.eta
  - admin-views/partials/pending-actions.eta
  - admin-assets/style.css
autonomous: true

must_haves:
  truths:
    - "Pending users appear in the users page with Approve and Block action buttons"
    - "Clicking Approve changes the user's status to active without page reload"
    - "Clicking Block changes the user's status to blocked without page reload"
    - "Every approve/block action from the dashboard is recorded in an audit log with timestamp, admin identity, and action"
  artifacts:
    - path: "src/db/schema.ts"
      provides: "admin_audit_log table definition"
      contains: "adminAuditLog"
    - path: "src/admin/admin.service.ts"
      provides: "Audit log insert and query functions"
      exports: ["insertAuditLog", "getRecentAuditLogs"]
    - path: "src/admin/admin.routes.ts"
      provides: "POST approve/block endpoints and GET audit log page"
      contains: "approve"
    - path: "admin-views/partials/pending-actions.eta"
      provides: "HTMX partial for approve/block buttons"
  key_links:
    - from: "admin-views/partials/user-row.eta"
      to: "/admin/api/users/:id/approve"
      via: "hx-post attribute"
      pattern: "hx-post.*approve"
    - from: "src/admin/admin.routes.ts"
      to: "src/admin/admin.service.ts"
      via: "insertAuditLog call inside approve/block handlers"
      pattern: "insertAuditLog"
    - from: "src/admin/admin.routes.ts"
      to: "src/admin/admin.service.ts"
      via: "updateUser call to change status"
      pattern: "updateUser"
---

<objective>
Add pending user approval/blocking from the web dashboard and an audit log that records every user management action.

Purpose: Admins can manage pending users directly from the web UI (complementing the LLM tools) and all actions are auditable with timestamps and admin identity.
Output: Approve/block buttons on user rows, audit log table in DB, audit log page in dashboard.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/db/schema.ts
@src/admin/admin.service.ts
@src/admin/admin.routes.ts
@src/admin/admin.auth.ts
@src/admin/admin.plugin.ts
@admin-views/layouts/main.eta
@admin-views/pages/users.eta
@admin-views/pages/dashboard.eta
@admin-views/partials/user-row.eta
@admin-assets/style.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit log schema, service functions, and approve/block API endpoints</name>
  <files>
    src/db/schema.ts
    src/admin/admin.service.ts
    src/admin/admin.routes.ts
  </files>
  <action>
1. **Add `adminAuditLog` table to `src/db/schema.ts`:**
   ```
   adminAuditLog = sqliteTable("admin_audit_log", {
     id: integer PK autoIncrement,
     adminIdentity: text NOT NULL (session identifier, e.g. "admin"),
     action: text NOT NULL (enum: "approve", "block", "remove"),
     targetUserId: integer NOT NULL references users.id,
     targetDisplayName: text (snapshot of user's displayName at time of action),
     details: text (optional JSON string for extra context),
     createdAt: integer timestamp NOT NULL $defaultFn(() => new Date()),
   })
   ```
   Follow the existing pattern in schema.ts (integer timestamps with mode: "timestamp", text enums, $defaultFn for defaults).

2. **Generate Drizzle migration:** Run `npx drizzle-kit generate` to create the migration SQL file. The existing migration setup auto-runs on startup.

3. **Add service functions to `src/admin/admin.service.ts`:**
   - `insertAuditLog(db, entry: { adminIdentity: string, action: string, targetUserId: number, targetDisplayName?: string | null, details?: string })` -- inserts a row into adminAuditLog and returns it.
   - `getRecentAuditLogs(db, limit = 50)` -- selects recent audit log entries ordered by createdAt DESC, joining with users table to get current displayName. Returns array of `{ id, adminIdentity, action, targetUserId, targetDisplayName, details, createdAt, currentDisplayName }`.
   - `getPendingUsers(db)` -- selects users WHERE status = "pending" ordered by createdAt ASC. Returns the same shape as getAllUsers but filtered. (This is a convenience function to avoid filtering in templates.)

4. **Add approve/block API endpoints to `src/admin/admin.routes.ts`:**
   - `POST /api/users/:id/approve` (authOpts): Looks up user by ID, validates user exists and is in "pending" status (return 400 if already active/blocked). Calls `updateUser(fastify.db, id, { status: "active" })`. Calls `insertAuditLog(fastify.db, { adminIdentity: "admin", action: "approve", targetUserId: id, targetDisplayName: existing.displayName })`. If request is hx-request, return the updated user-row partial. Otherwise return JSON.
   - `POST /api/users/:id/block` (authOpts): Same pattern but sets status to "blocked" and logs action "block".
   - Update the existing `POST /api/users/:id/delete` handler to ALSO call `insertAuditLog` with action "remove" so soft-deletes are audited too.
   - `GET /audit-log` (authOpts, full page): Calls `getRecentAuditLogs(fastify.db)` and renders `pages/audit-log` template.
   - `GET /api/audit-log` (authOpts, htmx partial): Returns `partials/audit-log-table` for potential htmx refresh.

   Import `insertAuditLog`, `getRecentAuditLogs`, `getPendingUsers` from admin.service.js. Add route type interfaces as needed (follow the existing `IdParams` pattern).

   For the admin identity, read it from `request.session.get("adminUserId")` which is always "admin" (set during login in admin.auth.ts). This satisfies the "admin identity" requirement since there's only one admin account.
  </action>
  <verify>
    Run `npx drizzle-kit generate` successfully (migration file created). Run `npm run build` to confirm TypeScript compiles. Run `npm test` to ensure existing tests pass. Manually verify the new endpoints exist by checking route registration (grep for "approve" and "audit-log" in admin.routes.ts).
  </verify>
  <done>
    adminAuditLog table defined in schema.ts. Migration SQL generated. insertAuditLog and getRecentAuditLogs service functions exist. POST /api/users/:id/approve and /block endpoints work. Existing /delete endpoint writes audit log. GET /audit-log page route exists.
  </done>
</task>

<task type="auto">
  <name>Task 2: Dashboard UI -- pending user buttons, audit log page, and nav update</name>
  <files>
    admin-views/partials/user-row.eta
    admin-views/partials/pending-actions.eta
    admin-views/pages/users.eta
    admin-views/pages/audit-log.eta
    admin-views/partials/audit-log-table.eta
    admin-views/layouts/main.eta
    admin-assets/style.css
  </files>
  <action>
1. **Update `admin-views/partials/user-row.eta`:**
   Add Approve and Block buttons for pending users. After the existing Edit/Delete/View Details actions, add a conditional block:
   ```
   <% if (it.user.status === "pending") { %>
     <button class="btn btn-success btn-sm"
             hx-post="/admin/api/users/<%= it.user.id %>/approve"
             hx-target="#user-<%= it.user.id %>"
             hx-swap="outerHTML"
             hx-confirm="Approve this user?">
       Approve
     </button>
     <button class="btn btn-danger btn-sm"
             hx-post="/admin/api/users/<%= it.user.id %>/block"
             hx-target="#user-<%= it.user.id %>"
             hx-swap="outerHTML"
             hx-confirm="Block this user?">
       Block
     </button>
   <% } %>
   ```
   The hx-target + hx-swap="outerHTML" pattern replaces the entire row with the updated user-row partial returned by the API, achieving no-reload updates. This matches the existing Edit and Delete button pattern.

2. **Update `admin-views/pages/users.eta`:**
   Add a "Pending Users" header column to the table that clearly shows Telegram username when phone is null. Update the Phone column header to "Contact" and display `user.phone || user.telegramUsername || "-"` for better visibility of Telegram-only users. Add a pending user count summary above the table if there are pending users (use a simple filter in the template: `it.users.filter(u => u.status === "pending").length`).

3. **Create `admin-views/pages/audit-log.eta`:**
   ```
   <% layout("/layouts/main", { title: "Audit Log", page: "audit-log" }) %>
   <div class="page-header">
     <h1>Audit Log</h1>
     <p>Recent user management actions</p>
   </div>
   <div id="audit-log-container"
        hx-get="/admin/api/audit-log"
        hx-trigger="every 30s"
        hx-swap="innerHTML">
     <%~ include("/partials/audit-log-table", { logs: it.logs }) %>
   </div>
   ```

4. **Create `admin-views/partials/audit-log-table.eta`:**
   Render a table with columns: Time, Admin, Action, User, Details.
   - Time: `new Date(log.createdAt).toLocaleString()`
   - Admin: `log.adminIdentity`
   - Action: Badge styled by action type (approve=green badge-active, block=red badge-blocked, remove=red badge-blocked)
   - User: `log.targetDisplayName || "User " + log.targetUserId`
   - Details: `log.details || "-"`

   If no logs, show empty state "No audit log entries yet."

5. **Update `admin-views/layouts/main.eta`:**
   Add "Audit Log" link to sidebar nav, after Users:
   ```html
   <li><a href="/admin/audit-log" <% if (it.page === "audit-log") { %>class="active"<% } %>>Audit Log</a></li>
   ```

6. **Add CSS for btn-success to `admin-assets/style.css`:**
   ```css
   .btn-success {
     background: #fff;
     color: #22c55e;
     border-color: #86efac;
   }
   .btn-success:hover {
     background: #f0fdf4;
     border-color: #22c55e;
   }
   ```
   This follows the same outlined-button pattern as `.btn-danger` but with green colors matching the existing badge-active palette.

   Also add a `.pending-count` style for the pending user summary:
   ```css
   .pending-count {
     display: inline-block;
     background: #fef3c7;
     color: #92400e;
     padding: 0.35rem 0.75rem;
     border-radius: 6px;
     font-size: 0.85rem;
     font-weight: 500;
     margin-bottom: 1rem;
   }
   ```
  </action>
  <verify>
    Run `npm run build` to confirm TypeScript and templates are valid. Visually inspect by starting the dev server (`npm run dev`) and navigating to /admin/users -- pending users should show Approve and Block buttons. Click Approve on a pending user -- row should update in-place without page reload. Navigate to /admin/audit-log -- the approval should appear in the log. Check sidebar has the new "Audit Log" link.
  </verify>
  <done>
    Pending users show Approve and Block buttons that update the row via HTMX without page reload. Audit log page at /admin/audit-log displays all user management actions with timestamp, admin identity, action type, and target user. Sidebar navigation includes Audit Log link. Success/danger button styles are consistent with existing dashboard design.
  </done>
</task>

</tasks>

<verification>
1. Navigate to /admin/users -- pending users should have green "Approve" and red "Block" buttons alongside existing Edit/Delete/View Details actions
2. Click "Approve" on a pending user -- the row updates in-place (status badge changes from "pending" to "active", approve/block buttons disappear) without page reload
3. Click "Block" on a pending user -- the row updates in-place (status badge changes to "blocked") without page reload
4. Navigate to /admin/audit-log -- shows table with recent actions including the approve/block actions just performed, with correct timestamps and "admin" identity
5. Click "Delete" on any user -- navigate to audit log and confirm the removal action appears
6. Audit log auto-refreshes every 30 seconds (visible via HTMX polling indicator)
7. Sidebar shows three nav items: Dashboard, Users, Audit Log
</verification>

<success_criteria>
- Pending users have Approve and Block buttons that work without page reload (ADMIN-01)
- Every user management action (approve, block, remove) is recorded in admin_audit_log with timestamp, admin identity, action, and target user (ADMIN-02)
- Audit log is viewable at /admin/audit-log with recent entries (ADMIN-02)
- All three success criteria from ROADMAP Phase 21 are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/21-admin-experience/21-01-SUMMARY.md`
</output>
